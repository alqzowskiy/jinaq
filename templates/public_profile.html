{% extends "base.html" %}
{% block content %}
<!-- Full Page Container -->
<div class="min-h-screen bg-gray-50">
    <!-- Header Section -->
    <div class="relative w-full">
        <!-- Banner Image -->
        <div class="relative h-[300px] bg-gray-100 overflow-hidden">
            {% if user_data.header_image %}
            <img src="{{ user_data.header_image.url }}" class="w-full h-full object-cover"
                style="object-position: {{ user_data.header_image.position or '50% 50%' }}" alt="">
            {% else %}
            <div class="w-full h-full bg-gradient-to-br from-indigo-500 to-purple-600"></div>
            {% endif %}
            <!-- Overlay -->
            <div class="absolute inset-0 bg-black/20"></div>
        </div>

        <!-- Profile Info Section -->
        <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="relative -mt-[76px]">
                <!-- Main Profile Card -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex flex-col sm:flex-row gap-6">
                        <!-- Avatar Section -->
                        <div class="flex-shrink-0 -mt-16 sm:-mt-20">
                            <div class="relative mx-auto sm:mx-0">
                                <div
                                    class="w-[120px] h-[120px] sm:w-[150px] sm:h-[150px] rounded-full ring-4 ring-white shadow-md overflow-hidden">
                                    <img src="{{ avatar_url }}" class="w-full h-full object-cover"
                                        alt="{{ user_data.full_name if user_data else 'Profile' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Profile Info -->
                        <div class="flex-grow text-center sm:text-left">
                            <div class="sm:flex sm:items-center sm:justify-between">
                                <div>
                                    <div class="flex items-center justify-center sm:justify-start gap-3">
                                        <h1 class="text-2xl font-bold text-gray-900">
                                            {{ user_data.full_name if user_data else 'User' }}
                                        </h1>
                                        {% if user_data.verified %}
                                        <div class="tooltip" data-tip="Verified account">
                                            <svg class="h-6 w-6 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="mt-1 text-gray-500">@{{ user_data.username }}</div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="mt-4 sm:mt-0 flex justify-center sm:justify-end gap-3">
                                    {% if user_data.specialty %}
                                    <div
                                        class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-50 text-purple-700">
                                        {{ user_data.specialty }}
                                    </div>
                                    {% endif %}
                                    <button onclick="copyProfileLink()"
                                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors">
                                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                                            <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h8a2 2 0 00-2-2H5z" />
                                        </svg>
                                        Share
                                    </button>
                                </div>
                            </div>

                            <!-- Quick Stats -->
                            <div class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-4">
                                <!-- Certificates -->
                                {% if certificates_count > 0 %}
                                <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
                                    <div class="p-2 rounded-lg bg-purple-100/50">
                                        <svg class="h-5 w-5 text-purple-500" viewBox="0 0 20 20" fill="currentColor">
                                            <path
                                                d="M5.5 2A1.5 1.5 0 004 3.5V4h12v-.5A1.5 1.5 0 0014.5 2h-9zM2 7.5A1.5 1.5 0 013.5 6h13A1.5 1.5 0 0118 7.5V8H2v-.5zm15 3.5H3v6.5A1.5 1.5 0 004.5 19h11a1.5 1.5 0 001.5-1.5V11z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-lg font-semibold">{{ certificates_count }}</div>
                                        <div class="text-sm text-gray-500">Certificates</div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Member Since -->
                                <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
                                    <div class="p-2 rounded-lg bg-blue-100/50">
                                        <svg class="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Member since</div>
                                        <div class="text-sm font-medium">{{ user_data.created_at.strftime('%b %Y') }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Age -->
                                {% if user_data.age %}
                                <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
                                    <div class="p-2 rounded-lg bg-green-100/50">
                                        <svg class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-lg font-semibold">{{ user_data.age }}</div>
                                        <div class="text-sm text-gray-500">Years old</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation
                <div class="mb-6 border-b border-gray-200">
                    <div class="flex space-x-8 -mb-px overflow-x-auto scrollbar-hide">
                        <button
                            class="py-4 px-1 border-b-2 border-purple-500 font-medium text-purple-600 whitespace-nowrap">
                            Overview
                        </button>
                        <button
                            class="py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                            Academic
                        </button>
                        <button
                            class="py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                            Certificates
                        </button>
                        <button
                            class="py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                            Comments
                        </button>
                    </div>
                </div> -->


                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Sidebar -->
                    <div class="space-y-6">
                        <!-- About Section -->
                        {% if user_data.bio or user_data.goals %}
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-lg font-semibold text-gray-900">About</h2>
                            </div>

                            {% if user_data.bio %}
                            <div class="space-y-4">
                                <p class="text-gray-600 text-sm leading-relaxed">{{ user_data.bio }}</p>
                            </div>
                            {% endif %}

                            {% if user_data.goals %}
                            <div class="mt-6">
                                <h3 class="text-sm font-medium text-gray-900 mb-3">Goals</h3>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-600">{{ user_data.goals }}</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Links Section -->
                        {% if user_data.links %}
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-6">Links</h2>
                            <div class="space-y-3">
                                {% for link in user_data.links %}
                                <a href="{{ link.url }}" target="_blank"
                                    class="flex items-center p-3 rounded-lg hover:bg-gray-50 transition group">
                                    <div class="flex-shrink-0">
                                        {% if 'github.com' in link.url %}
                                        <div
                                            class="w-8 h-8 flex items-center justify-center rounded-lg bg-gray-900 text-white">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                                            </svg>
                                        </div>
                                        {% elif 'linkedin.com' in link.url %}
                                        <div
                                            class="w-8 h-8 flex items-center justify-center rounded-lg bg-blue-600 text-white">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
                                            </svg>
                                        </div>
                                        {% else %}
                                        <div
                                            class="w-8 h-8 flex items-center justify-center rounded-lg bg-gray-100 text-gray-500 group-hover:bg-gray-200">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                            </svg>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="ml-3 flex-grow">
                                        <div class="text-sm font-medium text-gray-900">{{ link.title }}</div>
                                        <div class="text-xs text-gray-500 truncate">{{ link.url }}</div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Main Content Area -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Academic Profile -->
                        {% if user_data.academic_info %}
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-6">Academic Profile</h2>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Academic Metrics -->
                                <div class="space-y-4">
                                    <h3 class="text-sm font-medium text-gray-700">Academic Metrics</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        {% for metric, value in [
                                        ('GPA', user_data.academic_info.gpa),
                                        ('SAT', user_data.academic_info.sat_score),
                                        ('TOEFL', user_data.academic_info.toefl_score),
                                        ('IELTS', user_data.academic_info.ielts_score)
                                        ] %}
                                        <div class="bg-gray-50 p-3 rounded-lg">
                                            <div class="text-xs text-gray-500">{{ metric }}</div>
                                            <div class="mt-1 text-sm font-medium text-gray-900">{{ value or 'Not
                                                provided' }}</div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Languages -->
                                <div class="space-y-4">
                                    <h3 class="text-sm font-medium text-gray-700">Languages</h3>
                                    <div class="space-y-2">
                                        {% for lang in user_data.academic_info.languages %}
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-900">{{ lang.name }}</span>
                                            <span
                                                class="px-2 py-1 text-xs font-medium bg-white rounded-md text-gray-600">
                                                {{ lang.level }}
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Achievements -->
                            {% if user_data.academic_info.achievements %}
                            <div class="mt-8">
                                <h3 class="text-sm font-medium text-gray-700 mb-4">Achievements</h3>
                                <div class="space-y-4">
                                    {% for achievement in user_data.academic_info.achievements %}
                                    <div class="relative bg-gray-50 p-4 rounded-lg group">
                                        <h4 class="text-sm font-medium text-gray-900">{{ achievement.title }}</h4>
                                        <p class="mt-1 text-sm text-gray-600">{{ achievement.description }}</p>
                                        <div class="mt-2 text-xs text-gray-500">{{ achievement.date }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Certificates Section -->
                        {% if certificates %}
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-6">Certificates</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {% for cert_doc in certificates %}
                                {% set cert = cert_doc.to_dict() %}
                                <div class="group relative bg-gray-50 rounded-lg overflow-hidden">
                                    {% if cert.file_url and (cert.file_url.endswith('.jpg') or
                                    cert.file_url.endswith('.jpeg') or cert.file_url.endswith('.png')) %}
                                    <div class="aspect-[4/3] overflow-hidden">
                                        <img src="{{ cert.file_url }}" alt="{{ cert.title }}"
                                            class="w-full h-full object-cover transform transition group-hover:scale-105">
                                    </div>
                                    {% else %}
                                    <div class="aspect-[4/3] bg-gray-100 flex items-center justify-center">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </div>
                                    {% endif %}

                                    <div class="p-4">
                                        <h3 class="text-sm font-medium text-gray-900">{{ cert.title }}</h3>
                                        {% if cert.uploaded_at %}
                                        <div class="mt-1 text-xs text-gray-500">
                                            {{ cert.uploaded_at.strftime('%B %d, %Y') }}
                                        </div>
                                        {% endif %}
                                        <a href="{{ cert.file_url }}" target="_blank"
                                            class="mt-3 inline-flex items-center text-xs font-medium text-purple-600">
                                            View Certificate
                                            <svg class="ml-1 w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Comments Section -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-lg font-semibold text-gray-900">Comments</h2>
                                <span id="commentCount" class="text-sm text-gray-500">(0)</span>
                            </div>

                            {% if session.get('user_id') and session['user_id'] != user_data.uid %}
                            <div class="mb-6">
                                <form id="commentForm">
                                    <div class="relative">
                                        <textarea id="commentText" class="w-full min-h-[120px] p-4 border border-gray-200 rounded-xl bg-gray-50 
                                         focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-y"
                                            placeholder="Share your thoughts..." maxlength="500"></textarea>

                                        <div class="absolute bottom-4 right-4 flex items-center gap-4">
                                            <span id="charCount" class="text-sm text-gray-500">0 / 500</span>
                                            <button type="submit" class="inline-flex items-center px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 
                                           transition-colors">
                                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"
                                                    stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                                </svg>
                                                Send
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            {% endif %}

                            <!-- Comments List -->
                            <div id="commentsList" class="space-y-4">
                                <!-- Comments will be loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(-20px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes gradientFlow {
        0% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }

        100% {
            background-position: 0% 50%;
        }
    }

    /* Utility Classes */
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }

    .animate-slide-in {
        animation: slideIn 0.3s ease-out forwards;
    }

    .gradient-animate {
        background-size: 200% 200%;
        animation: gradientFlow 6s ease infinite;
    }

    /* Scrollbar Customization */
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    /* Custom shadows */
    .hover-shadow-soft {
        transition: all 0.2s ease;
    }

    .hover-shadow-soft:hover {
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        transform: translateY(-2px);
    }

    /* Comment styles */
    .comment-card {
        transition: all 0.2s ease;
    }

    .comment-card:hover {
        background-color: #f8fafc;
    }

    /* Responsive adjustments */
    @media (max-width: 640px) {
        .profile-header {
            padding-top: 1rem;
        }

        .profile-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .certificate-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Smooth transitions */
    .transition-all {
        transition-property: all;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
    }

    /* Custom button styles */
    .btn-primary {
        @apply bg-purple-600 text-white hover:bg-purple-700 focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-200;
    }

    .btn-secondary {
        @apply bg-gray-100 text-gray-700 hover:bg-gray-200 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200;
    }
</style>


<script>
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function () {

        const defaultAvatar = '{{ avatar_url }}';
        const username = '{{ user_data.username }}';
        const commentsList = document.getElementById('commentsList');
        const commentForm = document.getElementById('commentForm');
        const commentText = document.getElementById('commentText');
        const charCount = document.getElementById('charCount');
        const commentCount = document.getElementById('commentCount');
        const lazyImages = document.querySelectorAll('img[loading="lazy"]');

        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                });
            });

            lazyImages.forEach(img => imageObserver.observe(img));
        }

        // Character count
        commentText?.addEventListener('input', function () {
            const currentLength = this.value.length;
            charCount.textContent = `${currentLength} / 500`;
            charCount.classList.toggle('text-red-500', currentLength > 450);
        });

        function formatDate(dateString) {
            // Проверяем, является ли dateString объектом с _seconds
            if (dateString && dateString._seconds) {
                const date = new Date(dateString._seconds * 1000);
                const now = new Date();
                const diffMinutes = Math.floor((now - date) / (1000 * 60));

                if (diffMinutes < 1) return 'Just now';
                if (diffMinutes < 60) return `${diffMinutes} min ago`;
                if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)} hours ago`;

                // Форматируем дату
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            // Если dateString это timestamp в секундах
            if (typeof dateString === 'number') {
                const date = new Date(dateString * 1000);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }


            if (dateString) {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            }


            return 'Date not available';
        }

        function formatComment(comment, isReply = false, nestingLevel = 0) {
            const currentUserId = '{{ session.get("user_id", "") }}';
            const profileUserId = '{{ user_data.uid }}';
            const authorUsername = comment.author_username;
            const replyToText = comment.reply_to_username ? `Replying to @${comment.reply_to_username}` : '';

            const marginLeft = Math.min(nestingLevel * 2, 8);

            const commentHTML = `
    <div class="comment flex bg-gray-50 p-4 rounded-xl space-x-4 group mb-4 ${isReply ? `ml-${marginLeft}` : ''}" 
         data-comment-id="${comment.id}" 
         data-parent-id="${comment.parent_id || ''}"
         data-reply-to="${comment.reply_to || ''}">
        <div class="flex-shrink-0">
            <a href="/${authorUsername.toLowerCase()}" class="block w-8 h-8 rounded-full overflow-hidden hover:ring-2 hover:ring-black transition-all"> 
                <img src="${comment.author_avatar}" alt="${comment.author_username}" class="w-full h-full object-cover">
            </a>
        </div>
        <div class="flex-grow">
            <div class="flex items-center gap-2 mb-1">
                <a href="/${authorUsername}" class="font-semibold text-sm hover:underline">@${comment.author_username}</a>
                <span class="text-xs text-gray-500">${formatDate(comment.created_at)}</span>
            </div>
            ${replyToText ? `<div class="text-xs text-gray-500 mb-1">${replyToText}</div>` : ''}
            <p class="text-gray-700 text-sm mb-2">${comment.text}</p>
            
            <div class="flex items-center gap-4 text-xs text-gray-500">
                <button onclick="toggleLike('${comment.id}')" 
                        class="flex items-center gap-1 ${comment.is_liked ? 'text-red-500' : ''} hover:text-red-500 transition-colors">
                    <svg class="h-4 w-4" fill="${comment.is_liked ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                    <span class="likes-count">${comment.likes_count || 0}</span>
                </button>
                
                <button onclick="toggleReply('${comment.id}')" class="hover:text-gray-700 transition-colors">
                    Reply
                </button>
                
                ${(comment.author_id === currentUserId || profileUserId === currentUserId) ? `
                    <button onclick="deleteComment('${comment.id}')" class="hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                        Delete
                    </button>
                ` : ''}
            </div>

            <div class="reply-form hidden mt-3" id="reply-form-${comment.id}">
                <textarea class="textarea textarea-bordered w-full text-sm min-h-[60px] resize-none bg-white"
                        placeholder="Write a reply..."></textarea>
                <div class="flex justify-end mt-2">
                    <button onclick="submitReply('${comment.id}', '${comment.id}')"
                            class="btn btn-xs bg-black hover:bg-gray-800 text-white">
                        Reply
                    </button>
                </div>
            </div>

            ${comment.replies && comment.replies.length > 0 ? `
            <div class="replies-container hidden mt-3" id="replies-${comment.id}">
                ${comment.replies.map(reply => formatComment(reply, true, nestingLevel + 1)).join('')}
            </div>
            <button onclick="toggleRepliesView('${comment.id}')" 
                    class="text-xs text-gray-500 hover:text-black mt-2 flex items-center gap-1 see-replies-btn">
                <span class="replies-count">${comment.replies.length}</span>
                ${comment.replies.length === 1 ? 'reply' : 'replies'}
            </button>
            ` : ''}
        </div>
    </div>`;

            return commentHTML;
        }

        window.submitReply = async function (commentId, originalCommentId) {
            const replyForm = document.querySelector(`#reply-form-${commentId}`);
            const replyText = replyForm.querySelector('textarea').value.trim();
            const replyButton = replyForm.querySelector('button');

            if (!replyText) return;

            try {
                replyButton.disabled = true;
                replyButton.textContent = 'Sending...';

                const formData = new FormData();
                formData.append('reply', replyText);
                formData.append('original_comment_id', originalCommentId);

                const response = await fetch(`/${username}/comments/${commentId}/reply`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    replyForm.querySelector('textarea').value = '';
                    replyForm.classList.add('hidden');

                    const parentComment = document.querySelector(`[data-comment-id="${commentId}"]`);
                    let repliesContainer = parentComment.querySelector('.replies-container');
                    let repliesButton = parentComment.querySelector('.see-replies-btn');

                    if (!repliesContainer) {
                        repliesContainer = document.createElement('div');
                        repliesContainer.classList.add('replies-container', 'hidden', 'mt-3');
                        repliesContainer.id = `replies-${commentId}`;
                        parentComment.querySelector('.flex-grow').appendChild(repliesContainer);
                    }

                    if (!repliesButton) {
                        repliesButton = document.createElement('button');
                        repliesButton.classList.add('text-xs', 'text-gray-500', 'hover:text-black', 'mt-2', 'flex', 'items-center', 'gap-1', 'see-replies-btn');
                        repliesButton.setAttribute('onclick', `toggleRepliesView('${commentId}')`);
                        parentComment.querySelector('.flex-grow').appendChild(repliesButton);
                    }

                    const replyHTML = formatComment(data.reply, true, 1);
                    repliesContainer.insertAdjacentHTML('beforeend', replyHTML);

                    repliesButton.innerHTML = `
                <span class="replies-count">${repliesContainer.children.length}</span>
                ${repliesContainer.children.length === 1 ? 'reply' : 'replies'}
            `;

                    showNotification('Reply added successfully');
                } else {
                    throw new Error(data.error || 'Failed to add reply');
                }
            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                replyButton.disabled = false;
                replyButton.textContent = 'Reply';
            }
        };

        window.toggleRepliesView = function (commentId) {
            const repliesContainer = document.querySelector(`#replies-${commentId}`);
            const repliesButton = document.querySelector(`[data-comment-id="${commentId}"] .see-replies-btn`);

            repliesContainer.classList.toggle('hidden');

            if (repliesContainer.classList.contains('hidden')) {
                repliesButton.innerHTML = `
            <span class="replies-count">${repliesContainer.children.length}</span>
            ${repliesContainer.children.length === 1 ? 'reply' : 'replies'}
        `;
            } else {
                repliesButton.textContent = 'Hide replies';
            }
        };








        // Load comments
        function loadComments() {
            fetch(`/${username}/comments`)
                .then(response => response.json())
                .then(comments => {
                    commentCount.textContent = `(${comments.length})`;
                    commentsList.innerHTML = comments.map(comment => formatComment(comment)).join('') || `
                    <div class="text-center text-gray-500 py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        No comments yet. Be the first to comment!
                    </div>
                `;
                });
        }

        // Submit comment form
        if (commentForm) {
            commentForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const commentTextValue = commentText.value.trim();

                if (commentTextValue.length > 500) {
                    showNotification('Comment is too long', 'error');
                    return;
                }

                try {
                    const response = await fetch(`/${username}/comments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({ 'comment': commentTextValue })
                    });

                    const data = await response.json();
                    if (data.status === 'success') {
                        commentText.value = '';
                        charCount.textContent = '0 / 500';
                        showNotification('Comment added successfully');
                        loadComments();
                    }
                } catch (error) {
                    showNotification('Failed to send comment', 'error');
                }
            });
        }

        // Global functions
        window.toggleReply = function (commentId) {
            const replyForm = document.querySelector(`#reply-form-${commentId}`);
            replyForm.classList.toggle('hidden');
        };


        window.toggleLike = async function (commentId) {
            try {
                const response = await fetch(`/${username}/comments/${commentId}/like`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.status === 'success') {
                    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
                    const likesCount = commentElement.querySelector('.likes-count');
                    const likeIcon = likesCount.previousElementSibling;

                    likesCount.textContent = data.likes_count;

                    if (data.is_liked) {
                        likeIcon.classList.add('text-red-500');
                        likeIcon.setAttribute('fill', 'currentColor');
                    } else {
                        likeIcon.classList.remove('text-red-500');
                        likeIcon.setAttribute('fill', 'none');
                    }
                }
            } catch (error) {
                showNotification('Failed to update like', 'error');
            }
        };

        window.deleteComment = async function (commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) return;

            try {
                const response = await fetch(`/${username}/comments/${commentId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.status === 'success') {
                    showNotification('Comment deleted successfully');
                    loadComments();
                }
            } catch (error) {
                showNotification('Failed to delete comment', 'error');
            }
        };

        // Utility function for notifications
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-xl shadow-lg transform transition-all duration-300 
        ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }


        // Initial load
        loadComments();
    });

    // Profile link copying function
    function copyProfileLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-black text-white px-6 py-3 rounded-xl shadow-lg transform transition-all duration-300';
            notification.textContent = 'Profile link copied to clipboard!';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        });
    }
    function generateDefaultAvatar(username) {
        const initials = username.split(' ')
            .map(word => word[0])
            .join('')
            .toUpperCase()
            .slice(0, 2);
        return `https://ui-avatars.com/api/?name=${initials}&background=random&color=fff&size=128`;
    }
</script>
{% endblock %}