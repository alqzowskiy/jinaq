{% extends "base.html" %}
<!-- В начале template -->
{% block head %}
<script>
    window.userAcademicInfo = {{
        (academic_info | tojson) if academic_info else '{}' | safe
    }};
    window.userCertificates = {{
        (certificates | map(attribute = 'to_dict()') | list | tojson) if certificates else '[]' | safe
    }};
</script>
<meta name="current-username" content="{{ current_username }}">
<style>
    /* Enhanced profile display styles */
    .profile-info-card {
        background-color: white;
        border-radius: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        padding: 1.75rem;
        transition: all 0.2s ease;
    }

    .profile-info-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .profile-section {
        margin-bottom: 1.5rem;
    }

    .profile-section:last-child {
        margin-bottom: 0;
    }

    .profile-label {
        font-size: 0.925rem;
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }

    .profile-label svg {
        margin-right: 0.5rem;
        color: #6b7280;
    }

    .profile-value {
        font-size: 1.05rem;
        color: #111827;
        line-height: 1.5;
    }

    .profile-skill-badge {
        display: inline-flex;
        padding: 0.375rem 0.75rem;
        background-color: #f3f0ff;
        color: #7c3aed;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }

    .profile-skill-badge:hover {
        background-color: #ede9fe;
        transform: translateY(-1px);
    }

    .location-display {
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    /* Edit profile button responsive fixes */
    @media (max-width: 768px) {
        .edit-profile-container {
            position: relative;
            margin-bottom: 1rem;
            width: 100%;
        }

        #editProfileBtn {
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .profile-main-grid {
            display: flex;
            flex-direction: column;
        }

        /* Move edit button between profile card and info card on mobile */
        .mobile-edit-button-container {
            order: 2;
        }

        .profile-info-container {
            order: 3;
        }

        .certificates-container {
            order: 4;
        }
    }

    /* Styles for the floating save button */
    .floating-save-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 100;
        display: none;
    }

    .save-btn-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Styles for the header editor */
    .header-container {
        position: relative;
        width: 100%;
        height: 300px;
        overflow: hidden;
        border-radius: 1rem;
        margin-bottom: 2rem;
    }

    /* Toast notification styles */
    .toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #000;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
    }

    .toast-notification.show {
        opacity: 1;
        transform: translateY(0);
    }

    .toast-notification.success {
        background-color: #10b981;
    }

    .toast-notification.error {
        background-color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header Container - Hidden by default -->
        <div id="headerContainer" class="relative w-full mb-8 hidden">
            <div
                class="relative w-full h-[300px] overflow-hidden rounded-3xl bg-gradient-to-r from-gray-100 to-gray-200 shadow-lg">
                {% if user_data.header_image %}
                <div class="absolute inset-0 bg-black/10"></div>
                <img src="{{ user_data.header_image.url }}"
                    class="w-full h-full object-cover transition-all duration-300"
                    style="object-position: {{ user_data.header_image.position or '50% 50%' }}" alt="Profile header"
                    id="headerImage">
                {% else %}
                <div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200"></div>
                {% endif %}

                {% if session.get('user_id') == user_data.uid %}
                <div
                    class="absolute inset-0 opacity-0 hover:opacity-100 transition-all duration-300 profile-editable-section">
                    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <label class="cursor-pointer group">
                            <div
                                class="bg-white/90 px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 
                                      group-hover:bg-white transition-colors transform group-hover:scale-105 duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span class="font-medium text-gray-900">Change Header</span>
                            </div>
                            <input type="file" id="headerInput" class="hidden" accept="image/*"
                                onchange="handleHeaderUpload(this)">
                        </label>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto">
            <!-- Profile Action Buttons -->
            <div class="edit-profile-container flex md:justify-end mb-6">
                <button id="editProfileBtn"
                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                    Edit Profile
                </button>
            </div>

            <div id="profileContent" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="md:col-span-1 space-y-6">
                    <!-- Profile Card - Always Visible -->
                    <div
                        class="bg-white rounded-2xl shadow-sm p-8 relative transform hover:scale-[1.01] transition-transform duration-300">
                        <div class="relative group w-40 h-40 mx-auto mb-6">
                            <img id="avatarPreview" src="{{ avatar_url }}"
                                class="w-full h-full object-cover rounded-2xl shadow-md" alt="Profile picture">
                            <label
                                class="absolute inset-0 rounded-2xl bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity profile-editable-section">
                                <span class="text-white text-sm font-medium">Change Photo</span>
                                <input type="file" name="avatar" accept="image/*" class="hidden"
                                    onchange="previewImage(this)">
                            </label>
                        </div>

                        <!-- Profile Info -->
                        <div class="text-center md:text-left space-y-4">
                            <div class="flex items-center justify-center md:justify-start gap-4">
                                <h1 class="text-3xl font-bold gradient-text">
                                    {{ user_data.full_name if user_data and user_data.full_name else 'Your Name' }}
                                </h1>
                                {% if user_data.verified %}
                                <div class="tooltip"
                                    data-tip="{{ 'Officially verified account' if user_data.verification_type == 'official' else 'Verified account' }}">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-6 w-6 text-blue-500 transition-all duration-300 transform hover:scale-110 hover:rotate-6"
                                        viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                                {% endif %}
                            </div>

                            <p class="text-gray-600 flex items-center justify-center md:justify-start gap-2">
                                @{{ user_data.username if user_data else '' }}
                                <button onclick="copyProfileLink()"
                                    class="btn btn-ghost btn-sm p-1 hover:bg-gray-100 rounded-lg"
                                    title="Copy Profile Link">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-5 w-5 text-gray-500 hover:text-black transition-colors" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                            </p>

                            <div class="flex flex-wrap justify-center md:justify-start gap-2 mt-4">
                                <span
                                    class="px-4 py-2 bg-gray-100 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors">
                                    {{ certificates|length }} Certificates
                                </span>
                                <span
                                    class="px-4 py-2 bg-gray-100 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors">
                                    Member since {{ user_data.created_at.strftime('%B %Y') if user_data and
                                    user_data.created_at else 'Recently' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Display - Visible when not editing (additional info) -->
                    <div id="profileDisplayInfo"
                        class="bg-white rounded-2xl shadow-sm p-8 space-y-6 profile-display-section">
                        <h2 class="text-2xl font-bold mb-6">Profile Information</h2>

                        <div class="space-y-4">
                            {% if user_data.specialty %}
                            <div>
                                <h3 class="font-medium text-gray-700">Specialty</h3>
                                <p class="text-gray-900">{{ user_data.specialty }}</p>
                            </div>
                            {% endif %}

                            {% if user_data.age %}
                            <div>
                                <h3 class="font-medium text-gray-700">Age</h3>
                                <p class="text-gray-900">{{ user_data.age }} years</p>
                            </div>
                            {% endif %}

                            {% if user_data.goals %}
                            <div>
                                <h3 class="font-medium text-gray-700">Goals</h3>
                                <p class="text-gray-900">{{ user_data.goals }}</p>
                            </div>
                            {% endif %}

                            {% if user_data.bio %}
                            <div>
                                <h3 class="font-medium text-gray-700">Bio</h3>
                                <p class="text-gray-900">{{ user_data.bio }}</p>
                            </div>
                            {% endif %}

                            {% if user_data.skills and user_data.skills|length > 0 %}
                            <div>
                                <h3 class="font-medium text-gray-700">Skills</h3>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    {% for skill in user_data.skills %}
                                    <span
                                        class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full">
                                        {{ skill }}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            {% if user_data.location %}
                            <div>
                                <h3 class="font-medium text-gray-700">Location</h3>
                                <p class="flex items-center gap-2 text-gray-900">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    {{ user_data.location.city }}, {{ user_data.location.country }}
                                </p>
                            </div>
                            {% endif %}

                            {% if user_data.education %}
                            <div>
                                <h3 class="font-medium text-gray-700">Education</h3>
                                <p class="text-gray-900">{{ user_data.education }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Unified Profile Form - Hidden by default -->
                    <div id="unifiedProfileForm"
                        class="bg-white rounded-2xl shadow-sm p-8 space-y-6 profile-editable-section">
                        <h2 class="text-2xl font-bold mb-6">Profile Information</h2>
                        <form method="POST" enctype="multipart/form-data" id="profileForm" class="space-y-6">
                            <!-- Form Fields -->
                            <div class="space-y-4">
                                <div class="form-control">
                                    <label class="label font-bold text-gray-700">Full Name</label>
                                    <input type="text" name="full_name"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.full_name if user_data else '' }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-bold text-gray-700">Age</label>
                                    <input type="number" name="age" min="13" max="120"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.age if user_data else '' }}" placeholder="Enter your age">
                                </div>

                                <div class="form-control">
                                    <label class="label font-bold text-gray-700">Specialty</label>
                                    <input type="text" name="specialty"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.specialty if user_data else '' }}"
                                        placeholder="e.g., Computer Science, Medicine, Art">
                                </div>

                                <div class="form-control">
                                    <label class="label font-bold text-gray-700">Goals</label>
                                    <textarea name="goals"
                                        class="textarea textarea-bordered bg-gray-50 w-full min-h-[100px] focus:ring-2 focus:ring-black transition-all"
                                        placeholder="What are your academic or professional goals?">{{ user_data.goals if user_data else '' }}</textarea>
                                </div>

                                <div class="form-control">
                                    <label class="label font-bold text-gray-700">Bio</label>
                                    <textarea name="bio"
                                        class="textarea textarea-bordered bg-gray-50 w-full min-h-[100px] focus:ring-2 focus:ring-black transition-all">{{ user_data.bio if user_data else '' }}</textarea>
                                </div>

                                <!-- Skills Section -->
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h3 class="label font-bold text-gray-700">Skills</h3>
                                        <button onclick="showSkillsEditor()" type="button"
                                            class="text-sm text-purple-600 hover:text-purple-800 font-medium">
                                            Edit Skills
                                        </button>
                                    </div>
                                    <div class="flex flex-wrap gap-2" id="skillsContainer">
                                        {% for skill in user_data.skills %}
                                        <span
                                            class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full hover:bg-purple-100 transition-colors">
                                            {{ skill }}
                                        </span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Location Section -->
                                <div class="space-y-4">
                                    <h3 class="text-lg font-bold text-gray-700">Location</h3>
                                    {% if user_data.location %}
                                    <div class="flex items-center gap-2 text-gray-600 bg-gray-50 p-3 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span data-location class="font-medium">
                                            {{ user_data.location.city }}, {{ user_data.location.country }}
                                        </span>
                                    </div>
                                    {% else %}
                                    <div class="text-gray-500 text-sm bg-gray-50 p-3 rounded-lg">
                                        Location not available
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label font-bold text-gray-700">Education</label>
                                    <textarea name="education"
                                        class="textarea textarea-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all">{{ user_data.education if user_data else '' }}</textarea>
                                </div>

                                <h2 class="text-2xl font-bold mt-8 mb-4">Links & Contacts</h2>
                                <div id="linksContainer" class="space-y-4">
                                    {% if user_data.links %}
                                    {% for link in user_data.links %}
                                    <div
                                        class="link-entry group p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200">
                                        <div class="flex items-start gap-4">
                                            <div class="link-icon flex-shrink-0 mt-2">
                                                {% if 'linkedin.com' in link.url %}
                                                <svg class="h-8 w-8 text-blue-600" fill="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path
                                                        d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.5867-2.777 7 2.476v6.759z" />
                                                </svg>
                                                {% elif 'github.com' in link.url %}
                                                <svg class="h-8 w-8 text-gray-900" fill="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path
                                                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                                                </svg>
                                                {% elif 'youtube.com' in link.url or 'youtu.be' in link.url %}
                                                <svg class="h-8 w-8 text-red-600" fill="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path
                                                        d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" />
                                                </svg>
                                                {% else %}
                                                <svg class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24"
                                                    stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                                </svg>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow space-y-3">
                                                <input type="text" name="link_titles[]" placeholder="Link Title"
                                                    class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all"
                                                    value="{{ link.title }}">
                                                <input type="text" name="link_urls[]" placeholder="URL"
                                                    class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all"
                                                    value="{{ link.url }}">
                                            </div>
                                            <div class="flex-shrink-0 flex items-start space-x-2">
                                                <a href="{{ link.url }}" target="_blank"
                                                    class="btn btn-ghost btn-sm p-2 hover:bg-purple-50 text-purple-600 transition-colors rounded-lg">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                        viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                                    </svg>
                                                </a>
                                                <button type="button" onclick="removeLink(this)"
                                                    class="btn btn-ghost btn-sm p-2 hover:bg-red-50 text-red-500 transition-colors rounded-lg">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                        viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                                <button type="button" onclick="addLink()"
                                    class="btn btn-ghost text-purple-600 hover:bg-purple-50 transition-colors px-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Link
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="md:col-span-2 space-y-8">
                    <!-- Certificates Section - Always visible -->
                    <div class="bg-white rounded-2xl shadow-sm p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Certificates</h2>
                            <button onclick="showUploadModal()"
                                class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200 profile-editable-section">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Add Certificate
                            </button>
                        </div>

                        {% if certificates %}
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            {% for cert_doc in certificates %}
                            {% set cert = cert_doc.to_dict() %}
                            <div
                                class="group relative bg-gray-50 rounded-xl overflow-hidden hover:shadow-md transition-all duration-300">
                                {% if cert.file_url and (cert.file_url.endswith('.jpg') or
                                cert.file_url.endswith('.jpeg') or cert.file_url.endswith('.png')) %}
                                <div class="relative h-48">
                                    <img src="{{ cert.file_url }}" alt="{{ cert.title }}"
                                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                    </div>
                                </div>
                                {% else %}
                                <div
                                    class="h-48 flex items-center justify-center bg-gray-100 group-hover:bg-gray-200 transition-colors duration-300">
                                    <svg class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                {% endif %}

                                <div class="p-6 space-y-4">
                                    <h3
                                        class="text-lg font-semibold text-gray-900 group-hover:text-black transition-colors">
                                        {{ cert.title }}
                                    </h3>
                                    {% if cert.uploaded_at %}
                                    <p class="text-sm text-gray-500">
                                        {{ cert.uploaded_at.strftime('%B %d, %Y') }}
                                    </p>
                                    {% endif %}
                                    <div class="flex justify-between items-center">
                                        <a href="{{ cert.file_url }}" target="_blank"
                                            class="btn btn-sm bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                            View Certificate
                                        </a>
                                        <button onclick="deleteCertificate('{{ cert_doc.id }}')"
                                            class="btn btn-sm btn-ghost text-red-500 hover:bg-red-50 transition-colors profile-editable-section">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12 bg-gray-50 rounded-xl">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="mt-4 text-lg font-medium text-gray-900">No certificates yet</h3>
                            <p class="mt-2 text-sm text-gray-500">Add your first certificate to showcase your
                                achievements</p>

                        </div>
                        {% endif %}
                    </div>
                    <!-- Add this after the Certificates Section in profile.html -->
                    <!-- Inside the div with class "lg:col-span-2 space-y-6" after the certificates div -->

                    <!-- Projects Section -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Projects</h2>
                            <button onclick="showCreateProjectModal()"
                                class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200 profile-editable-section">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Add Project
                            </button>
                        </div>

                        {% if projects %}
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            {% for project in projects %}
                            <div
                                class="group relative bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-all duration-300">
                                {% if project.images and project.images|length > 0 %}
                                <div class="relative h-48">
                                    <img src="{{ project.images[0] }}" alt="{{ project.title }}"
                                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                    </div>

                                    <!-- Add role badge -->
                                    {% if project.role == 'collaborator' %}
                                    <div
                                        class="absolute top-2 right-2 px-2 py-1 bg-purple-500 text-white text-xs font-medium rounded-full">
                                        Collaborator
                                    </div>
                                    {% endif %}
                                </div>
                                {% else %}
                                <div
                                    class="h-48 flex items-center justify-center bg-gray-100 group-hover:bg-gray-200 transition-colors duration-300 relative">
                                    <svg class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                                    </svg>

                                    <!-- Add role badge for collaborator -->
                                    {% if project.role == 'collaborator' %}
                                    <div
                                        class="absolute top-2 right-2 px-2 py-1 bg-purple-500 text-white text-xs font-medium rounded-full">
                                        Collaborator
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3
                                            class="text-lg font-semibold text-gray-900 group-hover:text-black transition-colors">
                                            {{ project.title }}
                                        </h3>
                                        {% if project.github_url %}
                                        <a href="{{ project.github_url }}" target="_blank"
                                            class="text-gray-500 hover:text-gray-800">
                                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                                            </svg>
                                        </a>
                                        {% endif %}
                                    </div>
                                    <p class="text-sm text-gray-600 line-clamp-2 mb-3">{{ project.description }}</p>

                                    {% if project.tags and project.tags|length > 0 %}
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        {% for tag in project.tags %}
                                        <span
                                            class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">{{
                                            tag }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    <!-- Show collaborators -->
                                    {% if project.collaborators and project.collaborators|length > 0 %}
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-xs text-gray-500">With:</span>
                                        <div class="flex -space-x-2">
                                            {% for collaborator in project.collaborators %}
                                            <div class="tooltip" data-tip="{{ collaborator.username }}">
                                                <img src="{{ collaborator.avatar }}" alt="{{ collaborator.username }}"
                                                    class="h-6 w-6 rounded-full ring-2 ring-white">
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <div class="flex justify-between items-center mt-4">
                                        <a href="{{ url_for('view_project', project_id=project.id) }}"
                                            class="text-sm font-medium text-purple-600 hover:text-purple-800 transition-colors">
                                            View Project
                                        </a>
                                        <div class="flex items-center space-x-2">
                                            <!-- Only show edit/delete if user is creator -->
                                            {% if project.role != 'collaborator' %}
                                            <button onclick="editProject('{{ project.id }}')"
                                                class="text-gray-500 hover:text-gray-700 profile-editable-section">
                                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                                    stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>
                                            </button>
                                            <button onclick="deleteProject('{{ project.id }}')"
                                                class="text-gray-500 hover:text-red-500 profile-editable-section">
                                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                                    stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12 bg-gray-50 rounded-xl">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                            </svg>
                            <h3 class="mt-4 text-lg font-medium text-gray-900">No projects yet</h3>
                            <p class="mt-2 text-sm text-gray-500">Showcase your work by adding your first project</p>

                        </div>
                        {% endif %}
                    </div>
                    <!-- Academic Portfolio -->
                    <div class="bg-white rounded-2xl shadow-sm p-8 profile-editable-section">
                        <h2 class="text-2xl font-bold mb-8">Academic Portfolio</h2>
                        <form id="academicPortfolioForm" class="space-y-8">
                            <!-- Academic Scores -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">GPA</label>
                                    <input type="text" name="gpa" placeholder="Enter your GPA"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.gpa }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">SAT Score</label>
                                    <input type="text" name="sat_score" placeholder="Enter SAT Score"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.sat_score }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">TOEFL Score</label>
                                    <input type="text" name="toefl_score" placeholder="TOEFL Score"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.toefl_score }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">IELTS Score</label>
                                    <input type="text" name="ielts_score" placeholder="IELTS Score"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.ielts_score }}">
                                </div>
                            </div>

                            <!-- Languages Section -->
                            <div class="space-y-6">
                                <h3 class="text-xl font-semibold">Languages</h3>
                                <div id="languagesContainer" class="space-y-4">
                                    {% for language in user_data.academic_info.languages %}
                                    <div
                                        class="flex gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200">
                                        <input type="text" name="language_name" placeholder="Language"
                                            class="input input-bordered flex-1 bg-white focus:ring-2 focus:ring-black transition-all"
                                            value="{{ language.name }}">
                                        <select name="language_level"
                                            class="select select-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                                            <option value="A1" {% if language.level=='A1' %}selected{% endif %}>A1 -
                                                Beginner</option>
                                            <option value="A2" {% if language.level=='A2' %}selected{% endif %}>A2 -
                                                Elementary</option>
                                            <option value="B1" {% if language.level=='B1' %}selected{% endif %}>B1 -
                                                Intermediate</option>
                                            <option value="B2" {% if language.level=='B2' %}selected{% endif %}>B2 -
                                                Upper Intermediate</option>
                                            <option value="C1" {% if language.level=='C1' %}selected{% endif %}>C1 -
                                                Advanced</option>
                                            <option value="C2" {% if language.level=='C2' %}selected{% endif %}>C2 -
                                                Mastery</option>
                                        </select>
                                        <button type="button" onclick="removeLanguage(this)"
                                            class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" id="addLanguageBtn" onclick="addLanguage()"
                                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Language
                                </button>
                            </div>

                            <!-- Achievements Section -->
                            <div class="space-y-6">
                                <h3 class="text-xl font-semibold">Achievements</h3>
                                <div id="achievementsContainer" class="space-y-4">
                                    {% for achievement in user_data.academic_info.achievements %}
                                    <div
                                        class="p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200">
                                        <div class="space-y-4">
                                            <input type="text" name="achievement_title" placeholder="Achievement Title"
                                                class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all"
                                                value="{{ achievement.title }}">
                                            <textarea name="achievement_description" placeholder="Description"
                                                class="textarea textarea-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all min-h-[100px]">{{ achievement.description }}</textarea>
                                            <div class="flex items-center justify-between">
                                                <input type="date" name="achievement_date"
                                                    class="input input-bordered bg-white focus:ring-2 focus:ring-black transition-all"
                                                    value="{{ achievement.date }}">
                                                <button type="button" onclick="removeAchievement(this)"
                                                    class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                        viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" id="addAchievementBtn" onclick="addAchievement()"
                                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Achievement
                                </button>
                            </div>

                            <!-- Floating Save Button - Unified -->
                            <button id="floatingSaveBtn"
                                class="btn bg-black hover:bg-gray-800 text-white w-full transform hover:scale-[1.02] transition-all duration-200">
                                <div class="save-btn-content">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7" />
                                    </svg>
                                    <span>Save All Changes</span>
                                </div>
                            </button>

                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


<!-- Modals -->
<!-- Upload Certificate Modal -->
<!-- Add this section to your profile.html right before the </body> tag -->
<!-- This will help you debug collaborator issues -->

<div id="debugOutput"
    class="fixed bottom-0 right-0 bg-black bg-opacity-80 text-white p-4 max-w-lg max-h-64 overflow-auto hidden">
    <div class="flex justify-between items-center mb-2">
        <h3 class="text-sm font-bold">Debug Information</h3>
        <button onclick="document.getElementById('debugOutput').classList.add('hidden')" class="text-white">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
    <pre id="debugContent" class="text-xs whitespace-pre-wrap"></pre>
</div>

<script>
    // Add this to your JavaScript code
    function debugLog(message, data) {
        const debug = document.getElementById('debugOutput');
        const content = document.getElementById('debugContent');

        if (!debug || !content) return;

        let output = message + "\n";
        if (data !== undefined) {
            if (typeof data === 'object') {
                output += JSON.stringify(data, null, 2);
            } else {
                output += data;
            }
        }

        content.textContent = output;
        debug.classList.remove('hidden');

        console.log(message, data);
    }

    // Add debug logging to key functions
    const originalAddCollaborator = addCollaborator;
    addCollaborator = function (user) {
        debugLog("Adding collaborator:", user);
        originalAddCollaborator(user);
    }

    // Make a debug button for the collaborator section
    function addDebugButton() {
        const container = document.getElementById('collaboratorsContainer');
        if (!container) return;

        const debugButton = document.createElement('button');
        debugButton.className = "text-xs text-gray-400 hover:text-gray-600 mt-2";
        debugButton.textContent = "Debug Collaborators";
        debugButton.onclick = function () {
            debugLog("Current collaborators:", projectCollaborators);
        }

        container.appendChild(debugButton);
    }

    // Run after page load
    document.addEventListener('DOMContentLoaded', function () {
        // Add debug button when project modal is opened
        const editProjectBtn = document.querySelector('button[onclick="showCreateProjectModal()"]');
        if (editProjectBtn) {
            const originalShowModal = showCreateProjectModal;
            showCreateProjectModal = function () {
                originalShowModal();
                setTimeout(addDebugButton, 100);
            }
        }
    });
</script>
<div id="uploadModal" class="modal">
    <div class="modal-box max-w-2xl p-8 relative">
        <h3 class="text-2xl font-bold mb-6">Upload Certificate</h3>
        <form id="certificateForm" class="space-y-6">
            <div class="form-control">
                <label class="label font-medium text-gray-700">Certificate Title</label>
                <input type="text" id="certTitle" name="title"
                    class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                    required>
            </div>

            <div class="form-control">
                <label class="label font-medium text-gray-700">Certificate File</label>
                <div class="relative">
                    <input type="file" name="certificate" accept=".pdf,.jpg,.jpeg,.png"
                        class="file-input file-input-bordered w-full bg-gray-50 focus:ring-2 focus:ring-black transition-all"
                        onchange="previewCertificate(this)" required>
                </div>
            </div>

            <div id="previewContainer" class="hidden mt-4">
                <img id="imagePreview" class="max-h-48 mx-auto rounded-lg" alt="Preview">
            </div>

            <div class="flex justify-end gap-4 mt-8">
                <button type="button" onclick="closeUploadModal()"
                    class="btn btn-ghost hover:bg-gray-100 transition-colors">Cancel</button>
                <button type="submit"
                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                    Upload Certificate
                </button>
            </div>
        </form>
    </div>

</div>
<!-- Add this at the end of the body in profile.html (before closing body tag) -->

<!-- Project Create/Edit Modal -->
<!-- Add this inside the project modal in profile.html -->
<div id="projectModal" class="modal">
    <div class="modal-box max-w-4xl p-8 relative">
        <h3 id="projectModalTitle" class="text-2xl font-bold mb-6">Create New Project</h3>
        <form id="projectForm" class="space-y-6">
            <input type="hidden" id="projectId" name="project_id" value="">

            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-control md:col-span-2">
                    <label class="label font-bold text-gray-700">Project Title*</label>
                    <input type="text" id="projectTitle" name="title" required
                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all">
                </div>

                <div class="form-control md:col-span-2">
                    <label class="label font-bold text-gray-700">Description*</label>
                    <textarea id="projectDescription" name="description" required
                        class="textarea textarea-bordered bg-gray-50 w-full min-h-[120px] focus:ring-2 focus:ring-black transition-all"
                        placeholder="Describe your project..."></textarea>
                </div>

                <div class="form-control">
                    <label class="label font-bold text-gray-700">GitHub URL</label>
                    <input type="url" id="projectGithub" name="github_url"
                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                        placeholder="https://github.com/yourusername/repository">
                </div>

                <div class="form-control">
                    <label class="label font-bold text-gray-700">Project URL</label>
                    <input type="url" id="projectUrl" name="project_url"
                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                        placeholder="https://yourproject.com">
                </div>
            </div>

            <!-- Project Header and Thumbnail -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-control">
                    <label class="label font-bold text-gray-700">Project Thumbnail</label>
                    <div class="flex items-center space-x-4">
                        <div id="thumbnailPreviewContainer"
                            class="relative w-24 h-24 bg-gray-200 rounded-lg overflow-hidden border-2 border-gray-300">
                            <img id="thumbnailPreview" src="/static/placeholder.png" alt="Thumbnail"
                                class="w-full h-full object-cover">
                            <div
                                class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 flex items-center justify-center transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="h-8 w-8 text-white opacity-0 group-hover:opacity-100" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="thumbnailInput" name="thumbnail" accept="image/*"
                                class="file-input file-input-bordered w-full max-w-xs"
                                onchange="previewThumbnail(this)">
                            <p class="text-xs text-gray-500 mt-2">Recommended size: 200x200px. Max size: 2MB</p>
                        </div>
                    </div>
                </div>

                <div class="form-control">
                    <label class="label font-bold text-gray-700">Project Header</label>
                    <div class="flex items-center space-x-4">
                        <div id="headerPreviewContainer"
                            class="relative w-full h-32 bg-gray-200 rounded-lg overflow-hidden border-2 border-gray-300">
                            <img id="headerPreview" src="/static/placeholder-wide.png" alt="Header"
                                class="w-full h-full object-cover">
                            <div
                                class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 flex items-center justify-center transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="h-8 w-8 text-white opacity-0 group-hover:opacity-100" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="headerInput" name="header_image" accept="image/*"
                                class="file-input file-input-bordered w-full max-w-xs" onchange="previewHeader(this)">
                            <p class="text-xs text-gray-500 mt-2">Recommended size: 1200x400px. Max size: 5MB</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Tags -->
            <div class="form-control">
                <label class="label font-bold text-gray-700">Tags</label>
                <div class="flex flex-wrap gap-2" id="tagsContainer">
                    <!-- Tags will be added here -->
                </div>
                <div class="flex mt-2">
                    <input type="text" id="tagInput" placeholder="Add a tag..."
                        class="input input-bordered bg-gray-50 flex-grow focus:ring-2 focus:ring-black transition-all">
                    <button type="button" onclick="addTag()"
                        class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                        Add
                    </button>
                </div>
            </div>

            <!-- Project Images -->
            <div class="form-control">
                <label class="label font-bold text-gray-700">Project Images</label>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-2" id="imagesContainer">
                    <!-- Image previews will be added here -->
                </div>
                <div class="relative mt-2">
                    <input type="file" id="projectImages" multiple accept="image/*"
                        class="file-input file-input-bordered w-full bg-gray-50 focus:ring-2 focus:ring-black transition-all"
                        onchange="previewProjectImages(this)">
                </div>
            </div>

            <!-- Collaborators Section -->
            <div class="form-control">
                <label class="label font-bold text-gray-700">Collaborators</label>
                <div class="space-y-4" id="collaboratorsContainer">
                    <!-- Collaborators will be added here -->
                </div>
                <div class="flex mt-2">
                    <input type="text" id="collaboratorInput" placeholder="Search username..."
                        class="input input-bordered bg-gray-50 flex-grow focus:ring-2 focus:ring-black transition-all">
                    <button type="button" onclick="searchUsers()"
                        class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                        Search
                    </button>
                </div>
                <!-- Search results will appear here -->
                <div id="userSearchResults"
                    class="mt-2 bg-white border border-gray-200 rounded-lg max-h-40 overflow-y-auto hidden">
                    <!-- User search results will appear here -->
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-8">
                <button type="button" onclick="closeProjectModal()"
                    class="btn btn-ghost hover:bg-gray-100 transition-colors">
                    Cancel
                </button>
                <button type="submit"
                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                    Save Project
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Project Confirmation Modal -->
<div id="deleteProjectModal" class="modal">
    <div class="modal-box p-6">
        <h3 class="font-bold text-lg mb-4">Confirm Deletion</h3>
        <p>Are you sure you want to delete this project? This action cannot be undone.</p>
        <input type="hidden" id="projectToDelete" value="">
        <div class="modal-action mt-6">
            <button class="btn btn-ghost" onclick="closeDeleteProjectModal()">Cancel</button>
            <button id="confirmDeleteProjectBtn" class="btn bg-red-500 hover:bg-red-600 text-white">Delete</button>
        </div>
    </div>
</div>
<!-- Skills Editor Modal -->
<div id="skillsModal" class="modal">
    <div class="modal-box max-w-2xl p-8">
        <h3 class="text-2xl font-bold mb-6">Edit Skills</h3>
        <div class="space-y-6">
            <div id="skillsList" class="space-y-4">
                <!-- Skills will be added here -->
            </div>
            <button type="button" onclick="addNewSkill(event)"
                class="btn btn-ghost text-purple-600 hover:bg-purple-50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Skill
            </button>
        </div>
        <div class="flex justify-end gap-4 mt-8">
            <button type="button" onclick="closeSkillsModal(event)"
                class="btn btn-ghost hover:bg-gray-100 transition-colors">Cancel</button>
            <button type="button" onclick="saveSkills(event)"
                class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Delete Certificate Confirmation Modal -->
<div id="deleteCertificateModal" class="modal">
    <div class="modal-box p-6">
        <h3 class="font-bold text-lg mb-4">Confirm Deletion</h3>
        <p>Are you sure you want to delete this certificate? This action cannot be undone.</p>
        <input type="hidden" id="certificateToDelete" value="">
        <div class="modal-action mt-6">
            <button class="btn btn-ghost" onclick="closeDeleteCertificateModal()">Cancel</button>
            <button id="confirmDeleteBtn" class="btn bg-red-500 hover:bg-red-600 text-white">Delete</button>
        </div>
    </div>
</div>

<!-- Add the toggle edit mode script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Set default state - hide editable sections
        const editableSections = document.querySelectorAll('.profile-editable-section');
        const displaySections = document.querySelectorAll('.profile-display-section');
        const headerContainer = document.getElementById('headerContainer');
        const floatingSaveBtn = document.getElementById('floatingSaveBtn');
        let isEditMode = false;

        // Hide editable sections and floating save button by default
        editableSections.forEach(section => {
            section.style.display = 'none';
        });
        if (floatingSaveBtn) {
            floatingSaveBtn.style.display = 'none';
        }

        // Show display sections by default
        displaySections.forEach(section => {
            section.style.display = 'block';
        });

        // Setup edit button toggle
        const editBtn = document.getElementById('editProfileBtn');
        if (editBtn) {
            editBtn.addEventListener('click', function () {
                isEditMode = !isEditMode;

                if (isEditMode) {
                    // Show editable sections
                    editableSections.forEach(section => {
                        section.style.display = 'block';
                    });

                    // Hide display sections
                    displaySections.forEach(section => {
                        section.style.display = 'none';
                    });

                    // Show header container and floating save button
                    if (headerContainer) {
                        headerContainer.style.display = 'block';
                    }
                    if (floatingSaveBtn) {
                        floatingSaveBtn.style.display = 'flex';
                    }

                    // Update button text
                    editBtn.textContent = 'Cancel Editing';
                    editBtn.classList.add('bg-gray-600');
                    editBtn.classList.remove('bg-black');
                } else {
                    // Hide editable sections
                    editableSections.forEach(section => {
                        section.style.display = 'none';
                    });

                    // Show display sections
                    displaySections.forEach(section => {
                        section.style.display = 'block';
                    });

                    // Hide header container and floating save button
                    if (headerContainer) {
                        headerContainer.style.display = 'none';
                    }
                    if (floatingSaveBtn) {
                        floatingSaveBtn.style.display = 'none';
                    }

                    // Update button text
                    editBtn.textContent = 'Edit Profile';
                    editBtn.classList.remove('bg-gray-600');
                    editBtn.classList.add('bg-black');
                }
            });
        }

        // Setup the unified save button
        if (floatingSaveBtn) {
            floatingSaveBtn.addEventListener('click', async function () {
                try {
                    // Show loading state
                    this.disabled = true;
                    this.innerHTML = `
                        <div class="save-btn-content">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Saving...</span>
                        </div>
                    `;

                    // Save profile information
                    const profileForm = document.getElementById('profileForm');
                    const profileFormData = new FormData(profileForm);

                    // Save links
                    const linkTitles = Array.from(document.querySelectorAll('input[name="link_titles[]"]')).map(input => input.value.trim());
                    const linkUrls = Array.from(document.querySelectorAll('input[name="link_urls[]"]')).map(input => input.value.trim());
                    const links = linkTitles.map((title, index) => ({
                        title: title,
                        url: linkUrls[index]
                    })).filter(link => link.title && link.url);

                    profileFormData.append('links', JSON.stringify(links));

                    // Save academic portfolio
                    const academicPortfolioForm = document.getElementById('academicPortfolioForm');
                    const academicData = {
                        gpa: academicPortfolioForm.querySelector('input[name="gpa"]').value,
                        sat_score: academicPortfolioForm.querySelector('input[name="sat_score"]').value,
                        toefl_score: academicPortfolioForm.querySelector('input[name="toefl_score"]').value,
                        ielts_score: academicPortfolioForm.querySelector('input[name="ielts_score"]').value,
                        languages: collectLanguages(),
                        achievements: collectAchievements()
                    };

                    // Save everything with a single request
                    const profileResponse = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: profileFormData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const academicResponse = await fetch('/update_academic_portfolio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(academicData)
                    });

                    // Check if all saves were successful
                    const profileResult = await profileResponse.json();
                    const academicResult = await academicResponse.json();

                    if (profileResult.success && academicResult.success) {
                        showNotification('All changes saved successfully');

                        // Reset button state
                        this.disabled = false;
                        this.innerHTML = `
                            <div class="save-btn-content">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <span>Save All Changes</span>
                            </div>
                        `;

                        // Exit edit mode
                        if (editBtn) {
                            editBtn.click();
                        }

                        // Reload the page to show updated information
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        throw new Error('Error saving changes');
                    }
                } catch (error) {
                    console.error('Error saving changes:', error);
                    showNotification('Error saving changes. Please try again.', 'error');

                    // Reset button state
                    this.disabled = false;
                    this.innerHTML = `
                        <div class="save-btn-content">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            <span>Save All Changes</span>
                        </div>
                    `;
                }
            });
        }

        // Helper functions
        function collectLanguages() {
            const languages = [];
            const containers = document.querySelectorAll('#languagesContainer > div');

            containers.forEach(container => {
                const nameInput = container.querySelector('input[name="language_name"]');
                const levelSelect = container.querySelector('select[name="language_level"]');

                if (nameInput && nameInput.value.trim()) {
                    languages.push({
                        name: nameInput.value.trim(),
                        level: levelSelect ? levelSelect.value : 'A1'
                    });
                }
            });

            return languages;
        }

        function collectAchievements() {
            const achievements = [];
            const containers = document.querySelectorAll('#achievementsContainer > div');

            containers.forEach(container => {
                const titleInput = container.querySelector('input[name="achievement_title"]');
                const descTextarea = container.querySelector('textarea[name="achievement_description"]');
                const dateInput = container.querySelector('input[name="achievement_date"]');

                if (titleInput && titleInput.value.trim()) {
                    achievements.push({
                        title: titleInput.value.trim(),
                        description: descTextarea ? descTextarea.value : '',
                        date: dateInput ? dateInput.value : ''
                    });
                }
            });

            return achievements;
        }

        // Notification function
        window.showNotification = function (message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `toast-notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        };
    });
</script>

<!-- Helper Functions for Profile Management -->
<script>
    // Function to preview profile image
    function previewImage(input) {
        const preview = document.getElementById('avatarPreview');
        const file = input.files[0];
        const reader = new FileReader();

        reader.onloadend = function () {
            preview.src = reader.result;
        }

        if (file) {
            reader.readAsDataURL(file);
        } else {
            preview.src = "{{ avatar_url }}";
        }
    }

    // Function to copy profile link
    function copyProfileLink() {
        const profileLink = `{{ request.host_url }}{{ user_data.username }}`;
        navigator.clipboard.writeText(profileLink).then(() => {
            showNotification('Profile link copied to clipboard!');
        }).catch(err => {
            showNotification('Failed to copy link', 'error');
        });
    }

    // Functions for header management
    function handleHeaderUpload(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];

        // Check file size and type
        if (file.size > 5 * 1024 * 1024) {
            showNotification('File must be less than 5MB', 'error');
            return;
        }

        if (!file.type.startsWith('image/')) {
            showNotification('Only images can be uploaded', 'error');
            return;
        }

        // Create FormData and update the header
        const formData = new FormData();
        formData.append('header_image', file);
        formData.append('position', '50% 50%'); // Default position

        fetch('/update_header', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update header image
                    const headerImage = document.getElementById('headerImage');
                    headerImage.src = data.header.url;
                    headerImage.style.objectPosition = data.header.position;

                    showNotification('Header updated successfully');
                } else {
                    throw new Error(data.error || 'Failed to update header');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to update header image', 'error');
            });
    }

    // Functions for certificate management
    function showUploadModal() {
        const modal = document.getElementById('uploadModal');
        if (modal) {
            modal.classList.add('modal-open');
        }
    }

    function closeUploadModal() {
        const modal = document.getElementById('uploadModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
        document.getElementById('certificateForm').reset();
        document.getElementById('previewContainer').classList.add('hidden');
    }

    function previewCertificate(input) {
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');

        if (input.files && input.files[0]) {
            const file = input.files[0];
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                previewContainer.classList.add('hidden');
            }
        }
    }

    function deleteCertificate(certId) {
        document.getElementById('certificateToDelete').value = certId;
        const modal = document.getElementById('deleteCertificateModal');
        if (modal) {
            modal.classList.add('modal-open');
        }
    }

    function closeDeleteCertificateModal() {
        const modal = document.getElementById('deleteCertificateModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
    }

    function performCertificateDelete(certId) {
        fetch(`/delete-certificate/${certId}`, {
            method: 'DELETE',
        })
            .then(response => {
                if (response.ok) {
                    showNotification('Certificate deleted successfully');
                    window.location.reload();
                } else {
                    throw new Error('Failed to delete certificate');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error deleting certificate', 'error');
            });
    }

    // Functions for skills management
    let currentSkills = {{ user_data.skills | tojson | safe if user_data.skills else '[]' }};

    function showSkillsEditor() {
        const modal = document.getElementById('skillsModal');
        const skillsList = document.getElementById('skillsList');
        if (!modal || !skillsList) return;

        skillsList.innerHTML = '';
        currentSkills.forEach(skill => addSkillInput(skill));
        modal.classList.add('modal-open');
    }

    function closeSkillsModal(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        const modal = document.getElementById('skillsModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
    }

    function addSkillInput(value = '') {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';

        const input = document.createElement('input');
        input.className = 'input input-bordered flex-1';
        input.type = 'text';
        input.placeholder = 'Enter skill (e.g., Python, C++)';
        input.maxLength = 20;
        if (value) {
            input.value = value;
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-ghost btn-sm text-red-500 hover:bg-red-50';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            skillDiv.remove();
        });

        skillDiv.appendChild(input);
        skillDiv.appendChild(removeBtn);
        skillsList.appendChild(skillDiv);

        input.focus();
    }

    function addNewSkill(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        addSkillInput();
    }

    async function saveSkills(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const inputs = document.querySelectorAll('#skillsList input');
        const skills = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                closeSkillsModal();
                showNotification('Skills updated successfully');

                // Update the sidebar if it's visible
                if (typeof isRecommendationsSidebarVisible === 'function' &&
                    isRecommendationsSidebarVisible()) {
                    const profileData = typeof collectProfileData === 'function' ?
                        collectProfileData() : { personal: { skills: skills } };
                    typeof updateRecommendationSidebar === 'function' &&
                        updateRecommendationSidebar(profileData);
                }
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
            console.error('Error:', error);
        }
    }

    function updateSkillsDisplay() {
        const container = document.getElementById('skillsContainer');
        if (!container) return;

        container.innerHTML = currentSkills.map(skill => `
            <span class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full">
                ${skill}
            </span>
        `).join('');
    }

    // Functions for links management
    function addLink() {
        const linksContainer = document.getElementById('linksContainer');
        if (!linksContainer) return;

        const linkEntry = document.createElement('div');
        linkEntry.className = 'link-entry group p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
        linkEntry.innerHTML = `
            <div class="flex items-start gap-4">
                <div class="link-icon flex-shrink-0 mt-2">
                    <svg class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                </div>
                <div class="flex-grow space-y-3">
                    <input type="text" name="link_titles[]" placeholder="Link Title"
                        class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
                    <input type="text" name="link_urls[]" placeholder="URL"
                        class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
                </div>
                <div class="flex-shrink-0 flex items-start space-x-2">
                    <button type="button" onclick="removeLink(this)"
                        class="btn btn-ghost btn-sm p-2 hover:bg-red-50 text-red-500 transition-colors rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        `;

        linksContainer.appendChild(linkEntry);
    }

    function removeLink(button) {
        const linkEntry = button.closest('.link-entry');
        if (linkEntry) {
            linkEntry.remove();
        }
    }

    // Functions for academic portfolio
    function addLanguage() {
        const languagesContainer = document.getElementById('languagesContainer');
        if (!languagesContainer) return;

        const languageRow = document.createElement('div');
        languageRow.className = 'flex gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
        languageRow.innerHTML = `
            <input type="text" name="language_name" placeholder="Language"
                class="input input-bordered flex-1 bg-white focus:ring-2 focus:ring-black transition-all">
            <select name="language_level"
                class="select select-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                <option value="A1">A1 - Beginner</option>
                <option value="A2">A2 - Elementary</option>
                <option value="B1">B1 - Intermediate</option>
                <option value="B2">B2 - Upper Intermediate</option>
                <option value="C1">C1 - Advanced</option>
                <option value="C2">C2 - Mastery</option>
            </select>
            <button type="button" onclick="removeLanguage(this)"
                class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        `;

        languagesContainer.appendChild(languageRow);
    }

    function removeLanguage(button) {
        const languageRow = button.closest('div');
        if (languageRow) {
            languageRow.remove();
        }
    }

    function addAchievement() {
        const achievementsContainer = document.getElementById('achievementsContainer');
        if (!achievementsContainer) return;

        const achievementRow = document.createElement('div');
        achievementRow.className = 'p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
        achievementRow.innerHTML = `
            <div class="space-y-4">
                <input type="text" name="achievement_title" placeholder="Achievement Title"
                    class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
                <textarea name="achievement_description" placeholder="Description"
                    class="textarea textarea-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all min-h-[100px]"></textarea>
                <div class="flex items-center justify-between">
                    <input type="date" name="achievement_date"
                        class="input input-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                    <button type="button" onclick="removeAchievement(this)"
                        class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        `;

        achievementsContainer.appendChild(achievementRow);
    }

    function removeAchievement(button) {
        const achievementRow = button.closest('.p-6');
        if (achievementRow) {
            achievementRow.remove();
        }
    }

    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Setup certificate form submission
        const certificateForm = document.getElementById('certificateForm');
        if (certificateForm) {
            certificateForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData();
                const title = document.getElementById('certTitle').value;
                const fileInput = this.querySelector('input[type="file"]');

                if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                    showNotification('Please select a file', 'error');
                    return;
                }

                formData.append('title', title);
                formData.append('certificate', fileInput.files[0]);

                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Certificate uploaded successfully');
                            closeUploadModal();
                            window.location.reload();
                        } else {
                            throw new Error(data.error || 'Upload failed');
                        }
                    })
                    .catch(error => {
                        console.error('Upload error:', error);
                        showNotification('Failed to upload certificate', 'error');
                    });
            });
        }

        // Setup confirmation button in delete certificate modal
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function () {
                const certId = document.getElementById('certificateToDelete').value;
                if (certId) {
                    performCertificateDelete(certId);
                    closeDeleteCertificateModal();
                }
            });
        }
    });
</script>


<!-- Добавьте этот код в profile.html перед закрывающим тегом </body> -->

<!-- Кнопка для открытия рекомендаций -->
<button onclick="showUniversityRecommendations()"
    class="fixed right-4 top-1/2 transform -translate-y-1/2 bg-black text-white p-4 rounded-l-xl shadow-lg hover:bg-gray-800 transition-all duration-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
    </svg>
</button>



<!-- University Recommendations Sidebar -->
<div id="universityRecommendationsModal"
    class="fixed inset-y-0 right-0 w-full md:w-2/3 lg:w-1/2 xl:w-2/5 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto">
    <!-- Header with close button -->
    <div class="sticky top-0 z-10 bg-white border-b shadow-sm">
        <div class="px-6 py-4 flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold">University Recommendations</h2>
                <p class="text-sm text-gray-600">Find your perfect academic match</p>
            </div>
            <button onclick="closeUniversityRecommendations()"
                class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <div class="px-6 py-6">
        <!-- Profile Overview Section -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="p-4 border-b cursor-pointer flex justify-between items-center" id="profileHeader">
                <h3 class="font-semibold">Your Academic Profile</h3>
                <svg id="profileToggleIcon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>

            <div id="profileOverview" class="p-4">
                <!-- Академические показатели -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">GPA</div>
                        <div class="text-lg font-semibold" id="profileGpa">Not provided</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">TOEFL</div>
                        <div class="text-lg font-semibold" id="profileToefl">Not provided</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">IELTS</div>
                        <div class="text-lg font-semibold" id="profileIelts">Not provided</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">SAT</div>
                        <div class="text-lg font-semibold" id="profileSat">Not provided</div>
                    </div>
                </div>

                <!-- Добавляем раздел личной информации -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Personal Info
                    </h4>
                    <div class="bg-gray-50 p-3 rounded-lg space-y-2">
                        <div>
                            <span class="text-xs text-gray-500">Specialty:</span>
                            <span class="font-medium ml-1" id="profileSpecialty">Not specified</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Age:</span>
                            <span class="font-medium ml-1" id="profileAge">Not specified</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Education:</span>
                            <p class="text-sm text-gray-700 mt-1" id="profileEducation">No education details provided
                            </p>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Goals:</span>
                            <p class="text-sm text-gray-700 mt-1" id="profileGoals">No goals specified</p>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Bio:</span>
                            <p class="text-sm text-gray-700 mt-1" id="profileBio">No bio provided</p>
                        </div>
                    </div>
                </div>

                <!-- Навыки -->
                <div class="mb-5">
                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-700" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Skills & Expertise
                    </h4>
                    <div class="flex flex-wrap gap-2" id="skillsBadges">
                        <span class="text-gray-500 text-sm">No skills added</span>
                    </div>
                </div>

                <!-- Сертификаты -->
                <div class="mb-3">
                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-700" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        Certificates & Achievements
                    </h4>
                    <div class="space-y-2" id="certificatesList">
                        <span class="text-gray-500 text-sm">No certificates uploaded</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Country Selection and Controls -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-black" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Choose Your Study Destination
            </h3>
            <div class="flex flex-wrap items-center gap-3">
                <select id="countrySelect"
                    class="select select-bordered flex-1 py-2 px-3 bg-white rounded border border-gray-300 text-base">
                    <option value="">Select a country</option>
                    <option value="USA">United States</option>
                    <option value="UK">United Kingdom</option>
                    <option value="Canada">Canada</option>
                    <option value="Australia">Australia</option>
                    <option value="Germany">Germany</option>
                    <option value="France">France</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="Switzerland">Switzerland</option>
                    <option value="Japan">Japan</option>
                    <option value="Singapore">Singapore</option>
                    <option value="China">China</option>
                    <option value="South Korea">South Korea</option>
                    <option value="Italy">Italy</option>
                    <option value="Sweden">Sweden</option>
                    <option value="Finland">Finland</option>
                    <option value="Norway">Norway</option>
                    <option value="Spain">Spain</option>
                </select>
                <script>
                    // Simple direct function to enable the button
                    function enableFindButton() {
                        const btn = document.querySelector('button[onclick="getRecommendations()"]');
                        if (btn) {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50', 'disabled', 'cursor-not-allowed');
                        }
                    }
                </script>
                <button onclick="getRecommendations()"
                    class="btn bg-black hover:bg-gray-800 text-white text-base py-2 px-4 rounded ripple disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 flex items-center gap-2"
                    disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Find Universities
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden bg-white rounded-lg shadow-sm p-8 text-center mb-6">
            <div class="flex flex-col items-center justify-center gap-3">
                <div class="w-16 h-16 border-t-4 border-b-4 border-black rounded-full animate-spin"></div>
                <div>
                    <p class="font-medium text-lg mb-1">Analyzing Your Profile...</p>
                    <p class="text-gray-500 text-sm">Finding the perfect university matches for you</p>
                </div>
                <div class="w-full max-w-md bg-gray-200 rounded-full h-2.5 mt-4 overflow-hidden">
                    <div class="bg-black h-full rounded-full animated-progress"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2">This may take a moment as we analyze multiple factors</p>
            </div>
        </div>

        <!-- Results Container with Toggle Tabs -->
        <div id="recommendationsContainer" class="hidden">
            <div id="viewToggle" class="flex border-b mb-4">
                <button id="recommendationsTabBtn" class="px-4 py-2 font-medium text-black border-b-2 border-black">
                    Recommendations
                </button>
                <button id="favoritesTabBtn" class="px-4 py-2 font-medium text-gray-500 hover:text-black">
                    Saved Universities
                </button>
            </div>

            <div id="recommendationsList" class="space-y-6">
                <!-- University cards will be dynamically inserted here -->
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="bg-white rounded-lg shadow-sm p-8 text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            <h3 class="text-xl font-medium text-gray-700 mb-2">Find Your Perfect University</h3>
            <p class="text-gray-500 text-base mb-6">Select a country and click "Find Universities" to get personalized
                recommendations based on your academic profile</p>
            <div class="flex flex-col gap-4 max-w-sm mx-auto">
                <div class="text-left">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-black text-white flex items-center justify-center mr-2">1
                        </div>
                        <span class="font-medium">Complete your profile</span>
                    </div>
                    <p class="text-sm text-gray-500 ml-10">Add your academic scores, skills and certificates</p>
                </div>
                <div class="text-left">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-black text-white flex items-center justify-center mr-2">2
                        </div>
                        <span class="font-medium">Select your desired country</span>
                    </div>
                    <p class="text-sm text-gray-500 ml-10">Choose where you want to study</p>
                </div>
                <div class="text-left">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-black text-white flex items-center justify-center mr-2">3
                        </div>
                        <span class="font-medium">Get AI-powered recommendations</span>
                    </div>
                    <p class="text-sm text-gray-500 ml-10">Receive personalized university suggestions</p>
                </div>
            </div>
        </div>

        <!-- Disclaimer & Info -->
        <div class="mt-6 text-xs text-gray-500 border-t pt-4">
            <p class="mb-2">
                <strong>How recommendations work:</strong> Our AI analyzes your academic profile and matches
                it with university requirements to find your best fit options.
            </p>
            <p>
                <strong>Disclaimer:</strong> Recommendations are based on your profile data. Always verify
                information directly with universities before making decisions.
            </p>
        </div>
    </div>
</div>

<script>

    function closeUniversityRecommendations() {
        const modal = document.getElementById('universityRecommendationsModal');
        if (modal) modal.classList.add('translate-x-full');
    }

</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Utility Functions
        const utils = {
            debounce: function (func, delay) {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(null, args), delay);
                };
            },
            showNotification: function (message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg ${type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'} transition-opacity duration-300`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        };

        // Avatar Upload Handler
        const avatarHandler = {
            init: function () {
                const avatarInput = document.querySelector('input[name="avatar"]');
                if (avatarInput) {
                    avatarInput.addEventListener('change', this.handleUpload.bind(this));
                }
            },
            handleUpload: async function (event) {
                const file = event.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('avatar', file);

                try {
                    const response = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('avatarPreview').src = data.avatar_url;
                        const navAvatars = document.querySelectorAll('.avatar img');
                        navAvatars.forEach(avatar => {
                            avatar.src = data.avatar_url;
                        });
                        utils.showNotification('Avatar updated successfully');
                    } else {
                        utils.showNotification('Failed to update avatar', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    utils.showNotification('Error updating avatar', 'error');
                }
            }
        };

        // Academic Portfolio Handler
        const academicPortfolioHandler = {
            init: function () {
                this.setupFormListeners();
                this.setupLanguageManagement();
                this.setupAchievementManagement();
            },
            setupFormListeners: function () {
                const academicForm = document.getElementById('academicPortfolioForm');
                if (academicForm) {
                    const scoreFields = ['gpa', 'sat_score', 'toefl_score', 'ielts_score'];
                    scoreFields.forEach(field => {
                        const input = academicForm.querySelector(`[name="${field}"]`);
                        if (input) {
                            input.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                        }
                    });

                    academicForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        await academicPortfolioHandler.savePortfolio();
                    });
                }
            },
            setupLanguageManagement: function () {
                const addLanguageBtn = document.getElementById('addLanguageBtn');
                const languagesContainer = document.getElementById('languagesContainer');

                if (addLanguageBtn && languagesContainer) {
                    addLanguageBtn.addEventListener('click', () => {
                        const newLanguageRow = this.createLanguageRow();
                        languagesContainer.appendChild(newLanguageRow);
                    });

                    languagesContainer.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                }
            },


            createAchievementRow: function () {
                const row = document.createElement('div');
                row.className = 'mb-4 p-4 bg-gray-50 rounded-lg';
                row.innerHTML = `
                <input type="text" name="achievement_title" placeholder="Achievement Title" 
                    class="input input-bordered w-full mb-2">
                <textarea name="achievement_description" placeholder="Description" 
                    class="textarea textarea-bordered w-full mb-2"></textarea>
                <input type="date" name="achievement_date" 
                    class="input input-bordered">
                <button type="button" class="btn btn-ghost text-red-500 mt-2">Remove</button>
            `;
                row.querySelector('button').addEventListener('click', () => row.remove());
                return row;
            },
            collectFormData: function () {
                const academicForm = document.getElementById('academicPortfolioForm');
                const formData = {
                    gpa: academicForm.querySelector('input[name="gpa"]').value,
                    sat_score: academicForm.querySelector('input[name="sat_score"]').value,
                    toefl_score: academicForm.querySelector('input[name="toefl_score"]').value,
                    ielts_score: academicForm.querySelector('input[name="ielts_score"]').value,
                    languages: [],
                    achievements: []
                };

                document.querySelectorAll('#languagesContainer > div').forEach(row => {
                    const name = row.querySelector('input[name="language_name"]').value;
                    const level = row.querySelector('select[name="language_level"]').value;
                    if (name) formData.languages.push({ name, level });
                });

                document.querySelectorAll('#achievementsContainer > div').forEach(row => {
                    const title = row.querySelector('input[name="achievement_title"]').value;
                    const description = row.querySelector('textarea[name="achievement_description"]').value;
                    const date = row.querySelector('input[name="achievement_date"]').value;
                    if (title) formData.achievements.push({ title, description, date });
                });

                return formData;
            },
            savePortfolio: async function () {
                const formData = this.collectFormData();

                try {
                    const response = await fetch('/update_academic_portfolio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                } catch (error) {
                    console.error('Error:', error);
                    utils.showNotification('Something went wrong', 'error');
                }
            }
        };

        // Links Management
        const linksHandler = {
            init: function () {
                this.setupLinkManagement();
                this.setupLinksSubmission();
            },
            setupLinkManagement: function () {
                const addLinkBtn = document.querySelector('[onclick="addLink()"]');
                const linksContainer = document.getElementById('linksContainer');

                if (addLinkBtn && linksContainer) {
                    addLinkBtn.addEventListener('click', () => {
                        const linkEntry = this.createLinkEntry();
                        linksContainer.appendChild(linkEntry);
                    });
                }

                // Добавляем функцию removeLink в глобальную область видимости
                window.removeLink = function (button) {
                    const linkEntry = button.closest('.link-entry');
                    if (linkEntry) {
                        linkEntry.remove();
                    }
                };
            },


            createLinkEntry: function () {
                const linkEntry = document.createElement('div');
                linkEntry.className = 'link-entry group flex items-center gap-2';
                linkEntry.innerHTML = `
                <input type="text" name="link_titles[]" placeholder="Link Title" 
                    class="input input-bordered flex-1">
                <input type="text" name="link_urls[]" placeholder="URL" 
                    class="input input-bordered flex-1">
                <button type="button" class="btn btn-ghost text-red-500">Remove</button>
            `;
                linkEntry.querySelector('button').addEventListener('click', () => linkEntry.remove());
                return linkEntry;
            },
            setupLinksSubmission: function () {
                const linksForm = document.getElementById('linksForm');
                if (linksForm) {
                    linksForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const titles = Array.from(this.querySelectorAll('input[name="link_titles[]"]')).map(input => input.value.trim());
                        const urls = Array.from(this.querySelectorAll('input[name="link_urls[]"]')).map(input => input.value.trim());

                        const links = titles.map((title, index) => ({
                            title: title,
                            url: urls[index]
                        })).filter(link => link.title && link.url);

                        try {
                            const response = await fetch('{{ url_for("profile") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify({
                                    action: 'update_links',
                                    links: links
                                })
                            });

                            const data = await response.json();
                            if (data.success) {
                                utils.showNotification('Links updated successfully');
                                location.reload();
                            } else {
                                throw new Error(data.error || 'Failed to update links');
                            }
                        } catch (error) {
                            utils.showNotification('Failed to update links', 'error');
                            console.error('Error:', error);
                        }
                    });
                }
            }
        };

        // Profile Update Handler
        const profileUpdateHandler = {
            init: function () {
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    profileForm.addEventListener('submit', this.handleSubmit.bind(this));
                }
            },
            handleSubmit: async function (e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                try {
                    const response = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        utils.showNotification('Profile updated successfully');

                        // Add this block to update skills in the sidebar
                        if (isRecommendationsSidebarVisible()) {
                            const profileData = collectProfileData();
                            updateRecommendationSidebar(profileData);
                        }

                        location.reload();
                    } else {
                        utils.showNotification('Update failed', 'error');
                    }
                } catch (error) {
                    utils.showNotification('Failed to update profile', 'error');
                }
            }
        };

        // Certificate Management
        const certificateHandler = {
            init: function () {
                this.setupCertificateUpload();
                this.setupCertificateDeletion();
            },
            setupCertificateUpload: function () {
                const certificateForm = document.getElementById('certificateForm');
                if (certificateForm) {
                    certificateForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const formData = new FormData();
                        const title = document.getElementById('certTitle').value;
                        const file = this.querySelector('input[type="file"]').files[0];

                        if (!file) {
                            utils.showNotification('Please select a file', 'error');
                            return;
                        }

                        formData.append('title', title);
                        formData.append('certificate', file);

                        try {
                            const response = await fetch(window.location.href, {
                                method: 'POST',
                                body: formData,
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });

                            const data = await response.json();
                            if (data.success) {
                                utils.showNotification('Certificate uploaded successfully');
                                closeUploadModal();
                                location.reload();
                            } else {
                                throw new Error(data.error || 'Upload failed');
                            }
                        } catch (error) {
                            console.error('Upload error:', error);
                            utils.showNotification('Failed to upload certificate', 'error');
                        }
                    });
                }
            },
            setupCertificateDeletion: function () {
                window.deleteCertificate = async function (certId) {
                    if (confirm('Are you sure you want to delete this certificate?')) {
                        try {
                            const response = await fetch(`/delete-certificate/${certId}`, {
                                method: 'DELETE',
                            });
                            if (response.ok) {
                                utils.showNotification('Certificate deleted successfully');
                                window.location.reload();
                            } else {
                                throw new Error('Failed to delete certificate');
                            }
                        } catch (error) {
                            utils.showNotification('Error deleting certificate', 'error');
                            console.error('Error:', error);
                        }
                    }
                };
            }
        };

        // Utility Functions
        window.copyProfileLink = function () {
            const profileLink = `{{ request.host_url }}{{ user_data.username }}`;
            navigator.clipboard.writeText(profileLink).then(() => {
                utils.showNotification('Profile link copied to clipboard!');
            }).catch(err => {
                utils.showNotification('Failed to copy link', 'error');
            });
        };

        window.showUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            modal.classList.add('modal-open');
        };

        window.closeUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            modal.classList.remove('modal-open');
            document.getElementById('certificateForm').reset();
            document.getElementById('previewContainer').classList.add('hidden');
        };

        window.previewCertificate = function (input) {
            const previewContainer = document.getElementById('previewContainer');
            const imagePreview = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.classList.add('hidden');
                }
            }
        };

        window.previewImage = function (input) {
            const preview = document.getElementById('avatarPreview');
            const file = input.files[0];
            const reader = new FileReader();

            reader.onloadend = function () {
                preview.src = reader.result;
            }

            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = "{{ avatar_url }}";
            }
        };

        // Initialize all handlers
        function init() {
            avatarHandler.init();
            academicPortfolioHandler.init();
            linksHandler.init();
            profileUpdateHandler.init();
            certificateHandler.init();
        }

        // Run initialization
        init();
    });
    document.addEventListener('DOMContentLoaded', function () {
        // Attach event listener to header input
        const headerInput = document.getElementById('headerInput');
        if (headerInput) {
            headerInput.addEventListener('change', function (e) {
                handleHeaderUpload(this);
            });
        } else {
            console.error('Header input element not found');
        }
    });
    let headerEditor = {
        verticalPos: 50,
        horizontalPos: 50
    };
    document.addEventListener('DOMContentLoaded', () => {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        if (xSlider && ySlider) {
            xSlider.addEventListener('input', updateHeaderPreviewPosition);
            ySlider.addEventListener('input', updateHeaderPreviewPosition);
        }
    });

    function updateHeaderPreviewPosition() {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        if (!xSlider || !ySlider) return;

        const x = xSlider.value;
        const y = ySlider.value;

        const desktopPreview = document.getElementById('desktopHeaderPreview');
        const mobilePreview = document.getElementById('mobileHeaderPreview');

        if (desktopPreview) desktopPreview.style.objectPosition = `${x}% ${y}%`;
        if (mobilePreview) mobilePreview.style.objectPosition = `${x}% ${y}%`;

        // Update stored values
        headerEditor.horizontalPos = x;
        headerEditor.verticalPos = y;
    }

    function updatePosition(x, y) {
        const preview = document.getElementById('headerPreview');
        if (preview) {
            preview.style.objectPosition = `${x}% ${y}%`;
        }
    }

    function handleHeaderUpload(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];

        // Проверка размера и типа файла
        if (file.size > 5 * 1024 * 1024) {
            alert('Размер файла должен быть меньше 5 МБ');
            return;
        }

        if (!file.type.startsWith('image/')) {
            alert('Можно загружать только изображения');
            return;
        }

        // Принудительное создание модального окна, если оно отсутствует
        let headerEditorModal = document.getElementById('headerEditorModal');
        if (!headerEditorModal) {
            headerEditorModal = document.createElement('div');
            headerEditorModal.id = 'headerEditorModal';
            headerEditorModal.className = 'modal';
            headerEditorModal.innerHTML = `
            <div class="modal-box max-w-4xl p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Desktop Preview</h4>
                        <div class="relative w-full h-[300px] bg-gray-100 rounded-xl overflow-hidden">
                            <img id="desktopHeaderPreview" src="" alt="Desktop header preview" 
                                 class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Mobile Preview</h4>
                        <div class="relative w-full h-[200px] bg-gray-100 rounded-xl overflow-hidden">
                            <img id="mobileHeaderPreview" src="" alt="Mobile header preview" 
                                 class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </div>
        `;
            document.body.appendChild(headerEditorModal);
        }

        const reader = new FileReader();

        reader.onload = function (e) {
            // Форсированное получение элементов
            const desktopPreview = document.getElementById('desktopHeaderPreview') ||
                (() => {
                    const img = document.createElement('img');
                    img.id = 'desktopHeaderPreview';
                    img.className = 'w-full h-full object-cover';
                    document.querySelector('.modal-box').appendChild(img);
                    return img;
                })();

            const mobilePreview = document.getElementById('mobileHeaderPreview') ||
                (() => {
                    const img = document.createElement('img');
                    img.id = 'mobileHeaderPreview';
                    img.className = 'w-full h-full object-cover';
                    document.querySelector('.modal-box').appendChild(img);
                    return img;
                })();

            // Принудительная установка src
            desktopPreview.src = e.target.result;
            mobilePreview.src = e.target.result;

            // Открытие модального окна
            headerEditorModal.classList.add('modal-open');

            // Сброс позиции
            const xSlider = document.getElementById('xPosition') ||
                (() => {
                    const slider = document.createElement('input');
                    slider.id = 'xPosition';
                    slider.type = 'range';
                    slider.min = '0';
                    slider.max = '100';
                    slider.value = '50';
                    document.querySelector('.modal-box').appendChild(slider);
                    return slider;
                })();

            const ySlider = document.getElementById('yPosition') ||
                (() => {
                    const slider = document.createElement('input');
                    slider.id = 'yPosition';
                    slider.type = 'range';
                    slider.min = '0';
                    slider.max = '100';
                    slider.value = '50';
                    document.querySelector('.modal-box').appendChild(slider);
                    return slider;
                })();

            xSlider.value = '50';
            ySlider.value = '50';

            // Сохранение файла
            headerEditor.file = file;
        };

        reader.readAsDataURL(file);
    }



    function saveHeaderImage() {
        if (!headerEditor.file) {
            showNotification('Please select an image', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('header_image', headerEditor.file);
        formData.append('position', `${headerEditor.horizontalPos}% ${headerEditor.verticalPos}%`);

        fetch('/update_header', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update main header image
                    const headerImage = document.getElementById('headerImage');
                    headerImage.src = data.header.url;
                    headerImage.style.objectPosition = data.header.position;

                    closeHeaderEditor();
                    showNotification('Header updated successfully');
                } else {
                    throw new Error(data.error || 'Failed to update header');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to update header image', 'error');
            });
    }





    function closeHeaderEditor() {
        document.getElementById('headerEditorModal').classList.remove('modal-open');
        currentHeaderFile = null;
    }



    let currentSkills = {{ user_data.skills| tojson | safe if user_data.skills else '[]'
    }};
    // Добавим слушатели для слайдеров
    document.addEventListener('DOMContentLoaded', () => {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        xSlider.addEventListener('input', updateHeaderPreviewPosition);
        ySlider.addEventListener('input', updateHeaderPreviewPosition);
    });
    function showSkillsEditor() {
        const modal = document.getElementById('skillsModal');
        const skillsList = document.getElementById('skillsList');
        skillsList.innerHTML = '';

        currentSkills.forEach(skill => addSkillInput(skill));
        modal.classList.add('modal-open');
    }

    // Update the addSkillInput function
    function addSkillInput(value = '') {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';

        // Create input element separately so we can set its value properly
        const input = document.createElement('input');
        input.className = 'input input-bordered flex-1';
        input.type = 'text';
        input.placeholder = 'Enter skill (e.g., Python, C++)';
        input.maxLength = 20;
        if (value) {
            input.value = value; // Only set value if one is provided
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-ghost btn-sm text-red-500 hover:bg-red-50';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            skillDiv.remove();
        });

        // Add elements to the div
        skillDiv.appendChild(input);
        skillDiv.appendChild(removeBtn);
        skillsList.appendChild(skillDiv);

        // Focus the new input
        input.focus();
    }



    async function saveSkills() {
        const skills = Array.from(document.querySelectorAll('#skillsList input'))
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                closeSkillsModal();
                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
        }
    }

    function updateSkillsDisplay() {
        const container = document.getElementById('skillsContainer');
        container.innerHTML = currentSkills.map(skill => `
        <span class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full">
            ${skill}
        </span>
    `).join('');
    }

    function closeSkillsModal() {
        document.getElementById('skillsModal').classList.remove('modal-open');
    }
    // Add this at the bottom of your existing script section, outside any existing event listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Skills Management
        const skillsModal = document.getElementById('skillsModal');
        const showSkillsEditorBtn = document.querySelector('[onclick="showSkillsEditor"]');

        if (showSkillsEditorBtn) {
            showSkillsEditorBtn.addEventListener('click', function (e) {
                e.preventDefault(); // Prevent default form submission
                showSkillsEditor();
            });
        }

        // Location Management
        function initializeLocation() {
            if (!navigator.geolocation) {
                console.log('Geolocation is not supported by this browser.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async position => {
                    try {
                        const response = await fetch('/update-location', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                coordinates: {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                }
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            const locationEl = document.querySelector('[data-location]');
                            if (locationEl) {
                                locationEl.textContent = `${data.location.city}, ${data.location.country}`;
                            }
                        }
                    } catch (error) {
                        console.error('Error updating location:', error);
                    }
                },
                error => {
                    console.log('Error getting location:', error);
                    // Fallback to IP-based location
                    fetchIPBasedLocation();
                }
            );
        }

        async function fetchIPBasedLocation() {
            try {
                const response = await fetch('/get-ip-location');
                const data = await response.json();
                if (data.success) {
                    const locationEl = document.querySelector('[data-location]');
                    if (locationEl) {
                        locationEl.textContent = `${data.location.city}, ${data.location.country}`;
                    }
                }
            } catch (error) {
                console.error('Error fetching IP location:', error);
            }
        }

        // Initialize location on page load
        initializeLocation();
    });

    // Move the skills functions outside the DOMContentLoaded event
    function showSkillsEditor() {
        const modal = document.getElementById('skillsModal');
        const skillsList = document.getElementById('skillsList');
        if (!modal || !skillsList) return;

        skillsList.innerHTML = '';
        currentSkills.forEach(skill => addSkillInput(skill));
        modal.classList.add('modal-open');
    }

    function closeSkillsModal() {
        const modal = document.getElementById('skillsModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
    }

    function addSkillInput(value = '') {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';
        skillDiv.innerHTML = `
        <input type="text" class="input input-bordered flex-1" value="${value}" 
               placeholder="Enter skill (e.g., Python, C++)" maxlength="20">
        <button type="button" class="btn btn-ghost btn-sm text-red-500 hover:bg-red-50">
            Remove
        </button>
    `;

        skillDiv.querySelector('button').addEventListener('click', function () {
            skillDiv.remove();
        });

        skillsList.appendChild(skillDiv);
    }

    async function saveSkills() {
        const inputs = document.querySelectorAll('#skillsList input');
        const skills = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                closeSkillsModal();
                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
            console.error('Error:', error);
        }
    }

    function updateSkillsDisplay() {
        const container = document.getElementById('skillsContainer');
        if (!container) return;

        container.innerHTML = currentSkills.map(skill => `
        <span class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full">
            ${skill}
        </span>
    `).join('');
    }
    // Modify the Skills Management Event Handlers
    document.addEventListener('DOMContentLoaded', function () {
        // Update the button click handler to properly prevent form submission
        const skillsEditorBtn = document.querySelector('button[onclick="showSkillsEditor()"]');
        if (skillsEditorBtn) {
            skillsEditorBtn.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();
                const modal = document.getElementById('skillsModal');
                const skillsList = document.getElementById('skillsList');
                if (!modal || !skillsList) return;

                skillsList.innerHTML = '';
                currentSkills.forEach(skill => addSkillInput(skill));
                modal.classList.add('modal-open');
            };
        }

        // Prevent form submission when clicking inside the modal
        const skillsModal = document.getElementById('skillsModal');
        if (skillsModal) {
            skillsModal.addEventListener('click', function (e) {
                e.stopPropagation();
            });

            // Prevent modal from closing when clicking inside
            skillsModal.querySelector('.modal-box').addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }

        // Update modal close handler
        const closeModalBtn = document.querySelector('button[onclick="closeSkillsModal()"]');
        if (closeModalBtn) {
            closeModalBtn.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();
                const modal = document.getElementById('skillsModal');
                if (modal) {
                    modal.classList.remove('modal-open');
                }
            };
        }
    });

    // Modify the saveSkills function to update the sidebar
    async function saveSkills(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const inputs = document.querySelectorAll('#skillsList input');
        const skills = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                // Update the global skills array
                window.currentSkills = skills;

                // Update the display
                updateSkillsDisplay();

                // Close the modal
                closeSkillsModal();

                // Update the sidebar if it's visible
                if (isRecommendationsSidebarVisible()) {
                    const profileData = collectProfileData();
                    updateRecommendationSidebar(profileData);
                }

                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
            console.error('Error:', error);
        }
    }

    function showSkillsEditor(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        const modal = document.getElementById('skillsModal');
        const skillsList = document.getElementById('skillsList');
        if (!modal || !skillsList) return;

        // Clear existing skills
        skillsList.innerHTML = '';

        // Add current skills
        currentSkills.forEach(skill => addSkillInput(skill));

        // Show modal
        modal.classList.add('modal-open');
    }

    function addSkillInput(value = '') {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';
        skillDiv.innerHTML = `
        <input type="text" class="input input-bordered flex-1" value="${value}" 
               placeholder="Enter skill (e.g., Python, C++)" maxlength="20">
        <button type="button" class="btn btn-ghost btn-sm text-red-500 hover:bg-red-50">Remove</button>
    `;

        // Add click handler for remove button
        const removeBtn = skillDiv.querySelector('button');
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            skillDiv.remove();
        });

        skillsList.appendChild(skillDiv);
    }

    async function saveSkills(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const inputs = document.querySelectorAll('#skillsList input');
        const skills = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                closeSkillsModal();
                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
            console.error('Error:', error);
        }
    }

    function closeSkillsModal(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        const modal = document.getElementById('skillsModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
    }


    // Update the addNewSkill button handler
    function addNewSkill(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';

        // Create input element
        const input = document.createElement('input');
        input.className = 'input input-bordered flex-1';
        input.type = 'text';
        input.placeholder = 'Enter skill (e.g., Python, C++)';
        input.maxLength = 20;

        // Create remove button
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-ghost btn-sm text-red-500 hover:bg-red-50';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            skillDiv.remove();
        });

        // Add elements to the div
        skillDiv.appendChild(input);
        skillDiv.appendChild(removeBtn);
        skillsList.appendChild(skillDiv);

        // Focus the new input
        input.focus();
    }
    // Update DOMContentLoaded event handler
    // Update the DOMContentLoaded event handler
    document.addEventListener('DOMContentLoaded', function () {
        // Prevent form submission/bubbling on modal clicks
        const skillsModal = document.getElementById('skillsModal');
        if (skillsModal) {
            skillsModal.addEventListener('click', (e) => e.stopPropagation());

            const modalBox = skillsModal.querySelector('.modal-box');
            if (modalBox) {
                modalBox.addEventListener('click', (e) => e.stopPropagation());
            }
        }

        // Clean up and set single event listener for Add Skill button
        const addSkillBtn = document.querySelector('button[onclick="addNewSkill(event)"]');
        if (addSkillBtn) {
            // Remove the inline onclick attribute
            addSkillBtn.removeAttribute('onclick');
            // Add single event listener
            addSkillBtn.addEventListener('click', addNewSkill);
        }
    });

    // Header Management
    let currentHeaderFile = null;


    function updatePosition(x, y) {
        const preview = document.getElementById('headerPreview');
        if (preview) {
            preview.style.objectPosition = `${x}% ${y}%`;
        }
    }


    // Функция для отображения уведомлений
    function showNotification(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 
                    ${type === 'error' ? 'bg-red-500' : 'bg-black'} text-white
                    opacity-0 transform translate-y-4 transition-all duration-300`;
        toast.textContent = message;

        // Добавляем в DOM
        document.body.appendChild(toast);

        // Запускаем анимацию появления
        setTimeout(() => {
            toast.classList.remove('opacity-0');
            toast.classList.remove('translate-y-4');
        }, 10);

        // Автоматически удаляем через 3 секунды
        setTimeout(() => {
            toast.classList.add('opacity-0');
            toast.classList.add('translate-y-4');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function closeHeaderEditor() {
        const modal = document.getElementById('headerEditorModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
        currentHeaderFile = null;
    }

    // Position slider handlers
    document.addEventListener('DOMContentLoaded', function () {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        if (xSlider && ySlider) {
            xSlider.addEventListener('input', function () {
                updatePosition(this.value, ySlider.value);
            });

            ySlider.addEventListener('input', function () {
                updatePosition(xSlider.value, this.value);
            });
        }
    });
</script>

<script>
    /**
 * Улучшенный скрипт для рекомендаций университетов с надежной
 * синхронизацией данных профиля и обработкой ошибок
 */

    // Функция для сбора текущих данных из форм профиля
    function collectProfileData() {
        // Сбор академических данных
        const academicData = {
            gpa: document.querySelector('input[name="gpa"]')?.value || '',
            satScore: document.querySelector('input[name="sat_score"]')?.value || '',
            toeflScore: document.querySelector('input[name="toefl_score"]')?.value || '',
            ieltsScore: document.querySelector('input[name="ielts_score"]')?.value || ''
        };
        // Make sure skills are properly included
        const skills = window.currentSkills || [];
        console.log("Current skills:", skills);

        // Сбор персональных данных
        const personalData = {
            specialty: document.querySelector('input[name="specialty"]')?.value || '',
            goals: document.querySelector('textarea[name="goals"]')?.value || '',
            education: document.querySelector('textarea[name="education"]')?.value || '',
            bio: document.querySelector('textarea[name="bio"]')?.value || '',
            age: document.querySelector('input[name="age"]')?.value || '',
            skills: window.currentSkills || []
        };

        // Сбор языков
        const languages = collectLanguages();

        // Сбор достижений
        const achievements = collectAchievements();

        // Доступ к сертификатам из глобального объекта (должны быть определены в шаблоне)
        const certificates = window.userCertificates || [];

        // Add a console log to check
        console.log("Collected profile data:", {
            personal: personalData,
            skills: window.currentSkills
        });

        return {
            academic: {
                gpa: document.querySelector('input[name="gpa"]')?.value || '',
                satScore: document.querySelector('input[name="sat_score"]')?.value || '',
                toeflScore: document.querySelector('input[name="toefl_score"]')?.value || '',
                ieltsScore: document.querySelector('input[name="ielts_score"]')?.value || ''
            },
            personal: {
                specialty: document.querySelector('input[name="specialty"]')?.value || '',
                goals: document.querySelector('textarea[name="goals"]')?.value || '',
                education: document.querySelector('textarea[name="education"]')?.value || '',
                bio: document.querySelector('textarea[name="bio"]')?.value || '',
                age: document.querySelector('input[name="age"]')?.value || '',
                skills: skills  // Make sure skills are included here
            },
            languages: collectLanguages(),
            achievements: collectAchievements(),
            certificates: window.userCertificates || []
        };
    }
    function collectProfileData() {
        // Get the current skills
        const skills = window.currentSkills || [];

        return {
            academic: {
                gpa: document.querySelector('input[name="gpa"]')?.value || '',
                satScore: document.querySelector('input[name="sat_score"]')?.value || '',
                toeflScore: document.querySelector('input[name="toefl_score"]')?.value || '',
                ieltsScore: document.querySelector('input[name="ielts_score"]')?.value || ''
            },
            personal: {
                specialty: document.querySelector('input[name="specialty"]')?.value || '',
                goals: document.querySelector('textarea[name="goals"]')?.value || '',
                education: document.querySelector('textarea[name="education"]')?.value || '',
                bio: document.querySelector('textarea[name="bio"]')?.value || '',
                age: document.querySelector('input[name="age"]')?.value || '',
                skills: skills  // Use the current skills array
            },
            languages: collectLanguages(),
            achievements: collectAchievements(),
            certificates: window.userCertificates || []
        };
    }
    // Сбор данных о языках из формы
    function collectLanguages() {
        const languages = [];
        const containers = document.querySelectorAll('#languagesContainer > div');

        containers.forEach(container => {
            const nameInput = container.querySelector('input[name="language_name"]');
            const levelSelect = container.querySelector('select[name="language_level"]');

            if (nameInput && nameInput.value.trim()) {
                languages.push({
                    name: nameInput.value.trim(),
                    level: levelSelect ? levelSelect.value : 'Conversational'
                });
            }
        });

        return languages;
    }

    // Сбор данных о достижениях из формы
    function collectAchievements() {
        const achievements = [];
        const containers = document.querySelectorAll('#achievementsContainer > div');

        containers.forEach(container => {
            const titleInput = container.querySelector('input[name="achievement_title"]');
            const descTextarea = container.querySelector('textarea[name="achievement_description"]');
            const dateInput = container.querySelector('input[name="achievement_date"]');

            if (titleInput && titleInput.value.trim()) {
                achievements.push({
                    title: titleInput.value.trim(),
                    description: descTextarea ? descTextarea.value : '',
                    date: dateInput ? dateInput.value : ''
                });
            }
        });

        return achievements;
    }

    // Обновление элементов информационной панели в сайдбаре рекомендаций
    function updateRecommendationSidebar(profileData) {
        try {
            const certificatesList = document.getElementById('certificatesList');
            if (certificatesList) {
                const certificates = profileData.certificates || [];
                if (certificates && certificates.length > 0) {
                    certificatesList.innerHTML = certificates.map(cert => `
                    <div class="flex items-center gap-2 text-sm">
                        <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="truncate">${cert.title || 'Unnamed Certificate'}</span>
                    </div>
                `).join('');
                } else {
                    certificatesList.innerHTML = '<span class="text-gray-500 text-sm">Uploaded!</span>';
                }
            }
            // Debug output to check data structure
            console.log("Updating sidebar with data:", profileData);

            // Add a fallback if skills aren't in the expected place
            const skills = profileData.personal?.skills ||
                profileData.skills ||
                window.currentSkills || [];

            // Update skills display
            const skillsBadges = document.getElementById('skillsBadges');
            if (skillsBadges) {
                if (skills && skills.length > 0) {
                    skillsBadges.innerHTML = skills.map(skill =>
                        `<span class="px-2 py-1 bg-purple-50 text-purple-700 text-xs rounded-full">${skill}</span>`
                    ).join('');
                } else {
                    skillsBadges.innerHTML = '<span class="text-gray-500 text-sm">No skills added</span>';
                }
            }



            // Debug output to check data structure
            console.log("Updating sidebar with data:", profileData);






            // Обновление академических показателей
            const profileGpa = document.getElementById('profileGpa');
            if (profileGpa) profileGpa.textContent = profileData.academic.gpa || 'Not provided';

            const profileToefl = document.getElementById('profileToefl');
            if (profileToefl) profileToefl.textContent = profileData.academic.toeflScore || 'Not provided';

            const profileIelts = document.getElementById('profileIelts');
            if (profileIelts) profileIelts.textContent = profileData.academic.ieltsScore || 'Not provided';

            const profileSat = document.getElementById('profileSat');
            if (profileSat) profileSat.textContent = profileData.academic.satScore || 'Not provided';

            // Обновление личной информации
            const profileSpecialty = document.getElementById('profileSpecialty');
            if (profileSpecialty) profileSpecialty.textContent = profileData.personal.specialty || 'Not specified';

            const profileAge = document.getElementById('profileAge');
            if (profileAge) profileAge.textContent = profileData.personal.age ? `${profileData.personal.age} years old` : 'Not specified';

            const profileEducation = document.getElementById('profileEducation');
            if (profileEducation) profileEducation.textContent = profileData.personal.education || 'No education details provided';

            const profileGoals = document.getElementById('profileGoals');
            if (profileGoals) profileGoals.textContent = profileData.personal.goals || 'No goals specified';

            const profileBio = document.getElementById('profileBio');
            if (profileBio) profileBio.textContent = profileData.personal.bio || 'No bio provided';





            console.log('Sidebar updated successfully');
        } catch (error) {
            console.error('Error updating sidebar:', error);
        }
    }

    // Функция для получения рекомендаций университетов
    function getUniversityRecommendations() {
        try {
            // Check if country is selected
            const countrySelect = document.getElementById('countrySelect');
            if (!countrySelect || !countrySelect.value) {
                showNotification('Please select a country', 'error');
                return;
            }

            // Collect current profile data
            const profileData = collectProfileData();

            // Update sidebar with current data
            updateRecommendationSidebar(profileData);

            // Show loading state
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const recommendationsContainer = document.getElementById('recommendationsContainer');

            if (loadingState) loadingState.style.display = 'block';
            if (emptyState) emptyState.style.display = 'none';
            if (recommendationsContainer) recommendationsContainer.style.display = 'none';

            // Send request to server
            fetch('/get-university-recommendations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    country: countrySelect.value,
                    profile: profileData.personal,
                    academic: profileData.academic,
                    languages: profileData.languages,
                    achievements: profileData.achievements,
                    certificates: profileData.certificates
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Recommendations received:', data);

                    // Hide loading, show results
                    if (loadingState) loadingState.style.display = 'none';
                    if (recommendationsContainer) recommendationsContainer.style.display = 'block';

                    // Render the results
                    renderRecommendations(data);
                })
                .catch(error => {
                    console.error('Error fetching recommendations:', error);
                    currentRecommendationResults = null; // Clear stored recommendations on error

                    if (loadingState) loadingState.style.display = 'none';
                    if (emptyState) {
                        emptyState.style.display = 'block';
                        emptyState.innerHTML = `
                    <div class="p-8 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="text-xl font-semibold mb-2">Error Getting Recommendations</h3>
                        <p class="text-gray-600 mb-4">${error.message || 'Unknown error occurred'}</p>
                        <button id="retryButton" class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800 transition-colors">
                            Try Again
                        </button>
                    </div>
                `;

                        // Add retry button handler
                        document.getElementById('retryButton')?.addEventListener('click', getUniversityRecommendations);
                    }
                });
        } catch (error) {
            console.error('Error in getUniversityRecommendations:', error);
            showNotification('An error occurred while getting recommendations', 'error');
        }
    }

    // Создание карточки университета
    function createUniversityCard(universityName, details, imageUrl, admissionChance, index) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-md overflow-hidden mb-6 transition-all duration-300 opacity-0 translate-y-4';
        card.dataset.university = universityName;

        // Определение цветовой схемы на основе шансов поступления
        const colorScheme = getAdmissionChanceColorScheme(admissionChance);
        const matchLabel = getAdmissionMatchLabel(admissionChance);

        let cardHTML = `
    <div class="relative h-48 w-full overflow-hidden">
      <img src="${imageUrl || 'https://images.unsplash.com/photo-1541339907198-e08756dedf3f'}" 
           alt="${universityName}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-105">
      <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
      <div class="absolute bottom-0 left-0 right-0 p-4">
        <h2 class="text-xl font-bold text-white">${universityName}</h2>
        <p class="text-white/80 flex items-center gap-1 text-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          ${details.location || 'Location information unavailable'}
        </p>
      </div>
    </div>
    
    <div class="p-4">
      <div class="flex justify-between items-center mb-4">
        <div class="${colorScheme.badge} px-3 py-1 rounded-full text-sm font-medium inline-flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          ${matchLabel} (${admissionChance}%)
        </div>
        ${details.ranking ? `
          <div class="bg-gray-100 rounded-lg px-2 py-1 text-xs font-medium">
            ${details.ranking}
          </div>
        ` : ''}
      </div>
      
      <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-4">
        <div class="${colorScheme.progressBar} h-full transition-all duration-1000 progress-bar" style="width: 0%"></div>
      </div>
  `;

        // Раздел программ
        if (details.programs && details.programs.length > 0) {
            cardHTML += `
      <div class="mb-4">
        <h3 class="font-medium text-gray-900 mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path d="M12 14l9-5-9-5-9 5 9 5z" />
            <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998a12.078 12.078 0 01.665-6.479L12 14z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998a12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
          </svg>
          Relevant Programs
        </h3>
        <ul class="space-y-1 text-sm">
          ${details.programs.slice(0, 3).map(program => `
            <li class="flex items-start gap-2">
              <span class="text-blue-500 mt-0.5">•</span>
              <span>${program}</span>
            </li>
          `).join('')}
          ${details.programs.length > 3 ? `
            <li class="text-xs text-gray-500 pl-4">+${details.programs.length - 3} more programs</li>
          ` : ''}
        </ul>
      </div>
    `;
        }

        // Раздел требований
        if (details.requirements && details.requirements.length > 0) {
            cardHTML += `
      <div class="mb-4">
        <h3 class="font-medium text-gray-900 mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
          Admission Requirements
        </h3>
        <ul class="space-y-1 text-sm">
          ${details.requirements.slice(0, 3).map(req => `
            <li class="flex items-start gap-2">
              <span class="text-purple-500 mt-0.5">•</span>
              <span>${req}</span>
            </li>
          `).join('')}
          ${details.requirements.length > 3 ? `
            <li class="text-xs text-gray-500 pl-4">+${details.requirements.length - 3} more requirements</li>
          ` : ''}
        </ul>
      </div>
    `;
        }

        // Раздел сроков
        if (details.deadlines && details.deadlines.length > 0) {
            cardHTML += `
      <div class="mb-4">
        <h3 class="font-medium text-gray-900 mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Application Deadlines
        </h3>
        <ul class="space-y-1 text-sm">
          ${details.deadlines.slice(0, 2).map(deadline => `
            <li class="flex items-start gap-2">
              <span class="text-red-500 mt-0.5">•</span>
              <span>${deadline}</span>
            </li>
          `).join('')}
          ${details.deadlines.length > 2 ? `
            <li class="text-xs text-gray-500 pl-4">+${details.deadlines.length - 2} more deadlines</li>
          ` : ''}
        </ul>
      </div>
    `;
        }

        // Кнопки действий
        cardHTML += `
    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
      <a href="https://www.google.com/search?q=${encodeURIComponent(universityName + ' university')}" 
         target="_blank"
         class="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors">
        View University
      </a>
      
      <button class="save-university-btn p-2 text-gray-500 hover:text-blue-600 transition-colors" 
              data-university="${universityName}">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
             d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
        </svg>
      </button>
    </div>
  </div>
  `;

        card.innerHTML = cardHTML;

        // Добавляем обработчик для кнопки сохранения
        const saveBtn = card.querySelector('.save-university-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function () {
                saveUniversity(this.dataset.university);
            });
        }

        // Запускаем анимацию появления
        setTimeout(() => {
            card.classList.remove('opacity-0');
            card.classList.remove('translate-y-4');
        }, index * 100);

        return card;
    }

    // Создание простой карточки университета (запасной вариант)
    function createSimpleUniversityCard(universityName, admissionChance) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-sm p-6 mb-4';
        card.innerHTML = `
    <h3 class="text-lg font-bold">${universityName}</h3>
    <p class="text-sm text-gray-500 mb-2">Could not load detailed information</p>
    <p class="text-sm">Admission chance: ${admissionChance || 'Unknown'}%</p>
    <a href="https://www.google.com/search?q=${encodeURIComponent(universityName + ' university')}" 
       target="_blank" class="text-blue-600 hover:underline text-sm">
       Learn more about this university
    </a>
  `;
        return card;
    }

    // Извлечение деталей университета из текста рекомендаций
    function extractUniversityDetails(text, universityName) {
        if (!text) return {
            location: '',
            programs: [],
            requirements: [],
            strengths: [],
            costs: [],
            deadlines: [],
            ranking: ''
        };

        const details = {
            location: '',
            programs: [],
            requirements: [],
            strengths: [],
            costs: [],
            deadlines: [],
            ranking: ''
        };

        const lines = text.split('\n');
        let inUniversity = false;
        let currentSection = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // Проверяем, является ли это началом секции университета
            if (line.includes(`**University: ${universityName}**`) || line.includes(`**University:${universityName}**`)) {
                inUniversity = true;
                continue;
            }

            // Проверяем, перешли ли мы к следующему университету
            if (inUniversity && line.includes('**University:') && !line.includes(universityName)) {
                break;
            }

            // Обрабатываем строку, если мы находимся в нужной секции университета
            if (inUniversity) {
                // Проверяем заголовки секций
                if (line.startsWith('**Location:**')) {
                    currentSection = 'location';
                    details.location = line.replace('**Location:**', '').trim();
                } else if (line.startsWith('**Relevant Programs:**')) {
                    currentSection = 'programs';
                } else if (line.startsWith('**Admission Requirements:**')) {
                    currentSection = 'requirements';
                } else if (line.startsWith('**Application Deadlines:**')) {
                    currentSection = 'deadlines';
                } else if (line.startsWith('**Estimated Costs:**')) {
                    currentSection = 'costs';
                } else if (line.startsWith('**Notable Strengths:**')) {
                    currentSection = 'strengths';
                } else if (line.startsWith('**QS World Ranking:**')) {
                    currentSection = 'ranking';
                    details.ranking = line.replace('**QS World Ranking:**', '').trim();
                } else if (line.startsWith('*') && line.length > 2) {
                    // Это буллет-пункт в секции
                    const content = line.substring(1).trim();
                    if (currentSection && currentSection !== 'location' && currentSection !== 'ranking') {
                        details[currentSection].push(content);
                    }
                }
            }
        }

        return details;
    }

    // Получение цветовой схемы на основе шансов поступления
    function getAdmissionChanceColorScheme(chance) {
        if (chance >= 80) {
            return {
                badge: 'bg-green-100 text-green-800',
                progressBar: 'bg-green-500',
                text: 'text-green-700'
            };
        } else if (chance >= 60) {
            return {
                badge: 'bg-blue-100 text-blue-800',
                progressBar: 'bg-blue-500',
                text: 'text-blue-700'
            };
        } else if (chance >= 40) {
            return {
                badge: 'bg-yellow-100 text-yellow-800',
                progressBar: 'bg-yellow-500',
                text: 'text-yellow-700'
            };
        } else {
            return {
                badge: 'bg-red-100 text-red-800',
                progressBar: 'bg-red-500',
                text: 'text-red-700'
            };
        }
    }

    // Получение метки для шансов поступления
    function getAdmissionMatchLabel(chance) {
        if (chance >= 80) return 'Excellent Match';
        if (chance >= 60) return 'Good Match';
        if (chance >= 40) return 'Moderate Match';
        return 'Challenging Match';
    }
    function syncProfileData() {
        if (isRecommendationsSidebarVisible()) {
            const profileData = collectProfileData();
            updateRecommendationSidebar(profileData);
        }
    }

    // Сохранение университета в избранное
    function saveUniversity(universityName) {
        try {
            // Проверяем доступность localStorage
            if (!window.localStorage) {
                showNotification('Your browser does not support saving favorites', 'error');
                return;
            }

            // Получаем существующие сохраненные университеты
            let savedUniversities = JSON.parse(localStorage.getItem('savedUniversities') || '[]');

            // Проверяем, не сохранен ли университет уже
            if (savedUniversities.includes(universityName)) {
                showNotification(`${universityName} is already in your favorites`);
                return;
            }

            // Добавляем университет и сохраняем
            savedUniversities.push(universityName);
            localStorage.setItem('savedUniversities', JSON.stringify(savedUniversities));

            // Обновляем иконку кнопки сохранения
            const saveBtn = document.querySelector(`.save-university-btn[data-university="${universityName}"]`);
            if (saveBtn) {
                saveBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
            d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
        </svg>
      `;
            }

            showNotification(`Added ${universityName} to favorites`);
        } catch (error) {
            console.error('Error saving university:', error);
            showNotification('Could not save university', 'error');
        }
    }

    // Отображение уведомления
    function showNotification(message, type = 'success') {
        // Удаляем существующие уведомления
        const existingToasts = document.querySelectorAll('.notification-toast');
        existingToasts.forEach(toast => toast.remove());

        // Создаем элемент уведомления
        const toast = document.createElement('div');
        toast.className = `notification-toast fixed bottom-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg 
                     ${type === 'error' ? 'bg-red-500' : 'bg-black'} text-white
                     opacity-0 transform translate-y-4 transition-all duration-300`;
        toast.textContent = message;

        // Добавляем в DOM
        document.body.appendChild(toast);

        // Запускаем анимацию появления
        setTimeout(() => {
            toast.classList.remove('opacity-0');
            toast.classList.remove('translate-y-4');
        }, 10);

        // Автоматически удаляем через 3 секунды
        setTimeout(() => {
            toast.classList.add('opacity-0');
            toast.classList.add('translate-y-4');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Открытие сайдбара рекомендаций
    function showUniversityRecommendations() {
        // Собираем актуальные данные профиля и обновляем сайдбар
        const profileData = collectProfileData();
        updateRecommendationSidebar(profileData);

        // Открываем сайдбар
        const modal = document.getElementById('universityRecommendationsModal');
        if (modal) {
            modal.classList.remove('translate-x-full');
            document.body.classList.add('overflow-hidden');
        }
    }

    // Закрытие сайдбара рекомендаций
    function closeUniversityRecommendations() {
        const modal = document.getElementById('universityRecommendationsModal');
        if (modal) {
            modal.classList.add('translate-x-full');
            document.body.classList.remove('overflow-hidden');
        }
    }

    // Загрузка сохраненных университетов
    function loadSavedUniversities() {
        if (!window.localStorage) {
            return [];
        }

        try {
            return JSON.parse(localStorage.getItem('savedUniversities') || '[]');
        } catch (error) {
            console.error('Error loading saved universities:', error);
            return [];
        }
    }

    // Отображение сохраненных университетов
    function showSavedUniversities() {
        const recommendationsList = document.getElementById('recommendationsList');
        if (!recommendationsList) return;

        // Очищаем список
        recommendationsList.innerHTML = '';

        // Получаем сохраненные университеты
        const savedUniversities = loadSavedUniversities();

        if (savedUniversities.length === 0) {
            recommendationsList.innerHTML = `
      <div class="bg-white rounded-lg shadow-sm p-6 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-300 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
             d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
        </svg>
        <h3 class="text-lg font-medium text-gray-700 mb-2">No Saved Universities</h3>
        <p class="text-gray-500 mb-4">When you save universities, they will appear here</p>
      </div>
    `;
            return;
        }

        // Создаем карточку для каждого сохраненного университета
        savedUniversities.forEach((universityName, index) => {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-sm p-4 mb-4 flex justify-between items-center opacity-0 translate-y-4 transition-all duration-300';

            card.innerHTML = `
      <div>
        <h3 class="font-semibold text-lg">${universityName}</h3>
        <p class="text-sm text-gray-600">Saved University</p>
      </div>
      <div class="flex space-x-2">
        <a href="https://www.google.com/search?q=${encodeURIComponent(universityName + ' university')}" 
           target="_blank"
           class="p-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
               d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
        </a>
        <button class="p-2 text-red-500 border border-red-200 rounded-lg hover:bg-red-50 transition-colors remove-university-btn"
                data-university="${universityName}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
               d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </div>
    `;

            // Добавляем обработчик для кнопки удаления
            const removeBtn = card.querySelector('.remove-university-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function () {
                    removeFromFavorites(this.dataset.university);
                });
            }

            recommendationsList.appendChild(card);

            // Анимация появления
            setTimeout(() => {
                card.classList.remove('opacity-0');
                card.classList.remove('translate-y-4');
            }, index * 100);
        });

        // Показываем контейнер результатов
        const recommendationsContainer = document.getElementById('recommendationsContainer');
        if (recommendationsContainer) {
            recommendationsContainer.style.display = 'block';
        }

        // Скрываем другие состояния
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');

        if (loadingState) loadingState.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';
    }

    // Удаление университета из избранного
    function removeFromFavorites(universityName) {
        if (!window.localStorage) {
            return;
        }

        try {
            // Получаем существующие избранные
            const savedUniversities = JSON.parse(localStorage.getItem('savedUniversities') || '[]');

            // Удаляем университет
            const index = savedUniversities.indexOf(universityName);
            if (index !== -1) {
                savedUniversities.splice(index, 1);
                localStorage.setItem('savedUniversities', JSON.stringify(savedUniversities));

                showNotification(`Removed ${universityName} from favorites`);

                // Обновляем отображение
                showSavedUniversities();
            }
        } catch (error) {
            console.error('Error removing university:', error);
            showNotification('Could not remove university', 'error');
        }
    }

    // Настройка переключения вкладок в рекомендациях
    function setupRecommendationTabs() {
        const recommendationsTabBtn = document.getElementById('recommendationsTabBtn');
        const favoritesTabBtn = document.getElementById('favoritesTabBtn');

        if (recommendationsTabBtn && favoritesTabBtn) {
            // Показать рекомендации
            recommendationsTabBtn.addEventListener('click', function () {
                this.className = 'px-4 py-2 font-medium text-black border-b-2 border-black';
                favoritesTabBtn.className = 'px-4 py-2 font-medium text-gray-500 hover:text-black';

                // Повторно запросить рекомендации, если нужно
                getUniversityRecommendations();
            });

            // Показать избранное
            favoritesTabBtn.addEventListener('click', function () {
                this.className = 'px-4 py-2 font-medium text-black border-b-2 border-black';
                recommendationsTabBtn.className = 'px-4 py-2 font-medium text-gray-500 hover:text-black';

                showSavedUniversities();
            });
        }
    }

    // Инициализация всех обработчиков событий при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        // Привязка обработчиков к кнопкам рекомендаций
        const recommendButton = document.querySelector('button[onclick="getRecommendations()"]');
        if (recommendButton) {
            recommendButton.removeAttribute('onclick');
            recommendButton.addEventListener('click', getUniversityRecommendations);
        }

        // Привязка обработчиков для открытия/закрытия сайдбара
        const openButton = document.querySelector('button[onclick="showUniversityRecommendations()"]');
        if (openButton) {
            openButton.removeAttribute('onclick');
            openButton.addEventListener('click', showUniversityRecommendations);
        }

        const closeButton = document.querySelector('button[onclick="closeUniversityRecommendations()"]');
        if (closeButton) {
            closeButton.removeAttribute('onclick');
            closeButton.addEventListener('click', closeUniversityRecommendations);
        }

        // Обработчик изменения страны
        const countrySelect = document.getElementById('countrySelect');
        if (countrySelect) {
            countrySelect.addEventListener('change', function () {
                const findButton = document.querySelector('button[onclick="getRecommendations()"]') ||
                    document.querySelector('#find-universities-btn');

                if (findButton) {
                    findButton.disabled = !this.value;
                    findButton.classList.toggle('opacity-50', !this.value);
                }
            });
        }
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            profileForm.addEventListener('change', syncProfileData);
        }

        // Add event listener to skills update
        const saveSkillsBtn = document.querySelector('button[onclick="saveSkills(event)"]');
        if (saveSkillsBtn) {
            const originalSaveSkills = window.saveSkills;
            window.saveSkills = async function (e) {
                await originalSaveSkills(e);
                syncProfileData();
            };
        }
        // Настройка переключения вкладок
        setupRecommendationTabs();

        // Настройка обработчиков для форм
        setupFormListeners();

        console.log('University recommendation system initialized');
    });

    // Настройка слушателей для форм и полей ввода
    function setupFormListeners() {
        // Слушаем изменения в форме академического портфолио
        const academicForm = document.getElementById('academicPortfolioForm');
        if (academicForm) {
            // Обработчик для полей ввода
            const inputs = academicForm.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('change', function () {
                    // Обновляем сайдбар при изменении полей
                    const profileData = collectProfileData();
                    updateRecommendationSidebar(profileData);
                });
            });

            // Обработчик отправки формы
            academicForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Собираем данные формы
                const formData = new FormData(academicForm);
                const jsonData = {};

                // Преобразуем данные формы в JSON
                for (const [key, value] of formData.entries()) {
                    jsonData[key] = value;
                }

                // Добавляем языки и достижения
                jsonData.languages = collectLanguages();
                jsonData.achievements = collectAchievements();

                // Отправляем данные на сервер
                fetch('/update_academic_portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(jsonData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {


                            // Обновляем сайдбар рекомендаций
                            const profileData = collectProfileData();
                            updateRecommendationSidebar(profileData);
                        } else {
                            throw new Error(data.error || 'Error updating portfolio');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Something went wrong', 'error');
                    });
            });
        }

        // Слушаем изменения в основной форме профиля
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            // Обработчик для полей ввода
            const inputs = profileForm.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', function () {
                    // Обновляем сайдбар при изменении полей
                    const profileData = collectProfileData();
                    updateRecommendationSidebar(profileData);
                });
            });
        }

        // Обработчик для добавления языка
        const addLanguageBtn = document.getElementById('addLanguageBtn');
        if (addLanguageBtn) {
            addLanguageBtn.addEventListener('click', function () {
                const languagesContainer = document.getElementById('languagesContainer');
                if (!languagesContainer) return;

                // Создаем новую строку для языка
                const languageRow = document.createElement('div');
                languageRow.className = 'flex gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
                languageRow.innerHTML = `
        <input type="text" name="language_name" placeholder="Language"
            class="input input-bordered flex-1 bg-white focus:ring-2 focus:ring-black transition-all">
        <select name="language_level"
            class="select select-bordered bg-white focus:ring-2 focus:ring-black transition-all">
            <option value="A1">A1 - Beginner</option>
            <option value="A2">A2 - Elementary</option>
            <option value="B1">B1 - Intermediate</option>
            <option value="B2">B2 - Upper Intermediate</option>
            <option value="C1">C1 - Advanced</option>
            <option value="C2">C2 - Mastery</option>
        </select>
        <button type="button"
            class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        </button>
      `;

                // Добавляем обработчик для кнопки удаления
                const removeBtn = languageRow.querySelector('button');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function () {
                        languageRow.remove();
                    });
                }

                // Добавляем строку в контейнер
                languagesContainer.appendChild(languageRow);
            });
        }

        // Обработчик для добавления достижения
        const addAchievementBtn = document.getElementById('addAchievementBtn');
        if (addAchievementBtn) {
            addAchievementBtn.addEventListener('click', function () {
                const achievementsContainer = document.getElementById('achievementsContainer');
                if (!achievementsContainer) return;

                // Создаем новую строку для достижения
                const achievementRow = document.createElement('div');
                achievementRow.className = 'p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
                achievementRow.innerHTML = `
        <div class="space-y-4">
            <input type="text" name="achievement_title" placeholder="Achievement Title"
                class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
            <textarea name="achievement_description" placeholder="Description"
                class="textarea textarea-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all min-h-[100px]"></textarea>
            <div class="flex items-center justify-between">
                <input type="date" name="achievement_date"
                    class="input input-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                <button type="button"
                    class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </div>
      `;

                // Добавляем обработчик для кнопки удаления
                const removeBtn = achievementRow.querySelector('button');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function () {
                        achievementRow.remove();
                    });
                }

                // Добавляем строку в контейнер
                achievementsContainer.appendChild(achievementRow);
            });
        }
    }

    // Замена глобальных функций для использования обновленных версий
    window.getRecommendations = getUniversityRecommendations;
    window.showUniversityRecommendations = showUniversityRecommendations;
    window.closeUniversityRecommendations = closeUniversityRecommendations;
    // Извлечение университетов из текста рекомендаций
    function extractUniversities(text) {
        if (!text) return [];

        const universities = [];
        const lines = text.split('\n');

        for (const line of lines) {
            if (line.includes('**University:')) {
                const match = line.match(/\*\*University:?\s*(.*?)\*\*/);
                if (match && match[1]) {
                    universities.push(match[1].trim());
                }
            }
        }

        return universities;
    }

    // Store the current recommendation results
    // Store the current recommendation results
    let currentRecommendationResults = null;

    // Modified switchToRecommendationsTab function
    function switchToRecommendationsTab() {
        const recommendationsTabBtn = document.getElementById('recommendationsTabBtn');
        const favoritesTabBtn = document.getElementById('favoritesTabBtn');

        if (recommendationsTabBtn && favoritesTabBtn) {
            recommendationsTabBtn.className = 'px-4 py-2 font-medium text-black border-b-2 border-black';
            favoritesTabBtn.className = 'px-4 py-2 font-medium text-gray-500 hover:text-black';

            // If we have stored recommendation results, show them without making a new API call
            if (currentRecommendationResults) {
                showRecommendationsContainer();
                renderRecommendations(currentRecommendationResults);
            } else {
                // Only if we don't have existing recommendations, check if there are any rendered already
                const existingRecommendations = document.querySelector('#recommendationsList .bg-white');
                if (existingRecommendations) {
                    showRecommendationsContainer();
                } else {
                    // Only make a new request if we have nothing to show
                    getUniversityRecommendations();
                }
            }
        }
    }

    // Store recommendations when they're received
    function renderRecommendations(data) {
        console.log('Rendering recommendations:', data);

        // Store the data for future tab switches
        currentRecommendationResults = data;

        const recommendationsList = document.getElementById('recommendationsList');
        if (!recommendationsList) return;

        // Clear existing list
        recommendationsList.innerHTML = '';

        // Get universities from response
        const universities = data.universities || [];

        if (universities.length === 0) {
            recommendationsList.innerHTML = `
            <div class="bg-white rounded-lg shadow-sm p-6 text-center">
                <h3 class="text-lg font-medium text-gray-700 mb-2">No Universities Found</h3>
                <p class="text-gray-500 mb-4">Try selecting a different country or updating your profile</p>
            </div>
        `;
            return;
        }

        // Create cards for each university
        universities.forEach((universityName, index) => {
            try {
                // Get university details
                const details = extractUniversityDetails(data.recommendations, universityName);
                const admissionChance = data.admission_chances?.[universityName] || 50;
                const imageUrl = data.images?.[universityName];

                // Create card
                const card = createUniversityCard(universityName, details, imageUrl, admissionChance, index);
                recommendationsList.appendChild(card);

                // Animate admission chance progress bar
                setTimeout(() => {
                    const progressBar = card.querySelector('.progress-bar');
                    if (progressBar) progressBar.style.width = `${admissionChance}%`;
                }, (index * 100) + 300);
            } catch (error) {
                console.error(`Error rendering university ${universityName}:`, error);
                // Fallback - simple card
                recommendationsList.appendChild(createSimpleUniversityCard(universityName, data.admission_chances?.[universityName] || '?'));
            }
        });
    }

    function switchToFavoritesTab() {
        const recommendationsTabBtn = document.getElementById('recommendationsTabBtn');
        const favoritesTabBtn = document.getElementById('favoritesTabBtn');

        if (recommendationsTabBtn && favoritesTabBtn) {
            favoritesTabBtn.className = 'px-4 py-2 font-medium text-black border-b-2 border-black';
            recommendationsTabBtn.className = 'px-4 py-2 font-medium text-gray-500 hover:text-black';

            showSavedUniversities();
        }
    }

    // Переключение отображения различных контейнеров
    function showRecommendationsContainer() {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const recommendationsContainer = document.getElementById('recommendationsContainer');

        if (loadingState) loadingState.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';
        if (recommendationsContainer) recommendationsContainer.style.display = 'block';
    }

    function showLoadingState() {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const recommendationsContainer = document.getElementById('recommendationsContainer');

        if (loadingState) loadingState.style.display = 'block';
        if (emptyState) emptyState.style.display = 'none';
        if (recommendationsContainer) recommendationsContainer.style.display = 'none';
    }

    function showEmptyState() {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const recommendationsContainer = document.getElementById('recommendationsContainer');

        if (loadingState) loadingState.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
        if (recommendationsContainer) recommendationsContainer.style.display = 'none';
    }

    // Управление анимацией профиля в сайдбаре
    function toggleProfileSection() {
        const profileSection = document.getElementById('profileOverview');
        const profileToggle = document.getElementById('profileToggleIcon');

        if (profileSection && profileToggle) {
            const isVisible = profileSection.style.display !== 'none';
            profileSection.style.display = isVisible ? 'none' : 'block';
            profileToggle.classList.toggle('rotate-180', isVisible);
        }
    }

    // Добавляем обработчик для переключения раздела профиля
    document.addEventListener('DOMContentLoaded', function () {
        const profileHeader = document.getElementById('profileHeader');
        if (profileHeader) {
            profileHeader.addEventListener('click', toggleProfileSection);
        }

        // Инициализация вкладок рекомендаций, если они существуют
        const recommendationsTabBtn = document.getElementById('recommendationsTabBtn');
        const favoritesTabBtn = document.getElementById('favoritesTabBtn');

        if (recommendationsTabBtn) {
            recommendationsTabBtn.addEventListener('click', switchToRecommendationsTab);
        }

        if (favoritesTabBtn) {
            favoritesTabBtn.addEventListener('click', switchToFavoritesTab);
        }

        // Автоматическое обновление сайдбара при изменении данных формы
        const allForms = document.querySelectorAll('form');
        allForms.forEach(form => {
            form.addEventListener('input', function (e) {
                if (isRecommendationsSidebarVisible()) {
                    const profileData = collectProfileData();
                    updateRecommendationSidebar(profileData);
                }
            });
        });
    });

    // Проверка видимости сайдбара рекомендаций
    function isRecommendationsSidebarVisible() {
        const sidebar = document.getElementById('universityRecommendationsModal');
        return sidebar && !sidebar.classList.contains('translate-x-full');
    }

    // Обработка ошибок API
    function handleApiError(error, container, retryCallback) {
        console.error('API Error:', error);

        if (!container) return;

        container.innerHTML = `
    <div class="bg-white rounded-lg shadow-sm p-8 text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="text-xl font-semibold mb-2">Error</h3>
      <p class="text-gray-600 mb-4">${error.message || 'Something went wrong'}</p>
      <button id="errorRetryButton" class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800 transition-colors">
        Try Again
      </button>
    </div>
  `;

        const retryButton = container.querySelector('#errorRetryButton');
        if (retryButton && typeof retryCallback === 'function') {
            retryButton.addEventListener('click', retryCallback);
        }
    }

    // Function to update button state based on country selection
    function updateFindButton() {
        const countrySelect = document.getElementById('countrySelect');
        const findButton = document.querySelector('button[onclick="getRecommendations()"]') ||
            document.querySelector('button:contains("Find Universities")') ||
            document.querySelector('.ripple');

        if (countrySelect && findButton) {
            // If country has a value, enable the button
            if (countrySelect.value) {
                findButton.disabled = false;
                findButton.classList.remove('opacity-50', 'disabled', 'cursor-not-allowed');
                findButton.classList.add('bg-black', 'hover:bg-gray-800');
            } else {
                findButton.disabled = true;
                findButton.classList.add('opacity-50', 'cursor-not-allowed');
                findButton.classList.remove('bg-black', 'hover:bg-gray-800');
            }
        }
    }

    // Modified country change handler
    function handleCountryChange() {
        // Clear stored recommendations
        currentRecommendationResults = null;

        // Update button state
        updateFindButton();
    }


    // Modify the setupRecommendationTabs function to use our improved tab switching
    function setupRecommendationTabs() {
        const recommendationsTabBtn = document.getElementById('recommendationsTabBtn');
        const favoritesTabBtn = document.getElementById('favoritesTabBtn');

        if (recommendationsTabBtn && favoritesTabBtn) {
            // Show recommendations
            recommendationsTabBtn.addEventListener('click', function () {
                switchToRecommendationsTab();
            });

            // Show favorites
            favoritesTabBtn.addEventListener('click', function () {
                switchToFavoritesTab();
            });
        }
    }


    // Проверка наличия данных профиля и предложение заполнить недостающие данные
    function checkProfileCompleteness() {
        const profileData = collectProfileData();

        // Проверяем наличие необходимых академических данных
        const missingAcademic = [];

        if (!profileData.academic.gpa) missingAcademic.push('GPA');
        if (!profileData.academic.toeflScore && !profileData.academic.ieltsScore)
            missingAcademic.push('Language test score (TOEFL or IELTS)');

        // Проверяем наличие других важных данных
        const missingOther = [];

        if (!profileData.personal.specialty) missingOther.push('Specialty');
        if (!profileData.personal.goals) missingOther.push('Goals');
        if (!profileData.personal.skills || profileData.personal.skills.length === 0)
            missingOther.push('Skills');

        // Если данных недостаточно, показываем предупреждение
        if (missingAcademic.length > 0 || missingOther.length > 0) {
            let message = 'For better recommendations, please complete your profile:';

            if (missingAcademic.length > 0) {
                message += `\n• Academic info: ${missingAcademic.join(', ')}`;
            }

            if (missingOther.length > 0) {
                message += `\n• Other info: ${missingOther.join(', ')}`;
            }

            showRecommendationNotice(message);
            return false;
        }

        return true;
    }

    // Показать уведомление в контейнере рекомендаций
    function showRecommendationNotice(message) {
        const recommendationsList = document.getElementById('recommendationsList');
        if (!recommendationsList) return;

        const notice = document.createElement('div');
        notice.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4';
        notice.innerHTML = `
    <div class="flex">
      <div class="flex-shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm text-yellow-700 whitespace-pre-line">${message}</p>
      </div>
    </div>
  `;

        recommendationsList.insertBefore(notice, recommendationsList.firstChild);
    }

    // Генерация рандомных шансов поступления для тестовых целей
    function generateRandomAdmissionChances(universities) {
        const eliteUniversities = [
            'Harvard', 'Stanford', 'MIT', 'Oxford', 'Cambridge', 'Princeton',
            'Yale', 'Columbia', 'Caltech', 'Chicago', 'Imperial College'
        ];

        const prestigiousUniversities = [
            'UCLA', 'Berkeley', 'NYU', 'Michigan', 'Toronto', 'LSE',
            'Edinburgh', 'UCL', 'Sydney', 'Melbourne', 'ETH Zurich'
        ];

        const chances = {};

        universities.forEach(uni => {
            if (eliteUniversities.some(elite => uni.includes(elite))) {
                // Элитные университеты - низкие шансы
                chances[uni] = Math.floor(Math.random() * 15) + 25; // 25-40%
            } else if (prestigiousUniversities.some(prestige => uni.includes(prestige))) {
                // Престижные университеты - средние шансы
                chances[uni] = Math.floor(Math.random() * 20) + 40; // 40-60%
            } else {
                // Другие университеты - высокие шансы
                chances[uni] = Math.floor(Math.random() * 25) + 60; // 60-85%
            }
        });

        return chances;
    }

    // Add fallback mechanism if server doesn't return admission chances
    function ensureAdmissionChances(data) {
        if (!data.admission_chances || Object.keys(data.admission_chances).length === 0) {
            console.log('Server did not provide admission chances, generating fallbacks');
            data.admission_chances = generateRandomAdmissionChances(data.universities || []);
        }
        return data;
    }

    // This will run once the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function () {
        console.log('University recommendations module fully loaded');

        // Attach any remaining event listeners
        const profileToggle = document.getElementById('profileToggleIcon');
        if (profileToggle) {
            profileToggle.parentElement.addEventListener('click', toggleProfileSection);
        }
        const countrySelect = document.getElementById('countrySelect');
        if (countrySelect) {
            // Add event listener for country changes
            countrySelect.addEventListener('change', handleCountryChange);

            // Call immediately to set initial button state
            updateFindButton();
        }

        // Setup recommendation tabs
        setupRecommendationTabs();


        // Setup recommendation tabs
        setupRecommendationTabs();
        // Override global functions if they exist
        if (window.getRecommendations) {
            window.getRecommendations = getUniversityRecommendations;
        }

        if (window.showUniversityRecommendations) {
            window.showUniversityRecommendations = showUniversityRecommendations;
        }

        if (window.closeUniversityRecommendations) {
            window.closeUniversityRecommendations = closeUniversityRecommendations;
        }
    });
    const academicPortfolioHandler = {
        init: function () {
            this.setupFormListeners();
            this.setupLanguageManagement();
            this.setupAchievementManagement(); // This line is causing the error
        },
        // Make this part of the academicPortfolioHandler object
        setupAchievementManagement: function () {
            const addAchievementBtn = document.getElementById('addAchievementBtn');
            const achievementsContainer = document.getElementById('achievementsContainer');

            if (addAchievementBtn && achievementsContainer) {
                addAchievementBtn.addEventListener('click', () => {
                    const newAchievementRow = this.createAchievementRow();
                    achievementsContainer.appendChild(newAchievementRow);
                });

                achievementsContainer.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
            }
        },
        createAchievementRow: function () {
            const row = document.createElement('div');
            row.className = 'p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
            row.innerHTML = `
            <div class="space-y-4">
                <input type="text" name="achievement_title" placeholder="Achievement Title"
                    class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
                <textarea name="achievement_description" placeholder="Description"
                    class="textarea textarea-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all min-h-[100px]"></textarea>
                <div class="flex items-center justify-between">
                    <input type="date" name="achievement_date"
                        class="input input-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                    <button type="button"
                        class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        `;

            // Add click handler for remove button
            row.querySelector('button').addEventListener('click', () => row.remove());
            return row;
        },
    };
    // Add this right after the document is loaded
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize skills array from the DOM
        const skillsContainer = document.getElementById('skillsContainer');
        if (skillsContainer) {
            // Get skills from the UI
            window.currentSkills = Array.from(skillsContainer.querySelectorAll('span'))
                .map(span => span.textContent.trim());
        }

        console.log("Initialized skills:", window.currentSkills);

        // Call this immediately to update the sidebar if it's visible
        if (isRecommendationsSidebarVisible()) {
            const profileData = collectProfileData();
            updateRecommendationSidebar(profileData);
        }
    });








    // 2. Then add this script at the end of your JavaScript section:
    document.addEventListener('DOMContentLoaded', function () {
        // Get the country select element
        const countrySelect = document.getElementById('countrySelect');
        // Get the find universities button
        const findButton = document.querySelector('button[onclick="getRecommendations()"]') ||
            document.querySelector('.ripple') ||
            document.querySelector('button:has(svg)');

        if (countrySelect && findButton) {
            // Update button state on page load
            findButton.disabled = !countrySelect.value;
            if (countrySelect.value) {
                findButton.classList.remove('opacity-50', 'disabled', 'cursor-not-allowed');
            } else {
                findButton.classList.add('opacity-50', 'disabled', 'cursor-not-allowed');
            }

            // Add change event listener
            countrySelect.addEventListener('change', function () {
                if (this.value) {
                    findButton.disabled = false;
                    findButton.classList.remove('opacity-50', 'disabled', 'cursor-not-allowed');
                } else {
                    findButton.disabled = true;
                    findButton.classList.add('opacity-50', 'disabled', 'cursor-not-allowed');
                }
            });
        }
    });


</script>
<script>
    // Add this to your existing JavaScript or include it as a separate script
    document.addEventListener('DOMContentLoaded', function () {
        // Function to show toast notifications
        function showToast(message, type = 'success') {
            // Create toast element if it doesn't exist
            let toast = document.querySelector('.toast-notification');
            if (!toast) {
                toast = document.createElement('div');
                toast.className = 'toast-notification';
                document.body.appendChild(toast);
            }

            // Set message and type
            toast.textContent = message;
            toast.className = 'toast-notification ' + type;

            // Show the toast
            setTimeout(() => toast.classList.add('show'), 10);

            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Handle Profile Form submission
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            profileForm.addEventListener('submit', function (e) {
                e.preventDefault(); // Prevent form submission

                const formData = new FormData(this);

                fetch('{{ url_for("profile") }}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update display elements
                            if (data.user_data) {
                                const nameElement = document.getElementById('profileName');
                                if (nameElement && data.user_data.full_name) {
                                    nameElement.textContent = data.user_data.full_name;
                                }

                                // Update any other display elements you need here
                                updateProfileDisplayInfo(data.user_data);
                            }

                            showToast('Profile updated successfully');
                        } else {
                            showToast('Failed to update profile', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred', 'error');
                    });
            });
        }

        // Handle Links Form submission
        const linksForm = document.getElementById('linksForm');
        if (linksForm) {
            linksForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const titles = Array.from(this.querySelectorAll('input[name="link_titles[]"]')).map(input => input.value.trim());
                const urls = Array.from(this.querySelectorAll('input[name="link_urls[]"]')).map(input => input.value.trim());

                const links = titles.map((title, index) => ({
                    title: title,
                    url: urls[index]
                })).filter(link => link.title && link.url);

                fetch('{{ url_for("profile") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        action: 'update_links',
                        links: links
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Links updated successfully');
                        } else {
                            showToast(data.error || 'Failed to update links', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('Failed to update links', 'error');
                    });
            });
        }

        // Handle Academic Portfolio submission
        const academicForm = document.getElementById('academicPortfolioForm');
        if (academicForm) {
            academicForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const jsonData = {};

                for (const [key, value] of formData.entries()) {
                    jsonData[key] = value;
                }

                // Add additional data
                jsonData.languages = collectLanguages();
                jsonData.achievements = collectAchievements();

                fetch('/update_academic_portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(jsonData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Academic portfolio updated successfully');
                        } else {
                            showToast(data.error || 'Error updating portfolio', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('Something went wrong', 'error');
                    });
            });
        }

        // Helper function to update profile display info
        function updateProfileDisplayInfo(userData) {
            const displayInfo = document.getElementById('profileDisplayInfo');
            if (!displayInfo) return;

            // Create HTML for profile display
            let html = `<h2 class="text-2xl font-bold mb-6">Profile Information</h2><div class="space-y-4">`;

            if (userData.specialty) {
                html += `
            <div>
                <h3 class="font-medium text-gray-700">Specialty</h3>
                <p class="text-gray-900">${userData.specialty}</p>
            </div>`;
            }

            if (userData.age) {
                html += `
            <div>
                <h3 class="font-medium text-gray-700">Age</h3>
                <p class="text-gray-900">${userData.age} years</p>
            </div>`;
            }

            if (userData.goals) {
                html += `
            <div>
                <h3 class="font-medium text-gray-700">Goals</h3>
                <p class="text-gray-900">${userData.goals}</p>
            </div>`;
            }

            if (userData.bio) {
                html += `
            <div>
                <h3 class="font-medium text-gray-700">Bio</h3>
                <p class="text-gray-900">${userData.bio}</p>
            </div>`;
            }

            if (userData.skills && userData.skills.length > 0) {
                html += `
            <div>
                <h3 class="font-medium text-gray-700">Skills</h3>
                <div class="flex flex-wrap gap-2 mt-2">`;

                userData.skills.forEach(skill => {
                    html += `<span class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full">${skill}</span>`;
                });

                html += `</div></div>`;
            }

            if (userData.education) {
                html += `
            <div>
                <h3 class="font-medium text-gray-700">Education</h3>
                <p class="text-gray-900">${userData.education}</p>
            </div>`;
            }

            html += `</div>`;
            displayInfo.innerHTML = html;
        }

        // Add CSS for toast notifications
        const style = document.createElement('style');
        style.textContent = `
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #000;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        
        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast-notification.success {
            background-color: #10b981;
        }
        
        .toast-notification.error {
            background-color: #ef4444;
        }
    `;
        document.head.appendChild(style);
    });
</script>
<script>// Function to delete a certificate (should be defined globally)
    function deleteCertificate(certId) {
        if (confirm('Are you sure you want to delete this certificate?')) {
            fetch(`/delete-certificate/${certId}`, {
                method: 'DELETE',
            })
                .then(response => {
                    if (response.ok) {
                        showNotification('Certificate deleted successfully');
                        window.location.reload();
                    } else {
                        throw new Error('Failed to delete certificate');
                    }
                })
                .catch(error => {
                    showNotification('Error deleting certificate', 'error');
                    console.error('Error:', error);
                });
        }
    }

    // Function to remove a link (should be defined globally)
    function removeLink(button) {
        const linkEntry = button.closest('.link-entry');
        if (linkEntry) {
            linkEntry.remove();
        }
    }

    // Function to add a new link (should be defined globally)
    function addLink() {
        const linksContainer = document.getElementById('linksContainer');
        if (!linksContainer) return;

        const linkEntry = document.createElement('div');
        linkEntry.className = 'link-entry group p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
        linkEntry.innerHTML = `
            <div class="flex items-start gap-4">
                <div class="link-icon flex-shrink-0 mt-2">
                    <svg class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                </div>
                <div class="flex-grow space-y-3">
                    <input type="text" name="link_titles[]" placeholder="Link Title"
                        class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
                    <input type="text" name="link_urls[]" placeholder="URL"
                        class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
                </div>
                <div class="flex-shrink-0 flex items-start space-x-2">
                    <button type="button" onclick="removeLink(this)"
                        class="btn btn-ghost btn-sm p-2 hover:bg-red-50 text-red-500 transition-colors rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        `;

        linksContainer.appendChild(linkEntry);
    }

    // Function to add a new language field
    function addLanguage() {
        const languagesContainer = document.getElementById('languagesContainer');
        if (!languagesContainer) return;

        const languageRow = document.createElement('div');
        languageRow.className = 'flex gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
        languageRow.innerHTML = `
            <input type="text" name="language_name" placeholder="Language"
                class="input input-bordered flex-1 bg-white focus:ring-2 focus:ring-black transition-all">
            <select name="language_level"
                class="select select-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                <option value="A1">A1 - Beginner</option>
                <option value="A2">A2 - Elementary</option>
                <option value="B1">B1 - Intermediate</option>
                <option value="B2">B2 - Upper Intermediate</option>
                <option value="C1">C1 - Advanced</option>
                <option value="C2">C2 - Mastery</option>
            </select>
            <button type="button" onclick="removeLanguage(this)"
                class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        `;

        languagesContainer.appendChild(languageRow);
    }

    // Function to remove a language field
    function removeLanguage(button) {
        const languageRow = button.closest('div');
        if (languageRow) {
            languageRow.remove();
        }
    }

    // Function to add a new achievement
    function addAchievement() {
        const achievementsContainer = document.getElementById('achievementsContainer');
        if (!achievementsContainer) return;

        const achievementRow = document.createElement('div');
        achievementRow.className = 'p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
        achievementRow.innerHTML = `
            <div class="space-y-4">
                <input type="text" name="achievement_title" placeholder="Achievement Title"
                    class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
                <textarea name="achievement_description" placeholder="Description"
                    class="textarea textarea-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all min-h-[100px]"></textarea>
                <div class="flex items-center justify-between">
                    <input type="date" name="achievement_date"
                        class="input input-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                    <button type="button" onclick="removeAchievement(this)"
                        class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        `;

        achievementsContainer.appendChild(achievementRow);
    }

    // Function to remove an achievement
    function removeAchievement(button) {
        const achievementRow = button.closest('div.p-6');
        if (achievementRow) {
            achievementRow.remove();
        }
    }

    // Helper function to show notifications
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg ${type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'} transition-opacity duration-300`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function () {
        // Add event listener for the "Add Language" button
        const addLanguageBtn = document.getElementById('addLanguageBtn');
        if (addLanguageBtn) {
            addLanguageBtn.removeAttribute('onclick');
            addLanguageBtn.addEventListener('click', addLanguage);
        }

        // Add event listener for the "Add Achievement" button
        const addAchievementBtn = document.getElementById('addAchievementBtn');
        if (addAchievementBtn) {
            addAchievementBtn.removeAttribute('onclick');
            addAchievementBtn.addEventListener('click', addAchievement);
        }

        // Fix existing language and achievement buttons
        document.querySelectorAll('#languagesContainer button').forEach(button => {
            button.addEventListener('click', function () {
                removeLanguage(this);
            });
        });

        document.querySelectorAll('#achievementsContainer button').forEach(button => {
            button.addEventListener('click', function () {
                removeAchievement(this);
            });
        });
    });


    // Add these functions at the top of your script file or in a separate <script> tag

    // Fix 1: Properly handle certificate deletion with confirmation dialog
    function deleteCertificate(certId) {
        // Store the certificate ID 
        document.getElementById('certificateToDelete').value = certId;

        // Show the modal
        const modal = document.getElementById('deleteCertificateModal');
        if (modal) {
            modal.classList.add('modal-open');
        } else {
            // Fallback to confirm if modal doesn't exist
            if (confirm('Are you sure you want to delete this certificate?')) {
                performCertificateDelete(certId);
            }
        }
    }

    function closeDeleteCertificateModal() {
        const modal = document.getElementById('deleteCertificateModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
    }

    function performCertificateDelete(certId) {
        fetch(`/delete-certificate/${certId}`, {
            method: 'DELETE',
        })
            .then(response => {
                if (response.ok) {
                    showNotification('Certificate deleted successfully');
                    window.location.reload();
                } else {
                    throw new Error('Failed to delete certificate');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error deleting certificate', 'error');
            });
    }

    // Fix 2: Functions for link management
    function addLink() {
        const linksContainer = document.getElementById('linksContainer');
        if (!linksContainer) return;

        const linkEntry = document.createElement('div');
        linkEntry.className = 'link-entry group p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
        linkEntry.innerHTML = `
        <div class="flex items-start gap-4">
            <div class="link-icon flex-shrink-0 mt-2">
                <svg class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
            </div>
            <div class="flex-grow space-y-3">
                <input type="text" name="link_titles[]" placeholder="Link Title"
                    class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
                <input type="text" name="link_urls[]" placeholder="URL"
                    class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
            </div>
            <div class="flex-shrink-0 flex items-start space-x-2">
                <button type="button" onclick="removeLink(this)"
                    class="btn btn-ghost btn-sm p-2 hover:bg-red-50 text-red-500 transition-colors rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </div>
    `;

        linksContainer.appendChild(linkEntry);
    }

    function removeLink(button) {
        const linkEntry = button.closest('.link-entry');
        if (linkEntry) {
            linkEntry.remove();
        }
    }

    // Fix 3: Academic portfolio management functions
    function addLanguage() {
        const languagesContainer = document.getElementById('languagesContainer');
        if (!languagesContainer) return;

        const languageRow = document.createElement('div');
        languageRow.className = 'flex gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
        languageRow.innerHTML = `
        <input type="text" name="language_name" placeholder="Language"
            class="input input-bordered flex-1 bg-white focus:ring-2 focus:ring-black transition-all">
        <select name="language_level"
            class="select select-bordered bg-white focus:ring-2 focus:ring-black transition-all">
            <option value="A1">A1 - Beginner</option>
            <option value="A2">A2 - Elementary</option>
            <option value="B1">B1 - Intermediate</option>
            <option value="B2">B2 - Upper Intermediate</option>
            <option value="C1">C1 - Advanced</option>
            <option value="C2">C2 - Mastery</option>
        </select>
        <button type="button" onclick="removeLanguage(this)"
            class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        </button>
    `;

        languagesContainer.appendChild(languageRow);
    }

    function removeLanguage(button) {
        const languageRow = button.closest('div');
        if (languageRow) {
            languageRow.remove();
        }
    }

    function addAchievement() {
        const achievementsContainer = document.getElementById('achievementsContainer');
        if (!achievementsContainer) return;

        const achievementRow = document.createElement('div');
        achievementRow.className = 'p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
        achievementRow.innerHTML = `
        <div class="space-y-4">
            <input type="text" name="achievement_title" placeholder="Achievement Title"
                class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
            <textarea name="achievement_description" placeholder="Description"
                class="textarea textarea-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all min-h-[100px]"></textarea>
            <div class="flex items-center justify-between">
                <input type="date" name="achievement_date"
                    class="input input-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                <button type="button" onclick="removeAchievement(this)"
                    class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </div>
    `;

        achievementsContainer.appendChild(achievementRow);
    }

    function removeAchievement(button) {
        const achievementRow = button.closest('.p-6');
        if (achievementRow) {
            achievementRow.remove();
        }
    }

    // Fix 4: Certificate upload function
    function showUploadModal() {
        const modal = document.getElementById('uploadModal');
        if (modal) {
            modal.classList.add('modal-open');
        }
    }

    function closeUploadModal() {
        const modal = document.getElementById('uploadModal');
        if (modal) {
            modal.classList.remove('modal-open');
            const form = document.getElementById('certificateForm');
            if (form) form.reset();
            const previewContainer = document.getElementById('previewContainer');
            if (previewContainer) previewContainer.classList.add('hidden');
        }
    }

    function previewCertificate(input) {
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');

        if (!previewContainer || !imagePreview) return;

        if (input.files && input.files[0]) {
            const file = input.files[0];
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                previewContainer.classList.add('hidden');
            }
        }
    }

    // Utility function for notifications
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg ${type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'} transition-opacity duration-300`;
        notification.textContent = message;
        document.body.appendChild(notification);

        // Make notification visible
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 10);

        // Automatically remove after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Fix 5: Initialize all event listeners when the DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        // Set up the confirmation button in the delete certificate modal
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function () {
                const certId = document.getElementById('certificateToDelete').value;
                if (certId) {
                    performCertificateDelete(certId);
                    closeDeleteCertificateModal();
                }
            });
        }

        // Set up the certificate form submission
        const certificateForm = document.getElementById('certificateForm');
        if (certificateForm) {
            certificateForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData();
                const title = document.getElementById('certTitle').value;
                const fileInput = this.querySelector('input[type="file"]');

                if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                    showNotification('Please select a file', 'error');
                    return;
                }

                formData.append('title', title);
                formData.append('certificate', fileInput.files[0]);

                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Certificate uploaded successfully');
                            closeUploadModal();
                            window.location.reload();
                        } else {
                            throw new Error(data.error || 'Upload failed');
                        }
                    })
                    .catch(error => {
                        console.error('Upload error:', error);
                        showNotification('Failed to upload certificate', 'error');
                    });
            });
        }

        // Add event listeners for other buttons
        const addLanguageBtn = document.getElementById('addLanguageBtn');
        if (addLanguageBtn) {
            addLanguageBtn.addEventListener('click', addLanguage);
        }

        const addAchievementBtn = document.getElementById('addAchievementBtn');
        if (addAchievementBtn) {
            addAchievementBtn.addEventListener('click', addAchievement);
        }

        // Fix the invalid querySelector in updateFindButton
        function updateFindButton() {
            const countrySelect = document.getElementById('countrySelect');
            const findButton = document.querySelector('button[onclick="getRecommendations()"]') ||
                document.querySelector('.ripple');

            if (countrySelect && findButton) {
                findButton.disabled = !countrySelect.value;
                if (countrySelect.value) {
                    findButton.classList.remove('opacity-50', 'disabled', 'cursor-not-allowed');
                } else {
                    findButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // Get the country select element
        const countrySelect = document.getElementById('countrySelect');
        if (countrySelect) {
            // Update button state on page load
            updateFindButton();

            // Add change event listener
            countrySelect.addEventListener('change', function () {
                updateFindButton();
            });
        }
    });

    // Add these JavaScript functions at the end of your profile.html JavaScript section

    // Global variables for project management
    let currentProjectId = null;
    let projectImages = [];
    let projectCollaborators = [];
    let projectTags = [];


    // Close project modal
    function closeProjectModal() {
        document.getElementById('projectModal').classList.remove('modal-open');
    }

    // Preview project images when selected
    function previewProjectImages(input) {
        const imagesContainer = document.getElementById('imagesContainer');

        if (input.files && input.files.length > 0) {
            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];

                // Create a new reader for each file
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imagePreview = document.createElement('div');
                    imagePreview.className = 'relative group';
                    imagePreview.innerHTML = `
                    <img src="${e.target.result}" alt="Project Image" 
                        class="w-full h-32 object-cover rounded-lg">
                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <button type="button" class="p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
                            onclick="removeImagePreview(this)">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;

                    imagesContainer.appendChild(imagePreview);

                    // Store the file for later upload
                    projectImages.push({
                        file: file,
                        preview: e.target.result
                    });
                };

                reader.readAsDataURL(file);
            }
        }
    }

    // Remove image preview
    function removeImagePreview(button) {
        const previewElement = button.closest('.relative');
        const index = Array.from(previewElement.parentNode.children).indexOf(previewElement);

        if (index !== -1) {
            projectImages.splice(index, 1);
            previewElement.remove();
        }
    }

    // Add a tag to the project
    function addTag() {
        const tagInput = document.getElementById('tagInput');
        const tag = tagInput.value.trim();

        if (tag && !projectTags.includes(tag)) {
            projectTags.push(tag);
            updateTagsUI();
        }

        tagInput.value = '';
        tagInput.focus();
    }

    // Update tags UI
    function updateTagsUI() {
        const tagsContainer = document.getElementById('tagsContainer');
        tagsContainer.innerHTML = '';

        projectTags.forEach((tag, index) => {
            const tagElement = document.createElement('div');
            tagElement.className = 'px-3 py-1 bg-gray-200 text-gray-800 rounded-full flex items-center text-sm';
            tagElement.innerHTML = `
            <span>${tag}</span>
            <button type="button" class="ml-2 text-gray-500 hover:text-red-500"
                onclick="removeTag(${index})">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        `;

            tagsContainer.appendChild(tagElement);
        });
    }

    // Remove a tag
    function removeTag(index) {
        projectTags.splice(index, 1);
        updateTagsUI();
    }

    // Enhanced collaborator search and management functions

    // Search for users to add as collaborators
    // Replace the project form submission code with this updated version

    // Submit project form

    // Fix for the collaborator search function too
    function searchUsers() {
        const input = document.getElementById('collaboratorInput');
        const query = input.value.trim();
        const resultsContainer = document.getElementById('userSearchResults');

        if (!query) {
            resultsContainer.classList.add('hidden');
            return;
        }

        // Show loading state
        resultsContainer.innerHTML = `
        <div class="p-3 text-sm text-gray-500 flex items-center justify-center">
            <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Searching...
        </div>
    `;
        resultsContainer.classList.remove('hidden');

        fetch(`/search_users?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(users => {
                resultsContainer.innerHTML = '';

                if (users.length === 0) {
                    resultsContainer.innerHTML = `
                    <div class="p-3 text-sm text-gray-500">No users found</div>
                `;
                } else {
                    users.forEach(user => {
                        // Make sure each user has a user_id property
                        const userId = user.user_id || user.id;

                        // Skip users that are already collaborators
                        if (projectCollaborators.some(c => c.username === user.username)) {
                            return;
                        }

                        const userElement = document.createElement('div');
                        userElement.className = 'p-3 hover:bg-gray-50 flex items-center cursor-pointer';
                        userElement.innerHTML = `
                        <img src="${user.avatar}" alt="${user.username}" class="h-8 w-8 rounded-full mr-3">
                        <div>
                            <div class="text-sm font-medium">${user.full_name || user.username}</div>
                            <div class="text-xs text-gray-500">@${user.username}</div>
                        </div>
                    `;

                        userElement.addEventListener('click', () => {
                            addCollaborator({
                                username: user.username,
                                full_name: user.full_name || '',
                                avatar: user.avatar,
                                user_id: userId
                            });
                            resultsContainer.classList.add('hidden');
                            input.value = '';
                        });

                        resultsContainer.appendChild(userElement);
                    });
                }

                resultsContainer.classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error searching users:', error);
                resultsContainer.innerHTML = `
                <div class="p-3 text-sm text-red-500">Error searching for users</div>
            `;
            });
    }
    // Add a collaborator to the project
    function addCollaborator(user) {
        // Check if user is already a collaborator to avoid duplicates
        if (!projectCollaborators.some(c => c.username === user.username)) {
            projectCollaborators.push({
                username: user.username,
                full_name: user.full_name,
                avatar: user.avatar,
                user_id: user.user_id
            });

            updateCollaboratorsUI();
            showNotification(`Added @${user.username} as a collaborator`, 'success');
        }
    }

    // Improved collaborators UI update
    function updateCollaboratorsUI() {
        const container = document.getElementById('collaboratorsContainer');
        container.innerHTML = '';

        if (projectCollaborators.length === 0) {
            container.innerHTML = `
            <div class="text-sm text-gray-500 py-3">No collaborators added yet</div>
        `;
            return;
        }

        // Create collaborator list with animation
        projectCollaborators.forEach((collaborator, index) => {
            const element = document.createElement('div');
            element.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-2 transform transition-all duration-300';
            element.style.opacity = '0';
            element.style.transform = 'translateY(10px)';

            element.innerHTML = `
            <div class="flex items-center">
                <img src="${collaborator.avatar}" alt="${collaborator.username}" class="h-8 w-8 rounded-full mr-3">
                <div>
                    <div class="text-sm font-medium">${collaborator.full_name || collaborator.username}</div>
                    <div class="text-xs text-gray-500">@${collaborator.username}</div>
                </div>
            </div>
            <button type="button" class="text-gray-500 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-gray-100"
                onclick="removeCollaborator(${index})">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        `;

            container.appendChild(element);

            // Fade in animation
            setTimeout(() => {
                element.style.opacity = '1';
                element.style.transform = 'translateY(0)';
            }, index * 100);
        });

        // Add a small badge showing the count of collaborators
        const countBadge = document.createElement('div');
        countBadge.className = 'text-xs text-gray-500 text-right mt-2';
        countBadge.textContent = `${projectCollaborators.length} collaborator${projectCollaborators.length !== 1 ? 's' : ''}`;
        container.appendChild(countBadge);
    }

    // Remove a collaborator with confirmation
    function removeCollaborator(index) {
        const collaborator = projectCollaborators[index];

        if (confirm(`Remove ${collaborator.full_name || collaborator.username} as a collaborator?`)) {
            projectCollaborators.splice(index, 1);
            updateCollaboratorsUI();
            showNotification(`Removed @${collaborator.username} from collaborators`, 'success');
        }
    }

    // Add to the bottom of your existing project JavaScript to get the current username
    let currentUsername = '';
    document.addEventListener('DOMContentLoaded', function () {
        // Get current username from the session
        const usernameMeta = document.querySelector('meta[name="current-username"]');
        if (usernameMeta) {
            currentUsername = usernameMeta.getAttribute('content');
        }
    });

    // Remove an existing image
    function removeExistingImage(button, imageUrl) {
        const previewElement = button.closest('.relative');
        const index = Array.from(previewElement.parentNode.children).indexOf(previewElement);

        if (index !== -1) {
            projectImages.splice(index, 1);
            previewElement.remove();
        }
    }

    // Submit project form

    // Delete a project
    function deleteProject(projectId) {
        document.getElementById('projectToDelete').value = projectId;
        document.getElementById('deleteProjectModal').classList.add('modal-open');
    }

    // Close delete project modal
    function closeDeleteProjectModal() {
        document.getElementById('deleteProjectModal').classList.remove('modal-open');
    }

    // Set up the confirm delete button
    document.getElementById('confirmDeleteProjectBtn').addEventListener('click', async function () {
        const projectId = document.getElementById('projectToDelete').value;

        if (!projectId) return;

        this.disabled = true;
        this.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <span class="ml-2">Deleting...</span>`;

        try {
            const response = await fetch(`/projects/${projectId}/delete`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                showNotification('Project deleted successfully');
                closeDeleteProjectModal();

                // Reload the page
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(result.error || 'Failed to delete project');
            }
        } catch (error) {
            console.error('Error deleting project:', error);
            showNotification('Error deleting project. Please try again.', 'error');
        } finally {
            this.disabled = false;
            this.innerHTML = 'Delete';
        }
    });

    // Outside click handler for search results
    document.addEventListener('click', function (e) {
        const searchResults = document.getElementById('userSearchResults');
        const searchInput = document.getElementById('collaboratorInput');

        if (searchResults && !searchResults.contains(e.target) && e.target !== searchInput) {
            searchResults.classList.add('hidden');
        }
    });
    // Add these functions to your existing JavaScript

    // Preview thumbnail when selected
    function previewThumbnail(input) {
        const preview = document.getElementById('thumbnailPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                document.getElementById('thumbnailPreviewContainer').classList.add('border-purple-500');

                // Store the thumbnail file for later upload
                projectThumbnail = input.files[0];
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Preview header when selected
    function previewHeader(input) {
        const preview = document.getElementById('headerPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                document.getElementById('headerPreviewContainer').classList.add('border-purple-500');

                // Store the header file for later upload
                projectHeader = input.files[0];
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Global variables for project management (add these to your existing variables)
    let projectThumbnail = null;
    let projectHeader = null;

    // Update the showCreateProjectModal function
    function showCreateProjectModal() {
        document.getElementById('projectModalTitle').textContent = 'Create New Project';
        document.getElementById('projectForm').reset();
        document.getElementById('projectId').value = '';

        // Reset global variables
        currentProjectId = null;
        projectImages = [];
        projectCollaborators = [];
        projectTags = [];
        projectThumbnail = null;
        projectHeader = null;

        // Reset preview images
        document.getElementById('thumbnailPreview').src = '/static/placeholder.png';
        document.getElementById('headerPreview').src = '/static/placeholder-wide.png';
        document.getElementById('thumbnailPreviewContainer').classList.remove('border-purple-500');
        document.getElementById('headerPreviewContainer').classList.remove('border-purple-500');

        // Clear UI elements
        document.getElementById('imagesContainer').innerHTML = '';
        document.getElementById('collaboratorsContainer').innerHTML = '';
        document.getElementById('tagsContainer').innerHTML = '';

        // Show the modal
        document.getElementById('projectModal').classList.add('modal-open');
    }

    // Update the editProject function to load thumbnail and header
    function editProject(projectId) {
        // Set current project ID
        currentProjectId = projectId;
        document.getElementById('projectId').value = projectId;
        document.getElementById('projectModalTitle').textContent = 'Edit Project';

        // Reset arrays and files
        projectImages = [];
        projectCollaborators = [];
        projectTags = [];
        projectThumbnail = null;
        projectHeader = null;

        // Fetch project data
        fetch(`/projects/${projectId}`)
            .then(response => response.json())
            .then(project => {
                // Fill form fields
                document.getElementById('projectTitle').value = project.title || '';
                document.getElementById('projectDescription').value = project.description || '';
                document.getElementById('projectGithub').value = project.github_url || '';
                document.getElementById('projectUrl').value = project.project_url || '';

                // Load thumbnail if exists
                if (project.thumbnail) {
                    document.getElementById('thumbnailPreview').src = project.thumbnail;
                    document.getElementById('thumbnailPreviewContainer').classList.add('border-purple-500');
                } else {
                    document.getElementById('thumbnailPreview').src = '/static/placeholder.png';
                    document.getElementById('thumbnailPreviewContainer').classList.remove('border-purple-500');
                }

                // Load header if exists
                if (project.header_image) {
                    document.getElementById('headerPreview').src = project.header_image;
                    document.getElementById('headerPreviewContainer').classList.add('border-purple-500');
                } else {
                    document.getElementById('headerPreview').src = '/static/placeholder-wide.png';
                    document.getElementById('headerPreviewContainer').classList.remove('border-purple-500');
                }

                // Load tags
                if (project.tags && project.tags.length > 0) {
                    projectTags = [...project.tags];
                    updateTagsUI();
                }

                // Load images
                if (project.images && project.images.length > 0) {
                    const imagesContainer = document.getElementById('imagesContainer');
                    imagesContainer.innerHTML = '';

                    project.images.forEach(imageUrl => {
                        const imagePreview = document.createElement('div');
                        imagePreview.className = 'relative group';
                        imagePreview.innerHTML = `
                    <img src="${imageUrl}" alt="Project Image" 
                        class="w-full h-32 object-cover rounded-lg">
                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <button type="button" class="p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
                            onclick="removeExistingImage(this, '${imageUrl}')">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;

                        imagesContainer.appendChild(imagePreview);

                        // Store existing image URL
                        projectImages.push({
                            url: imageUrl,
                            isExisting: true
                        });
                    });
                }

                // Load collaborators
                if (project.collaborators && project.collaborators.length > 0) {
                    projectCollaborators = [...project.collaborators];
                    updateCollaboratorsUI();
                }

                // Show the modal
                document.getElementById('projectModal').classList.add('modal-open');
            })
            .catch(error => {
                console.error('Error loading project:', error);
                showNotification('Error loading project details', 'error');
            });
    }

    // Update the project form submission to include thumbnail and header
    document.getElementById('projectForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="ml-2">Saving...</span>`;

        try {
            // Create form data
            const formData = new FormData();
            formData.append('title', document.getElementById('projectTitle').value);
            formData.append('description', document.getElementById('projectDescription').value);
            formData.append('github_url', document.getElementById('projectGithub').value);
            formData.append('project_url', document.getElementById('projectUrl').value);

            // Add thumbnail and header if they exist
            if (projectThumbnail) {
                formData.append('thumbnail', projectThumbnail);
            }

            if (projectHeader) {
                formData.append('header_image', projectHeader);
            }

            // Make sure to stringify the tags and collaborators arrays
            formData.append('tags', JSON.stringify(projectTags));
            formData.append('collaborators', JSON.stringify(projectCollaborators));

            // Add project ID if editing
            if (currentProjectId) {
                formData.append('project_id', currentProjectId);
            }

            // Add new images
            let imageIndex = 0;
            projectImages.forEach(image => {
                if (image.file) {
                    // New file to upload
                    formData.append(`image_${imageIndex}`, image.file);
                    imageIndex++;
                } else if (image.url && image.isExisting) {
                    // Existing image to keep
                    formData.append('existing_images', image.url);
                }
            });

            // Upload project
            const url = currentProjectId ? `/projects/${currentProjectId}/update` : '/projects/create';
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showNotification(currentProjectId ? 'Project updated successfully' : 'Project created successfully');
                closeProjectModal();

                // Reload the page to show the new/updated project
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(result.error || 'Failed to save project');
            }
        } catch (error) {
            console.error('Error saving project:', error);
            showNotification('Error saving project. Please try again.', 'error');
        } finally {
            // Re-enable the button
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Save Project';
        }
    });

    // Add this near the top of your JavaScript in profile.html
    document.addEventListener('DOMContentLoaded', function () {
        // Set up the edit mode persistence
        setupEditModePersistence();
    });

    // Function to set up edit mode persistence
    function setupEditModePersistence() {
        const editBtn = document.getElementById('editProfileBtn');
        if (!editBtn) return;

        // Check if we should be in edit mode on page load
        const shouldBeInEditMode = localStorage.getItem('profileEditMode') === 'true';

        // The elements we need to show/hide
        const editableSections = document.querySelectorAll('.profile-editable-section');
        const displaySections = document.querySelectorAll('.profile-display-section');
        const headerContainer = document.getElementById('headerContainer');
        const floatingSaveBtn = document.getElementById('floatingSaveBtn');

        // If we should be in edit mode, trigger the edit mode
        if (shouldBeInEditMode) {
            enterEditMode();
        }

        // Update the click handler to save the state
        editBtn.addEventListener('click', function () {
            const isCurrentlyInEditMode = editBtn.textContent.includes('Cancel');

            if (!isCurrentlyInEditMode) {
                // Entering edit mode
                enterEditMode();
                localStorage.setItem('profileEditMode', 'true');
            } else {
                // Exiting edit mode
                exitEditMode();
                localStorage.setItem('profileEditMode', 'false');
            }
        });

        // Save button should exit edit mode
        if (floatingSaveBtn) {
            const originalClickHandler = floatingSaveBtn.onclick;
            floatingSaveBtn.onclick = async function (e) {
                // Call the original handler first (which handles the actual saving)
                if (originalClickHandler) {
                    await originalClickHandler.call(this, e);
                }

                // Exit edit mode after saving
                localStorage.setItem('profileEditMode', 'false');
                // Note: The page will reload, so we don't need to call exitEditMode()
            };
        }

        // Handle form submissions to exit edit mode
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function () {
                localStorage.setItem('profileEditMode', 'false');
            });
        });

        // Function to enter edit mode
        function enterEditMode() {
            // Show editable sections
            editableSections.forEach(section => {
                section.style.display = 'block';
            });

            // Hide display sections
            displaySections.forEach(section => {
                section.style.display = 'none';
            });

            // Show header container and floating save button
            if (headerContainer) {
                headerContainer.style.display = 'block';
            }
            if (floatingSaveBtn) {
                floatingSaveBtn.style.display = 'flex';
            }

            // Update button text
            editBtn.textContent = 'Cancel Editing';
            editBtn.classList.add('bg-gray-600');
            editBtn.classList.remove('bg-black');
        }

        // Function to exit edit mode
        function exitEditMode() {
            // Hide editable sections
            editableSections.forEach(section => {
                section.style.display = 'none';
            });

            // Show display sections
            displaySections.forEach(section => {
                section.style.display = 'block';
            });

            // Hide header container and floating save button
            if (headerContainer) {
                headerContainer.style.display = 'none';
            }
            if (floatingSaveBtn) {
                floatingSaveBtn.style.display = 'none';
            }

            // Update button text
            editBtn.textContent = 'Edit Profile';
            editBtn.classList.remove('bg-gray-600');
            editBtn.classList.add('bg-black');
        }
    }
    // Add this to your profile.html script section to save forms without reloading

    // Function to set up AJAX form submissions
    function setupAjaxFormSubmissions() {
        // Set up the unified save button
        const floatingSaveBtn = document.getElementById('floatingSaveBtn');
        if (floatingSaveBtn) {
            floatingSaveBtn.addEventListener('click', async function (e) {
                e.preventDefault();

                try {
                    // Show loading state
                    this.disabled = true;
                    this.innerHTML = `
                    <div class="save-btn-content">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Saving...</span>
                    </div>
                `;

                    // Save all forms without reloading
                    await Promise.all([
                        saveProfileForm(),
                        saveAcademicPortfolio(),
                        saveLinks()
                    ]);

                    showNotification('All changes saved successfully');

                    // Reset button state
                    this.disabled = false;
                    this.innerHTML = `
                    <div class="save-btn-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Save All Changes</span>
                    </div>
                `;

                    // Don't exit edit mode - remove this line to stay in edit mode
                    // localStorage.setItem('profileEditMode', 'false');

                    // Update the display sections with new data without page reload
                    updateDisplaySections();

                } catch (error) {
                    console.error('Error saving changes:', error);
                    showNotification('Error saving changes. Please try again.', 'error');

                    // Reset button state
                    this.disabled = false;
                    this.innerHTML = `
                    <div class="save-btn-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Save All Changes</span>
                    </div>
                `;
                }
            });
        }
    }

    // Function to save profile form
    async function saveProfileForm() {
        const profileForm = document.getElementById('profileForm');
        if (!profileForm) return;

        const formData = new FormData(profileForm);

        const response = await fetch('{{ url_for("profile") }}', {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || 'Failed to update profile');
        }

        return data;
    }

    // Function to save academic portfolio
    async function saveAcademicPortfolio() {
        const academicForm = document.getElementById('academicPortfolioForm');
        if (!academicForm) return;

        const academicData = {
            gpa: academicForm.querySelector('input[name="gpa"]').value,
            sat_score: academicForm.querySelector('input[name="sat_score"]').value,
            toefl_score: academicForm.querySelector('input[name="toefl_score"]').value,
            ielts_score: academicForm.querySelector('input[name="ielts_score"]').value,
            languages: collectLanguages(),
            achievements: collectAchievements()
        };

        const response = await fetch('/update_academic_portfolio', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(academicData)
        });

        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || 'Failed to update academic portfolio');
        }

        return data;
    }

    // Function to save links
    async function saveLinks() {
        const linkTitles = Array.from(document.querySelectorAll('input[name="link_titles[]"]')).map(input => input.value.trim());
        const linkUrls = Array.from(document.querySelectorAll('input[name="link_urls[]"]')).map(input => input.value.trim());

        const links = linkTitles.map((title, index) => ({
            title: title,
            url: linkUrls[index]
        })).filter(link => link.title && link.url);

        const response = await fetch('{{ url_for("profile") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                action: 'update_links',
                links: links
            })
        });

        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || 'Failed to update links');
        }

        return data;
    }

    // Function to update display sections with new data
    function updateDisplaySections() {
        // Update profile info
        updateProfileDisplayInfo();

        // Update skills display
        updateSkillsDisplay();
    }

    // Function to update profile display info
    function updateProfileDisplayInfo() {
        const profileForm = document.getElementById('profileForm');
        const displayInfo = document.getElementById('profileDisplayInfo');
        if (!profileForm || !displayInfo) return;

        // Get values from form
        const fullName = profileForm.querySelector('input[name="full_name"]').value;
        const specialty = profileForm.querySelector('input[name="specialty"]').value;
        const age = profileForm.querySelector('input[name="age"]').value;
        const goals = profileForm.querySelector('textarea[name="goals"]').value;
        const bio = profileForm.querySelector('textarea[name="bio"]').value;
        const education = profileForm.querySelector('textarea[name="education"]').value;

        // Update the profile name in the profile card too
        const profileName = document.querySelector('.gradient-text');
        if (profileName && fullName) {
            profileName.textContent = fullName;
        }

        // Create HTML for display
        let html = `<h2 class="text-2xl font-bold mb-6">Profile Information</h2><div class="space-y-4">`;

        if (specialty) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Specialty</h3>
            <p class="text-gray-900">${specialty}</p>
        </div>`;
        }

        if (age) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Age</h3>
            <p class="text-gray-900">${age} years</p>
        </div>`;
        }

        if (goals) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Goals</h3>
            <p class="text-gray-900">${goals}</p>
        </div>`;
        }

        if (bio) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Bio</h3>
            <p class="text-gray-900">${bio}</p>
        </div>`;
        }

        // Skills are updated by updateSkillsDisplay function

        if (education) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Education</h3>
            <p class="text-gray-900">${education}</p>
        </div>`;
        }

        html += `</div>`;
        displayInfo.innerHTML = html;
    }

    // Call this function when the page loads
    document.addEventListener('DOMContentLoaded', function () {
        setupAjaxFormSubmissions();
    });
    // This script combines both edit mode persistence and form handling without reload
    // Add to profile.html

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize edit mode persistence
        setupEditModePersistence();

        // Set up form submissions without reload
        setupAjaxFormSubmissions();

        // Add event listeners for avatar upload
        setupAvatarUpload();

        // Initialize academic portfolios and skills
        setupSkillsAndAcademic();
    });

    // ===== EDIT MODE PERSISTENCE =====

    function setupEditModePersistence() {
        const editBtn = document.getElementById('editProfileBtn');
        if (!editBtn) return;

        // Check if we should be in edit mode on page load
        const shouldBeInEditMode = localStorage.getItem('profileEditMode') === 'true';

        // The elements we need to show/hide
        const editableSections = document.querySelectorAll('.profile-editable-section');
        const displaySections = document.querySelectorAll('.profile-display-section');
        const headerContainer = document.getElementById('headerContainer');
        const floatingSaveBtn = document.getElementById('floatingSaveBtn');

        // If we should be in edit mode, trigger the edit mode
        if (shouldBeInEditMode) {
            enterEditMode();
        }

        // Update the click handler to save the state
        editBtn.addEventListener('click', function () {
            const isCurrentlyInEditMode = editBtn.textContent.includes('Cancel');

            if (!isCurrentlyInEditMode) {
                // Entering edit mode
                enterEditMode();
                localStorage.setItem('profileEditMode', 'true');
            } else {
                // Exiting edit mode
                exitEditMode();
                localStorage.setItem('profileEditMode', 'false');
            }
        });

        // Function to enter edit mode
        function enterEditMode() {
            // Show editable sections
            editableSections.forEach(section => {
                section.style.display = 'block';
            });

            // Hide display sections
            displaySections.forEach(section => {
                section.style.display = 'none';
            });

            // Show header container and floating save button
            if (headerContainer) {
                headerContainer.style.display = 'block';
            }
            if (floatingSaveBtn) {
                floatingSaveBtn.style.display = 'flex';
            }

            // Update button text
            editBtn.textContent = 'Cancel Editing';
            editBtn.classList.add('bg-gray-600');
            editBtn.classList.remove('bg-black');
        }

        // Function to exit edit mode
        function exitEditMode() {
            // Hide editable sections
            editableSections.forEach(section => {
                section.style.display = 'none';
            });

            // Show display sections
            displaySections.forEach(section => {
                section.style.display = 'block';
            });

            // Hide header container and floating save button
            if (headerContainer) {
                headerContainer.style.display = 'none';
            }
            if (floatingSaveBtn) {
                floatingSaveBtn.style.display = 'none';
            }

            // Update button text
            editBtn.textContent = 'Edit Profile';
            editBtn.classList.remove('bg-gray-600');
            editBtn.classList.add('bg-black');
        }
    }

    // ===== FORM SUBMISSION WITHOUT RELOAD =====

    function setupAjaxFormSubmissions() {
        const floatingSaveBtn = document.getElementById('floatingSaveBtn');
        if (floatingSaveBtn) {
            // Remove any existing click handlers
            const newBtn = floatingSaveBtn.cloneNode(true);
            floatingSaveBtn.parentNode.replaceChild(newBtn, floatingSaveBtn);

            // Add our new click handler
            newBtn.addEventListener('click', async function (e) {
                e.preventDefault();

                try {
                    // Show loading state
                    this.disabled = true;
                    this.innerHTML = `
                    <div class="save-btn-content">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Saving...</span>
                    </div>
                `;

                    // Save all forms without reloading
                    const results = await Promise.all([
                        saveProfileForm(),
                        saveAcademicPortfolio(),
                        saveLinks()
                    ]);

                    // Update the display sections with new data
                    updateDisplaySections();

                    showNotification('All changes saved successfully');

                    // Reset button state
                    this.disabled = false;
                    this.innerHTML = `
                    <div class="save-btn-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Save All Changes</span>
                    </div>
                `;

                    // Stay in edit mode - don't set localStorage
                } catch (error) {
                    console.error('Error saving changes:', error);
                    showNotification('Error saving changes. Please try again.', 'error');

                    // Reset button state
                    this.disabled = false;
                    this.innerHTML = `
                    <div class="save-btn-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Save All Changes</span>
                    </div>
                `;
                }
            });
        }
    }

    // Save profile form without reloading
    async function saveProfileForm() {
        const profileForm = document.getElementById('profileForm');
        if (!profileForm) return { success: false };

        const formData = new FormData(profileForm);

        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
    }

    // Save academic portfolio without reloading
    async function saveAcademicPortfolio() {
        const academicForm = document.getElementById('academicPortfolioForm');
        if (!academicForm) return { success: false };

        const academicData = {
            gpa: academicForm.querySelector('input[name="gpa"]')?.value || '',
            sat_score: academicForm.querySelector('input[name="sat_score"]')?.value || '',
            toefl_score: academicForm.querySelector('input[name="toefl_score"]')?.value || '',
            ielts_score: academicForm.querySelector('input[name="ielts_score"]')?.value || '',
            languages: collectLanguages(),
            achievements: collectAchievements()
        };

        const response = await fetch('/update_academic_portfolio', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(academicData)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
    }

    // Save links without reloading
    async function saveLinks() {
        const linkTitles = Array.from(document.querySelectorAll('input[name="link_titles[]"]')).map(input => input.value.trim());
        const linkUrls = Array.from(document.querySelectorAll('input[name="link_urls[]"]')).map(input => input.value.trim());

        const links = linkTitles.map((title, index) => ({
            title: title,
            url: linkUrls[index]
        })).filter(link => link.title && link.url);

        const response = await fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                action: 'update_links',
                links: links
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
    }

    // ===== HELPER FUNCTIONS =====

    // Function to update display sections after saving without reload
    function updateDisplaySections() {
        // Update profile display info
        updateProfileInfo();

        // Update skills display
        updateSkillsDisplay();
    }

    // Function to update profile info display
    function updateProfileInfo() {
        const profileForm = document.getElementById('profileForm');
        const displayInfo = document.getElementById('profileDisplayInfo');
        if (!profileForm || !displayInfo) return;

        // Get values from form
        const fullName = profileForm.querySelector('input[name="full_name"]')?.value || '';
        const specialty = profileForm.querySelector('input[name="specialty"]')?.value || '';
        const age = profileForm.querySelector('input[name="age"]')?.value || '';
        const goals = profileForm.querySelector('textarea[name="goals"]')?.value || '';
        const bio = profileForm.querySelector('textarea[name="bio"]')?.value || '';
        const education = profileForm.querySelector('textarea[name="education"]')?.value || '';

        // Update the profile name in the profile card
        const profileName = document.querySelector('.gradient-text');
        if (profileName && fullName) {
            profileName.textContent = fullName;
        }

        // Create HTML for profile display
        let html = `<h2 class="text-2xl font-bold mb-6">Profile Information</h2><div class="space-y-4">`;

        if (specialty) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Specialty</h3>
            <p class="text-gray-900">${specialty}</p>
        </div>`;
        }

        if (age) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Age</h3>
            <p class="text-gray-900">${age} years</p>
        </div>`;
        }

        if (goals) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Goals</h3>
            <p class="text-gray-900">${goals}</p>
        </div>`;
        }

        if (bio) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Bio</h3>
            <p class="text-gray-900">${bio}</p>
        </div>`;
        }

        if (currentSkills && currentSkills.length > 0) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Skills</h3>
            <div class="flex flex-wrap gap-2 mt-2">`;

            currentSkills.forEach(skill => {
                html += `
                <span class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full">
                    ${skill}
                </span>`;
            });

            html += `</div></div>`;
        }

        if (education) {
            html += `
        <div>
            <h3 class="font-medium text-gray-700">Education</h3>
            <p class="text-gray-900">${education}</p>
        </div>`;
        }

        html += `</div>`;
        displayInfo.innerHTML = html;
    }

    // Function to collect languages from form
    function collectLanguages() {
        const languages = [];
        const containers = document.querySelectorAll('#languagesContainer > div');

        containers.forEach(container => {
            const nameInput = container.querySelector('input[name="language_name"]');
            const levelSelect = container.querySelector('select[name="language_level"]');

            if (nameInput && nameInput.value.trim()) {
                languages.push({
                    name: nameInput.value.trim(),
                    level: levelSelect ? levelSelect.value : 'A1'
                });
            }
        });

        return languages;
    }

    // Function to collect achievements from form
    function collectAchievements() {
        const achievements = [];
        const containers = document.querySelectorAll('#achievementsContainer > div');

        containers.forEach(container => {
            const titleInput = container.querySelector('input[name="achievement_title"]');
            const descTextarea = container.querySelector('textarea[name="achievement_description"]');
            const dateInput = container.querySelector('input[name="achievement_date"]');

            if (titleInput && titleInput.value.trim()) {
                achievements.push({
                    title: titleInput.value.trim(),
                    description: descTextarea ? descTextarea.value : '',
                    date: dateInput ? dateInput.value : ''
                });
            }
        });

        return achievements;
    }

    // Function to handle avatar upload
    function setupAvatarUpload() {
        const avatarInput = document.querySelector('input[name="avatar"]');
        if (avatarInput) {
            avatarInput.addEventListener('change', async function (event) {
                const file = this.files[0];
                if (!file) return;

                // Preview the image immediately
                const preview = document.getElementById('avatarPreview');
                if (preview) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        preview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }

                // Upload the avatar asynchronously
                const formData = new FormData();
                formData.append('avatar', file);

                try {
                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update all instances of the avatar on the page
                        document.querySelectorAll('.avatar img').forEach(img => {
                            img.src = data.avatar_url;
                        });

                        showNotification('Avatar updated successfully');
                    } else {
                        throw new Error(data.error || 'Failed to update avatar');
                    }
                } catch (error) {
                    console.error('Error updating avatar:', error);
                    showNotification('Error updating avatar', 'error');
                }
            });
        }
    }

    // Setup skills and academic portfolio
    function setupSkillsAndAcademic() {
        // Initialize the skills editor
        const skillsEditorBtn = document.querySelector('button[onclick="showSkillsEditor()"]');
        if (skillsEditorBtn) {
            skillsEditorBtn.addEventListener('click', function (e) {
                e.preventDefault();
                showSkillsEditor();
            });
        }

        // Setup academic form functionality
        initializeAcademicPortfolio();
    }

    // Initialize academic portfolio form
    function initializeAcademicPortfolio() {
        // Add event listener to add language button
        const addLanguageBtn = document.getElementById('addLanguageBtn');
        if (addLanguageBtn) {
            addLanguageBtn.addEventListener('click', addLanguage);
        }

        // Add event listener to add achievement button
        const addAchievementBtn = document.getElementById('addAchievementBtn');
        if (addAchievementBtn) {
            addAchievementBtn.addEventListener('click', addAchievement);
        }
    }

    // Show a notification
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg ${type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'} transition-opacity duration-300`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
</script>

{% endblock %}