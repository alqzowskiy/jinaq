{% extends "base.html" %}
<!-- В начале template -->
{% block head %}
<script>
    window.userAcademicInfo = {{
        (academic_info | tojson) if academic_info else '{}' | safe
    }};
    window.userCertificates = {{
        (certificates | map(attribute = 'to_dict()') | list | tojson) if certificates else '[]' | safe
    }};
</script>
{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header Container -->
        <div class="relative w-full mb-8">
            <div
                class="relative w-full h-[400px] overflow-hidden rounded-3xl bg-gradient-to-r from-gray-100 to-gray-200 shadow-lg">
                {% if user_data.header_image %}
                <div class="absolute inset-0 bg-black/10"></div>
                <img src="{{ user_data.header_image.url }}"
                    class="w-full h-full object-cover transition-all duration-300"
                    style="object-position: {{ user_data.header_image.position or '50% 50%' }}" alt="Profile header"
                    id="headerImage">
                {% else %}
                <div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200"></div>
                {% endif %}

                {% if session.get('user_id') == user_data.uid %}
                <div class="absolute inset-0 opacity-0 hover:opacity-100 transition-all duration-300">
                    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <label class="cursor-pointer group">
                            <div
                                class="bg-white/90 px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 
                                      group-hover:bg-white transition-colors transform group-hover:scale-105 duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span class="font-medium text-gray-900">Change Header</span>
                            </div>
                            <input type="file" id="headerInput" class="hidden" accept="image/*"
                                onchange="handleHeaderUpload(this)">
                        </label>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="md:col-span-1 space-y-6">
                    <!-- Profile Card -->
                    <div
                        class="bg-white rounded-2xl shadow-sm p-8 relative transform hover:scale-[1.02] transition-transform duration-300">
                        <div class="relative group w-40 h-40 mx-auto mb-6">
                            <img id="avatarPreview" src="{{ avatar_url }}"
                                class="w-full h-full object-cover rounded-2xl shadow-md" alt="Profile picture">
                            <label
                                class="absolute inset-0 rounded-2xl bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity">
                                <span class="text-white text-sm font-medium">Change Photo</span>
                                <input type="file" name="avatar" accept="image/*" class="hidden"
                                    onchange="previewImage(this)">
                            </label>
                        </div>

                        <!-- Profile Info -->
                        <div class="text-center md:text-left space-y-4">
                            <div class="flex items-center justify-center md:justify-start gap-4">
                                <h1 class="text-3xl font-bold gradient-text">
                                    {{ user_data.full_name if user_data and user_data.full_name else 'Your Name' }}
                                </h1>
                                {% if user_data.verified %}
                                <div class="tooltip"
                                    data-tip="{{ 'Officially verified account' if user_data.verification_type == 'official' else 'Verified account' }}">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-6 w-6 text-blue-500 transition-all duration-300 transform hover:scale-110 hover:rotate-6"
                                        viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                                {% endif %}
                            </div>

                            <p class="text-gray-600 flex items-center justify-center md:justify-start gap-2">
                                @{{ user_data.username if user_data else '' }}
                                <button onclick="copyProfileLink()"
                                    class="btn btn-ghost btn-sm p-1 hover:bg-gray-100 rounded-lg"
                                    title="Copy Profile Link">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-5 w-5 text-gray-500 hover:text-black transition-colors" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                            </p>

                            <div class="flex flex-wrap justify-center md:justify-start gap-2 mt-4">
                                <span
                                    class="px-4 py-2 bg-gray-100 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors">
                                    {{ certificates|length }} Certificates
                                </span>
                                <span
                                    class="px-4 py-2 bg-gray-100 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors">
                                    Member since {{ user_data.created_at.strftime('%B %Y') if user_data and
                                    user_data.created_at else 'Recently' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Information Form -->
                    <div class="bg-white rounded-2xl shadow-sm p-8 space-y-6">
                        <h2 class="text-2xl font-bold mb-6">Profile Information</h2>
                        <form method="POST" enctype="multipart/form-data" id="profileForm" class="space-y-6">
                            <!-- Form Fields -->
                            <div class="space-y-4">
                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Full Name</label>
                                    <input type="text" name="full_name"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.full_name if user_data else '' }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Age</label>
                                    <input type="number" name="age" min="13" max="120"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.age if user_data else '' }}" placeholder="Enter your age">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Specialty</label>
                                    <input type="text" name="specialty"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.specialty if user_data else '' }}"
                                        placeholder="e.g., Computer Science, Medicine, Art">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Goals</label>
                                    <textarea name="goals"
                                        class="textarea textarea-bordered bg-gray-50 w-full min-h-[100px] focus:ring-2 focus:ring-black transition-all"
                                        placeholder="What are your academic or professional goals?">{{ user_data.goals if user_data else '' }}</textarea>
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Bio</label>
                                    <textarea name="bio"
                                        class="textarea textarea-bordered bg-gray-50 w-full min-h-[100px] focus:ring-2 focus:ring-black transition-all">{{ user_data.bio if user_data else '' }}</textarea>
                                </div>

                                <!-- Skills Section -->
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-lg font-medium text-gray-900">Skills</h3>
                                        <button onclick="showSkillsEditor()" type="button"
                                            class="text-sm text-purple-600 hover:text-purple-800 font-medium">
                                            Edit Skills
                                        </button>
                                    </div>
                                    <div class="flex flex-wrap gap-2" id="skillsContainer">
                                        {% for skill in user_data.skills %}
                                        <span
                                            class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full hover:bg-purple-100 transition-colors">
                                            {{ skill }}
                                        </span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Location Section -->
                                <div class="space-y-2">
                                    <h3 class="text-lg font-medium text-gray-900">Location</h3>
                                    {% if user_data.location %}
                                    <div class="flex items-center gap-2 text-gray-600 bg-gray-50 p-3 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span data-location class="font-medium">
                                            {{ user_data.location.city }}, {{ user_data.location.country }}
                                        </span>
                                    </div>
                                    {% else %}
                                    <div class="text-gray-500 text-sm bg-gray-50 p-3 rounded-lg">
                                        Location not available
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Education</label>
                                    <textarea name="education"
                                        class="textarea textarea-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all">{{ user_data.education if user_data else '' }}</textarea>
                                </div>

                                <button type="submit"
                                    class="btn bg-black hover:bg-gray-800 text-white w-full transform hover:scale-[1.02] transition-all duration-200">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Links & Contacts -->
                    <div class="bg-white rounded-2xl shadow-sm p-8 space-y-6">
                        <h2 class="text-2xl font-bold mb-6">Your Links & Contacts</h2>
                        <form id="linksForm" class="space-y-6">
                            <div id="linksContainer" class="space-y-4">
                                {% if user_data.links %}
                                {% for link in user_data.links %}
                                <div
                                    class="link-entry group p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200">
                                    <div class="flex items-start gap-4">
                                        <div class="link-icon flex-shrink-0 mt-2">
                                            {% if 'linkedin.com' in link.url %}
                                            <svg class="h-8 w-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.5867-2.777 7 2.476v6.759z" />
                                            </svg>
                                            {% elif 'github.com' in link.url %}
                                            <svg class="h-8 w-8 text-gray-900" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                                            </svg>
                                            {% elif 'youtube.com' in link.url or 'youtu.be' in link.url %}
                                            <svg class="h-8 w-8 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" />
                                            </svg>
                                            {% else %}
                                            <svg class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                            </svg>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow space-y-3">
                                            <input type="text" name="link_titles[]" placeholder="Link Title"
                                                class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all"
                                                value="{{ link.title }}">
                                            <input type="text" name="link_urls[]" placeholder="URL"
                                                class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all"
                                                value="{{ link.url }}">
                                        </div>
                                        <div class="flex-shrink-0 flex items-start space-x-2">
                                            <a href="{{ link.url }}" target="_blank"
                                                class="btn btn-ghost btn-sm p-2 hover:bg-purple-50 text-purple-600 transition-colors rounded-lg">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                                </svg>
                                            </a>
                                            <button type="button" onclick="removeLink(this)"
                                                class="btn btn-ghost btn-sm p-2 hover:bg-red-50 text-red-500 transition-colors rounded-lg">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% endif %}
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="button" onclick="addLink()"
                                    class="btn btn-ghost text-purple-600 hover:bg-purple-50 transition-colors px-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Link
                                </button>
                                <button type="submit"
                                    class="btn bg-black text-white hover:bg-gray-800 transition-colors px-6 transform hover:scale-[1.02] duration-200">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="md:col-span-2 space-y-8">
                    <!-- Certificates Section -->
                    <div class="bg-white rounded-2xl shadow-sm p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Certificates</h2>
                            <button onclick="showUploadModal()"
                                class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Add Certificate
                            </button>
                        </div>

                        {% if certificates %}
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            {% for cert_doc in certificates %}
                            {% set cert = cert_doc.to_dict() %}
                            <div
                                class="group relative bg-gray-50 rounded-xl overflow-hidden hover:shadow-md transition-all duration-300">
                                {% if cert.file_url and (cert.file_url.endswith('.jpg') or
                                cert.file_url.endswith('.jpeg') or cert.file_url.endswith('.png')) %}
                                <div class="relative h-48">
                                    <img src="{{ cert.file_url }}" alt="{{ cert.title }}"
                                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                    </div>
                                </div>
                                {% else %}
                                <div
                                    class="h-48 flex items-center justify-center bg-gray-100 group-hover:bg-gray-200 transition-colors duration-300">
                                    <svg class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                {% endif %}

                                <div class="p-6 space-y-4">
                                    <h3
                                        class="text-lg font-semibold text-gray-900 group-hover:text-black transition-colors">
                                        {{ cert.title }}
                                    </h3>
                                    {% if cert.uploaded_at %}
                                    <p class="text-sm text-gray-500">
                                        {{ cert.uploaded_at.strftime('%B %d, %Y') }}
                                    </p>
                                    {% endif %}
                                    <div class="flex justify-between items-center">
                                        <a href="{{ cert.file_url }}" target="_blank"
                                            class="btn btn-sm bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                            View Certificate
                                        </a>
                                        <button onclick="deleteCertificate('{{ cert_doc.id }}')"
                                            class="btn btn-sm btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12 bg-gray-50 rounded-xl">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="mt-4 text-lg font-medium text-gray-900">No certificates yet</h3>
                            <p class="mt-2 text-sm text-gray-500">Add your first certificate to showcase your
                                achievements</p>
                            <button onclick="showUploadModal()"
                                class="mt-6 btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                Add Certificate
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Academic Portfolio -->
                    <div class="bg-white rounded-2xl shadow-sm p-8">
                        <h2 class="text-2xl font-bold mb-8">Academic Portfolio</h2>
                        <form id="academicPortfolioForm" class="space-y-8">
                            <!-- Academic Scores -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">GPA</label>
                                    <input type="text" name="gpa" placeholder="Enter your GPA"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.gpa }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">SAT Score</label>
                                    <input type="text" name="sat_score" placeholder="Enter SAT Score"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.sat_score }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">TOEFL Score</label>
                                    <input type="text" name="toefl_score" placeholder="TOEFL Score"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.toefl_score }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">IELTS Score</label>
                                    <input type="text" name="ielts_score" placeholder="IELTS Score"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.ielts_score }}">
                                </div>
                            </div>

                            <!-- Languages Section -->
                            <div class="space-y-6">
                                <h3 class="text-xl font-semibold">Languages</h3>
                                <div id="languagesContainer" class="space-y-4">
                                    {% for language in user_data.academic_info.languages %}
                                    <div
                                        class="flex gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200">
                                        <input type="text" name="language_name" placeholder="Language"
                                            class="input input-bordered flex-1 bg-white focus:ring-2 focus:ring-black transition-all"
                                            value="{{ language.name }}">
                                        <select name="language_level"
                                            class="select select-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                                            <option value="A1" {% if language.level=='A1' %}selected{% endif %}>A1 -
                                                Beginner</option>
                                            <option value="A2" {% if language.level=='A2' %}selected{% endif %}>A2 -
                                                Elementary</option>
                                            <option value="B1" {% if language.level=='B1' %}selected{% endif %}>B1 -
                                                Intermediate</option>
                                            <option value="B2" {% if language.level=='B2' %}selected{% endif %}>B2 -
                                                Upper Intermediate</option>
                                            <option value="C1" {% if language.level=='C1' %}selected{% endif %}>C1 -
                                                Advanced</option>
                                            <option value="C2" {% if language.level=='C2' %}selected{% endif %}>C2 -
                                                Mastery</option>
                                        </select>
                                        <button type="button"
                                            class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" id="addLanguageBtn"
                                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Language
                                </button>
                            </div>

                            <!-- Achievements Section -->
                            <div class="space-y-6">
                                <h3 class="text-xl font-semibold">Achievements</h3>
                                <div id="achievementsContainer" class="space-y-4">
                                    {% for achievement in user_data.academic_info.achievements %}
                                    <div
                                        class="p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200">
                                        <div class="space-y-4">
                                            <input type="text" name="achievement_title" placeholder="Achievement Title"
                                                class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all"
                                                value="{{ achievement.title }}">
                                            <textarea name="achievement_description" placeholder="Description"
                                                class="textarea textarea-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all min-h-[100px]">{{ achievement.description }}</textarea>
                                            <div class="flex items-center justify-between">
                                                <input type="date" name="achievement_date"
                                                    class="input input-bordered bg-white focus:ring-2 focus:ring-black transition-all"
                                                    value="{{ achievement.date }}">
                                                <button type="button"
                                                    class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                        viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" id="addAchievementBtn"
                                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Achievement
                                </button>
                            </div>

                            <button type="submit"
                                class="btn bg-black hover:bg-gray-800 text-white w-full transform hover:scale-[1.02] transition-all duration-200">
                                Save Academic Portfolio
                            </button>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Upload Certificate Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-box max-w-2xl p-8 relative">
        <h3 class="text-2xl font-bold mb-6">Upload Certificate</h3>
        <form id="certificateForm" class="space-y-6">
            <div class="form-control">
                <label class="label font-medium text-gray-700">Certificate Title</label>
                <input type="text" id="certTitle" name="title"
                    class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                    required>
            </div>

            <div class="form-control">
                <label class="label font-medium text-gray-700">Certificate File</label>
                <div class="relative">
                    <input type="file" name="certificate" accept=".pdf,.jpg,.jpeg,.png"
                        class="file-input file-input-bordered w-full bg-gray-50 focus:ring-2 focus:ring-black transition-all"
                        onchange="previewCertificate(this)" required>
                </div>
            </div>

            <div id="previewContainer" class="hidden mt-4">
                <img id="imagePreview" class="max-h-48 mx-auto rounded-lg" alt="Preview">
            </div>

            <div class="flex justify-end gap-4 mt-8">
                <button type="button" onclick="closeUploadModal()"
                    class="btn btn-ghost hover:bg-gray-100 transition-colors">Cancel</button>
                <button type="submit"
                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                    Upload Certificate
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Skills Editor Modal -->
<div id="skillsModal" class="modal">
    <div class="modal-box max-w-2xl p-8">
        <h3 class="text-2xl font-bold mb-6">Edit Skills</h3>
        <div class="space-y-6">
            <div id="skillsList" class="space-y-4">
                <!-- Skills will be added here -->
            </div>
            <button type="button" onclick="addNewSkill(event)"
                class="btn btn-ghost text-purple-600 hover:bg-purple-50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Skill
            </button>
        </div>
        <div class="flex justify-end gap-4 mt-8">
            <button type="button" onclick="closeSkillsModal(event)"
                class="btn btn-ghost hover:bg-gray-100 transition-colors">Cancel</button>
            <button type="button" onclick="saveSkills(event)"
                class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Header Editor Modal -->
<div id="headerEditorModal" class="modal">
    <div class="modal-box max-w-4xl p-8 bg-white rounded-2xl shadow-2xl">
        <h3 class="text-2xl font-bold mb-6 text-gray-900">Customize Header Image</h3>

        <!-- Превью-контейнер с макетами -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="text-sm font-medium text-gray-600 mb-3">Desktop Preview</h4>
                <div class="aspect-[4/1] rounded-lg overflow-hidden relative">
                    <img id="desktopHeaderPreview" src="" class="absolute w-full h-full object-cover">
                </div>
            </div>
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="text-sm font-medium text-gray-600 mb-3">Mobile Preview</h4>
                <div class="aspect-[3/2] rounded-lg overflow-hidden relative">
                    <img id="mobileHeaderPreview" src="" class="absolute w-full h-full object-cover">
                </div>
            </div>
        </div>

        <!-- Слайдеры с улучшенным дизайном -->
        <div class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Horizontal Position
                </label>
                <input type="range" id="xPosition" min="0" max="100" value="50"
                    class="w-full h-3 bg-gray-200 rounded-full appearance-none cursor-pointer">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Vertical Position
                </label>
                <input type="range" id="yPosition" min="0" max="100" value="50"
                    class="w-full h-3 bg-gray-200 rounded-full appearance-none cursor-pointer">
            </div>
        </div>

        <!-- Кнопки с современным дизайном -->
        <div class="flex justify-end space-x-4 mt-8">
            <button onclick="closeHeaderEditor()"
                class="px-6 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors">
                Cancel
            </button>
            <button onclick="saveHeaderImage()"
                class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors">
                Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Добавьте этот код в profile.html перед закрывающим тегом </body> -->

<!-- Кнопка для открытия рекомендаций -->
<button onclick="showUniversityRecommendations()"
    class="fixed right-4 top-1/2 transform -translate-y-1/2 bg-black text-white p-4 rounded-l-xl shadow-lg hover:bg-gray-800 transition-all duration-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
    </svg>
</button>



<!-- University Recommendations Sidebar -->
<div id="universityRecommendationsModal"
    class="fixed inset-y-0 right-0 w-full md:w-2/3 lg:w-1/2 xl:w-2/5 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto">
    <!-- Header with close button -->
    <div class="sticky top-0 z-10 bg-white border-b shadow-sm">
        <div class="px-6 py-4 flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold">University Recommendations</h2>
                <p class="text-sm text-gray-600">Find your perfect academic match</p>
            </div>
            <button onclick="closeUniversityRecommendations()"
                class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <div class="px-6 py-6">
        <!-- Profile Overview Section -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="p-4 border-b cursor-pointer flex justify-between items-center" id="profileHeader">
                <h3 class="font-semibold">Your Academic Profile</h3>
                <svg id="profileToggleIcon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>

            <div id="profileOverview" class="p-4">
                <!-- Академические показатели -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">GPA</div>
                        <div class="text-lg font-semibold" id="profileGpa">Not provided</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">TOEFL</div>
                        <div class="text-lg font-semibold" id="profileToefl">Not provided</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">IELTS</div>
                        <div class="text-lg font-semibold" id="profileIelts">Not provided</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">SAT</div>
                        <div class="text-lg font-semibold" id="profileSat">Not provided</div>
                    </div>
                </div>

                <!-- Добавляем раздел личной информации -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Personal Info
                    </h4>
                    <div class="bg-gray-50 p-3 rounded-lg space-y-2">
                        <div>
                            <span class="text-xs text-gray-500">Specialty:</span>
                            <span class="font-medium ml-1" id="profileSpecialty">Not specified</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Age:</span>
                            <span class="font-medium ml-1" id="profileAge">Not specified</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Education:</span>
                            <p class="text-sm text-gray-700 mt-1" id="profileEducation">No education details provided
                            </p>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Goals:</span>
                            <p class="text-sm text-gray-700 mt-1" id="profileGoals">No goals specified</p>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Bio:</span>
                            <p class="text-sm text-gray-700 mt-1" id="profileBio">No bio provided</p>
                        </div>
                    </div>
                </div>

                <!-- Навыки -->
                <div class="mb-5">
                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-700" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Skills & Expertise
                    </h4>
                    <div class="flex flex-wrap gap-2" id="skillsBadges">
                        <span class="text-gray-500 text-sm">No skills added</span>
                    </div>
                </div>

                <!-- Сертификаты -->
                <div class="mb-3">
                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-700" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        Certificates & Achievements
                    </h4>
                    <div class="space-y-2" id="certificatesList">
                        <span class="text-gray-500 text-sm">No certificates uploaded</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Country Selection and Controls -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-black" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Choose Your Study Destination
            </h3>
            <div class="flex flex-wrap items-center gap-3">
                <select id="countrySelect"
                    class="select select-bordered flex-1 py-2 px-3 bg-white rounded border border-gray-300 text-base">
                    <option value="">Select a country</option>
                    <option value="USA">United States</option>
                    <option value="UK">United Kingdom</option>
                    <option value="Canada">Canada</option>
                    <option value="Australia">Australia</option>
                    <option value="Germany">Germany</option>
                    <option value="France">France</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="Switzerland">Switzerland</option>
                    <option value="Japan">Japan</option>
                    <option value="Singapore">Singapore</option>
                    <option value="China">China</option>
                    <option value="South Korea">South Korea</option>
                    <option value="Italy">Italy</option>
                    <option value="Sweden">Sweden</option>
                    <option value="Finland">Finland</option>
                    <option value="Norway">Norway</option>
                    <option value="Spain">Spain</option>
                </select>
                <button onclick="getRecommendations()"
                    class="btn bg-black hover:bg-gray-800 text-white text-base py-2 px-4 rounded ripple disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 flex items-center gap-2"
                    disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Find Universities
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden bg-white rounded-lg shadow-sm p-8 text-center mb-6">
            <div class="flex flex-col items-center justify-center gap-3">
                <div class="w-16 h-16 border-t-4 border-b-4 border-black rounded-full animate-spin"></div>
                <div>
                    <p class="font-medium text-lg mb-1">Analyzing Your Profile...</p>
                    <p class="text-gray-500 text-sm">Finding the perfect university matches for you</p>
                </div>
                <div class="w-full max-w-md bg-gray-200 rounded-full h-2.5 mt-4 overflow-hidden">
                    <div class="bg-black h-full rounded-full animated-progress"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2">This may take a moment as we analyze multiple factors</p>
            </div>
        </div>

        <!-- Results Container with Toggle Tabs -->
        <div id="recommendationsContainer" class="hidden">
            <div id="viewToggle" class="flex border-b mb-4">
                <button id="recommendationsTabBtn" class="px-4 py-2 font-medium text-black border-b-2 border-black">
                    Recommendations
                </button>
                <button id="favoritesTabBtn" class="px-4 py-2 font-medium text-gray-500 hover:text-black">
                    Saved Universities
                </button>
            </div>

            <div id="recommendationsList" class="space-y-6">
                <!-- University cards will be dynamically inserted here -->
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="bg-white rounded-lg shadow-sm p-8 text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            <h3 class="text-xl font-medium text-gray-700 mb-2">Find Your Perfect University</h3>
            <p class="text-gray-500 text-base mb-6">Select a country and click "Find Universities" to get personalized
                recommendations based on your academic profile</p>
            <div class="flex flex-col gap-4 max-w-sm mx-auto">
                <div class="text-left">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-black text-white flex items-center justify-center mr-2">1
                        </div>
                        <span class="font-medium">Complete your profile</span>
                    </div>
                    <p class="text-sm text-gray-500 ml-10">Add your academic scores, skills and certificates</p>
                </div>
                <div class="text-left">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-black text-white flex items-center justify-center mr-2">2
                        </div>
                        <span class="font-medium">Select your desired country</span>
                    </div>
                    <p class="text-sm text-gray-500 ml-10">Choose where you want to study</p>
                </div>
                <div class="text-left">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-black text-white flex items-center justify-center mr-2">3
                        </div>
                        <span class="font-medium">Get AI-powered recommendations</span>
                    </div>
                    <p class="text-sm text-gray-500 ml-10">Receive personalized university suggestions</p>
                </div>
            </div>
        </div>

        <!-- Disclaimer & Info -->
        <div class="mt-6 text-xs text-gray-500 border-t pt-4">
            <p class="mb-2">
                <strong>How recommendations work:</strong> Our AI analyzes your academic profile and matches
                it with university requirements to find your best fit options.
            </p>
            <p>
                <strong>Disclaimer:</strong> Recommendations are based on your profile data. Always verify
                information directly with universities before making decisions.
            </p>
        </div>
    </div>
</div>

<script>

    function closeUniversityRecommendations() {
        const modal = document.getElementById('universityRecommendationsModal');
        if (modal) modal.classList.add('translate-x-full');
    }

</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Utility Functions
        const utils = {
            debounce: function (func, delay) {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(null, args), delay);
                };
            },
            showNotification: function (message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg ${type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'} transition-opacity duration-300`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        };

        // Avatar Upload Handler
        const avatarHandler = {
            init: function () {
                const avatarInput = document.querySelector('input[name="avatar"]');
                if (avatarInput) {
                    avatarInput.addEventListener('change', this.handleUpload.bind(this));
                }
            },
            handleUpload: async function (event) {
                const file = event.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('avatar', file);

                try {
                    const response = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('avatarPreview').src = data.avatar_url;
                        const navAvatars = document.querySelectorAll('.avatar img');
                        navAvatars.forEach(avatar => {
                            avatar.src = data.avatar_url;
                        });
                        utils.showNotification('Avatar updated successfully');
                    } else {
                        utils.showNotification('Failed to update avatar', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    utils.showNotification('Error updating avatar', 'error');
                }
            }
        };

        // Academic Portfolio Handler
        const academicPortfolioHandler = {
            init: function () {
                this.setupFormListeners();
                this.setupLanguageManagement();
                this.setupAchievementManagement();
            },
            setupFormListeners: function () {
                const academicForm = document.getElementById('academicPortfolioForm');
                if (academicForm) {
                    const scoreFields = ['gpa', 'sat_score', 'toefl_score', 'ielts_score'];
                    scoreFields.forEach(field => {
                        const input = academicForm.querySelector(`[name="${field}"]`);
                        if (input) {
                            input.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                        }
                    });

                    academicForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        await academicPortfolioHandler.savePortfolio();
                    });
                }
            },
            setupLanguageManagement: function () {
                const addLanguageBtn = document.getElementById('addLanguageBtn');
                const languagesContainer = document.getElementById('languagesContainer');

                if (addLanguageBtn && languagesContainer) {
                    addLanguageBtn.addEventListener('click', () => {
                        const newLanguageRow = this.createLanguageRow();
                        languagesContainer.appendChild(newLanguageRow);
                    });

                    languagesContainer.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                }
            },


            createAchievementRow: function () {
                const row = document.createElement('div');
                row.className = 'mb-4 p-4 bg-gray-50 rounded-lg';
                row.innerHTML = `
                <input type="text" name="achievement_title" placeholder="Achievement Title" 
                    class="input input-bordered w-full mb-2">
                <textarea name="achievement_description" placeholder="Description" 
                    class="textarea textarea-bordered w-full mb-2"></textarea>
                <input type="date" name="achievement_date" 
                    class="input input-bordered">
                <button type="button" class="btn btn-ghost text-red-500 mt-2">Remove</button>
            `;
                row.querySelector('button').addEventListener('click', () => row.remove());
                return row;
            },
            collectFormData: function () {
                const academicForm = document.getElementById('academicPortfolioForm');
                const formData = {
                    gpa: academicForm.querySelector('input[name="gpa"]').value,
                    sat_score: academicForm.querySelector('input[name="sat_score"]').value,
                    toefl_score: academicForm.querySelector('input[name="toefl_score"]').value,
                    ielts_score: academicForm.querySelector('input[name="ielts_score"]').value,
                    languages: [],
                    achievements: []
                };

                document.querySelectorAll('#languagesContainer > div').forEach(row => {
                    const name = row.querySelector('input[name="language_name"]').value;
                    const level = row.querySelector('select[name="language_level"]').value;
                    if (name) formData.languages.push({ name, level });
                });

                document.querySelectorAll('#achievementsContainer > div').forEach(row => {
                    const title = row.querySelector('input[name="achievement_title"]').value;
                    const description = row.querySelector('textarea[name="achievement_description"]').value;
                    const date = row.querySelector('input[name="achievement_date"]').value;
                    if (title) formData.achievements.push({ title, description, date });
                });

                return formData;
            },
            savePortfolio: async function () {
                const formData = this.collectFormData();

                try {
                    const response = await fetch('/update_academic_portfolio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();
                    if (result.success) {
                        utils.showNotification('Academic portfolio updated successfully');
                    } else {
                        utils.showNotification(result.error || 'Error updating portfolio', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    utils.showNotification('Something went wrong', 'error');
                }
            }
        };

        // Links Management
        const linksHandler = {
            init: function () {
                this.setupLinkManagement();
                this.setupLinksSubmission();
            },
            setupLinkManagement: function () {
                const addLinkBtn = document.querySelector('[onclick="addLink()"]');
                const linksContainer = document.getElementById('linksContainer');

                if (addLinkBtn && linksContainer) {
                    addLinkBtn.addEventListener('click', () => {
                        const linkEntry = this.createLinkEntry();
                        linksContainer.appendChild(linkEntry);
                    });
                }

                // Добавляем функцию removeLink в глобальную область видимости
                window.removeLink = function (button) {
                    const linkEntry = button.closest('.link-entry');
                    if (linkEntry) {
                        linkEntry.remove();
                    }
                };
            },


            createLinkEntry: function () {
                const linkEntry = document.createElement('div');
                linkEntry.className = 'link-entry group flex items-center gap-2';
                linkEntry.innerHTML = `
                <input type="text" name="link_titles[]" placeholder="Link Title" 
                    class="input input-bordered flex-1">
                <input type="text" name="link_urls[]" placeholder="URL" 
                    class="input input-bordered flex-1">
                <button type="button" class="btn btn-ghost text-red-500">Remove</button>
            `;
                linkEntry.querySelector('button').addEventListener('click', () => linkEntry.remove());
                return linkEntry;
            },
            setupLinksSubmission: function () {
                const linksForm = document.getElementById('linksForm');
                if (linksForm) {
                    linksForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const titles = Array.from(this.querySelectorAll('input[name="link_titles[]"]')).map(input => input.value.trim());
                        const urls = Array.from(this.querySelectorAll('input[name="link_urls[]"]')).map(input => input.value.trim());

                        const links = titles.map((title, index) => ({
                            title: title,
                            url: urls[index]
                        })).filter(link => link.title && link.url);

                        try {
                            const response = await fetch('{{ url_for("profile") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify({
                                    action: 'update_links',
                                    links: links
                                })
                            });

                            const data = await response.json();
                            if (data.success) {
                                utils.showNotification('Links updated successfully');
                                location.reload();
                            } else {
                                throw new Error(data.error || 'Failed to update links');
                            }
                        } catch (error) {
                            utils.showNotification('Failed to update links', 'error');
                            console.error('Error:', error);
                        }
                    });
                }
            }
        };

        // Profile Update Handler
        const profileUpdateHandler = {
            init: function () {
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    profileForm.addEventListener('submit', this.handleSubmit.bind(this));
                }
            },
            handleSubmit: async function (e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                try {
                    const response = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        utils.showNotification('Profile updated successfully');

                        // Add this block to update skills in the sidebar
                        if (isRecommendationsSidebarVisible()) {
                            const profileData = collectProfileData();
                            updateRecommendationSidebar(profileData);
                        }

                        location.reload();
                    } else {
                        utils.showNotification('Update failed', 'error');
                    }
                } catch (error) {
                    utils.showNotification('Failed to update profile', 'error');
                }
            }
        };

        // Certificate Management
        const certificateHandler = {
            init: function () {
                this.setupCertificateUpload();
                this.setupCertificateDeletion();
            },
            setupCertificateUpload: function () {
                const certificateForm = document.getElementById('certificateForm');
                if (certificateForm) {
                    certificateForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const formData = new FormData();
                        const title = document.getElementById('certTitle').value;
                        const file = this.querySelector('input[type="file"]').files[0];

                        if (!file) {
                            utils.showNotification('Please select a file', 'error');
                            return;
                        }

                        formData.append('title', title);
                        formData.append('certificate', file);

                        try {
                            const response = await fetch(window.location.href, {
                                method: 'POST',
                                body: formData,
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });

                            const data = await response.json();
                            if (data.success) {
                                utils.showNotification('Certificate uploaded successfully');
                                closeUploadModal();
                                location.reload();
                            } else {
                                throw new Error(data.error || 'Upload failed');
                            }
                        } catch (error) {
                            console.error('Upload error:', error);
                            utils.showNotification('Failed to upload certificate', 'error');
                        }
                    });
                }
            },
            setupCertificateDeletion: function () {
                window.deleteCertificate = async function (certId) {
                    if (confirm('Are you sure you want to delete this certificate?')) {
                        try {
                            const response = await fetch(`/delete-certificate/${certId}`, {
                                method: 'DELETE',
                            });
                            if (response.ok) {
                                utils.showNotification('Certificate deleted successfully');
                                window.location.reload();
                            } else {
                                throw new Error('Failed to delete certificate');
                            }
                        } catch (error) {
                            utils.showNotification('Error deleting certificate', 'error');
                            console.error('Error:', error);
                        }
                    }
                };
            }
        };

        // Utility Functions
        window.copyProfileLink = function () {
            const profileLink = `{{ request.host_url }}{{ user_data.username }}`;
            navigator.clipboard.writeText(profileLink).then(() => {
                utils.showNotification('Profile link copied to clipboard!');
            }).catch(err => {
                utils.showNotification('Failed to copy link', 'error');
            });
        };

        window.showUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            modal.classList.add('modal-open');
        };

        window.closeUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            modal.classList.remove('modal-open');
            document.getElementById('certificateForm').reset();
            document.getElementById('previewContainer').classList.add('hidden');
        };

        window.previewCertificate = function (input) {
            const previewContainer = document.getElementById('previewContainer');
            const imagePreview = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.classList.add('hidden');
                }
            }
        };

        window.previewImage = function (input) {
            const preview = document.getElementById('avatarPreview');
            const file = input.files[0];
            const reader = new FileReader();

            reader.onloadend = function () {
                preview.src = reader.result;
            }

            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = "{{ avatar_url }}";
            }
        };

        // Initialize all handlers
        function init() {
            avatarHandler.init();
            academicPortfolioHandler.init();
            linksHandler.init();
            profileUpdateHandler.init();
            certificateHandler.init();
        }

        // Run initialization
        init();
    });
    document.addEventListener('DOMContentLoaded', function () {
        // Attach event listener to header input
        const headerInput = document.getElementById('headerInput');
        if (headerInput) {
            headerInput.addEventListener('change', function (e) {
                handleHeaderUpload(this);
            });
        } else {
            console.error('Header input element not found');
        }
    });
    let headerEditor = {
        verticalPos: 50,
        horizontalPos: 50
    };
    document.addEventListener('DOMContentLoaded', () => {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        if (xSlider && ySlider) {
            xSlider.addEventListener('input', updateHeaderPreviewPosition);
            ySlider.addEventListener('input', updateHeaderPreviewPosition);
        }
    });

    function updateHeaderPreviewPosition() {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        if (!xSlider || !ySlider) return;

        const x = xSlider.value;
        const y = ySlider.value;

        const desktopPreview = document.getElementById('desktopHeaderPreview');
        const mobilePreview = document.getElementById('mobileHeaderPreview');

        if (desktopPreview) desktopPreview.style.objectPosition = `${x}% ${y}%`;
        if (mobilePreview) mobilePreview.style.objectPosition = `${x}% ${y}%`;

        // Update stored values
        headerEditor.horizontalPos = x;
        headerEditor.verticalPos = y;
    }

    function updatePosition(x, y) {
        const preview = document.getElementById('headerPreview');
        if (preview) {
            preview.style.objectPosition = `${x}% ${y}%`;
        }
    }

    function handleHeaderUpload(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];

        // Проверка размера и типа файла
        if (file.size > 5 * 1024 * 1024) {
            alert('Размер файла должен быть меньше 5 МБ');
            return;
        }

        if (!file.type.startsWith('image/')) {
            alert('Можно загружать только изображения');
            return;
        }

        // Принудительное создание модального окна, если оно отсутствует
        let headerEditorModal = document.getElementById('headerEditorModal');
        if (!headerEditorModal) {
            headerEditorModal = document.createElement('div');
            headerEditorModal.id = 'headerEditorModal';
            headerEditorModal.className = 'modal';
            headerEditorModal.innerHTML = `
            <div class="modal-box max-w-4xl p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Desktop Preview</h4>
                        <div class="relative w-full h-[300px] bg-gray-100 rounded-xl overflow-hidden">
                            <img id="desktopHeaderPreview" src="" alt="Desktop header preview" 
                                 class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Mobile Preview</h4>
                        <div class="relative w-full h-[200px] bg-gray-100 rounded-xl overflow-hidden">
                            <img id="mobileHeaderPreview" src="" alt="Mobile header preview" 
                                 class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </div>
        `;
            document.body.appendChild(headerEditorModal);
        }

        const reader = new FileReader();

        reader.onload = function (e) {
            // Форсированное получение элементов
            const desktopPreview = document.getElementById('desktopHeaderPreview') ||
                (() => {
                    const img = document.createElement('img');
                    img.id = 'desktopHeaderPreview';
                    img.className = 'w-full h-full object-cover';
                    document.querySelector('.modal-box').appendChild(img);
                    return img;
                })();

            const mobilePreview = document.getElementById('mobileHeaderPreview') ||
                (() => {
                    const img = document.createElement('img');
                    img.id = 'mobileHeaderPreview';
                    img.className = 'w-full h-full object-cover';
                    document.querySelector('.modal-box').appendChild(img);
                    return img;
                })();

            // Принудительная установка src
            desktopPreview.src = e.target.result;
            mobilePreview.src = e.target.result;

            // Открытие модального окна
            headerEditorModal.classList.add('modal-open');

            // Сброс позиции
            const xSlider = document.getElementById('xPosition') ||
                (() => {
                    const slider = document.createElement('input');
                    slider.id = 'xPosition';
                    slider.type = 'range';
                    slider.min = '0';
                    slider.max = '100';
                    slider.value = '50';
                    document.querySelector('.modal-box').appendChild(slider);
                    return slider;
                })();

            const ySlider = document.getElementById('yPosition') ||
                (() => {
                    const slider = document.createElement('input');
                    slider.id = 'yPosition';
                    slider.type = 'range';
                    slider.min = '0';
                    slider.max = '100';
                    slider.value = '50';
                    document.querySelector('.modal-box').appendChild(slider);
                    return slider;
                })();

            xSlider.value = '50';
            ySlider.value = '50';

            // Сохранение файла
            headerEditor.file = file;
        };

        reader.readAsDataURL(file);
    }



    function saveHeaderImage() {
        if (!headerEditor.file) {
            showNotification('Please select an image', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('header_image', headerEditor.file);
        formData.append('position', `${headerEditor.horizontalPos}% ${headerEditor.verticalPos}%`);

        fetch('/update_header', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update main header image
                    const headerImage = document.getElementById('headerImage');
                    headerImage.src = data.header.url;
                    headerImage.style.objectPosition = data.header.position;

                    closeHeaderEditor();
                    showNotification('Header updated successfully');
                } else {
                    throw new Error(data.error || 'Failed to update header');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to update header image', 'error');
            });
    }





    function closeHeaderEditor() {
        document.getElementById('headerEditorModal').classList.remove('modal-open');
        currentHeaderFile = null;
    }



    let currentSkills = {{ user_data.skills| tojson | safe if user_data.skills else '[]'
    }};
    // Добавим слушатели для слайдеров
    document.addEventListener('DOMContentLoaded', () => {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        xSlider.addEventListener('input', updateHeaderPreviewPosition);
        ySlider.addEventListener('input', updateHeaderPreviewPosition);
    });
    function showSkillsEditor() {
        const modal = document.getElementById('skillsModal');
        const skillsList = document.getElementById('skillsList');
        skillsList.innerHTML = '';

        currentSkills.forEach(skill => addSkillInput(skill));
        modal.classList.add('modal-open');
    }

    // Update the addSkillInput function
    function addSkillInput(value = '') {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';

        // Create input element separately so we can set its value properly
        const input = document.createElement('input');
        input.className = 'input input-bordered flex-1';
        input.type = 'text';
        input.placeholder = 'Enter skill (e.g., Python, C++)';
        input.maxLength = 20;
        if (value) {
            input.value = value; // Only set value if one is provided
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-ghost btn-sm text-red-500 hover:bg-red-50';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            skillDiv.remove();
        });

        // Add elements to the div
        skillDiv.appendChild(input);
        skillDiv.appendChild(removeBtn);
        skillsList.appendChild(skillDiv);

        // Focus the new input
        input.focus();
    }



    async function saveSkills() {
        const skills = Array.from(document.querySelectorAll('#skillsList input'))
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                closeSkillsModal();
                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
        }
    }

    function updateSkillsDisplay() {
        const container = document.getElementById('skillsContainer');
        container.innerHTML = currentSkills.map(skill => `
        <span class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full">
            ${skill}
        </span>
    `).join('');
    }

    function closeSkillsModal() {
        document.getElementById('skillsModal').classList.remove('modal-open');
    }
    // Add this at the bottom of your existing script section, outside any existing event listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Skills Management
        const skillsModal = document.getElementById('skillsModal');
        const showSkillsEditorBtn = document.querySelector('[onclick="showSkillsEditor"]');

        if (showSkillsEditorBtn) {
            showSkillsEditorBtn.addEventListener('click', function (e) {
                e.preventDefault(); // Prevent default form submission
                showSkillsEditor();
            });
        }

        // Location Management
        function initializeLocation() {
            if (!navigator.geolocation) {
                console.log('Geolocation is not supported by this browser.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async position => {
                    try {
                        const response = await fetch('/update-location', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                coordinates: {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                }
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            const locationEl = document.querySelector('[data-location]');
                            if (locationEl) {
                                locationEl.textContent = `${data.location.city}, ${data.location.country}`;
                            }
                        }
                    } catch (error) {
                        console.error('Error updating location:', error);
                    }
                },
                error => {
                    console.log('Error getting location:', error);
                    // Fallback to IP-based location
                    fetchIPBasedLocation();
                }
            );
        }

        async function fetchIPBasedLocation() {
            try {
                const response = await fetch('/get-ip-location');
                const data = await response.json();
                if (data.success) {
                    const locationEl = document.querySelector('[data-location]');
                    if (locationEl) {
                        locationEl.textContent = `${data.location.city}, ${data.location.country}`;
                    }
                }
            } catch (error) {
                console.error('Error fetching IP location:', error);
            }
        }

        // Initialize location on page load
        initializeLocation();
    });

    // Move the skills functions outside the DOMContentLoaded event
    function showSkillsEditor() {
        const modal = document.getElementById('skillsModal');
        const skillsList = document.getElementById('skillsList');
        if (!modal || !skillsList) return;

        skillsList.innerHTML = '';
        currentSkills.forEach(skill => addSkillInput(skill));
        modal.classList.add('modal-open');
    }

    function closeSkillsModal() {
        const modal = document.getElementById('skillsModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
    }

    function addSkillInput(value = '') {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';
        skillDiv.innerHTML = `
        <input type="text" class="input input-bordered flex-1" value="${value}" 
               placeholder="Enter skill (e.g., Python, C++)" maxlength="20">
        <button type="button" class="btn btn-ghost btn-sm text-red-500 hover:bg-red-50">
            Remove
        </button>
    `;

        skillDiv.querySelector('button').addEventListener('click', function () {
            skillDiv.remove();
        });

        skillsList.appendChild(skillDiv);
    }

    async function saveSkills() {
        const inputs = document.querySelectorAll('#skillsList input');
        const skills = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                closeSkillsModal();
                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
            console.error('Error:', error);
        }
    }

    function updateSkillsDisplay() {
        const container = document.getElementById('skillsContainer');
        if (!container) return;

        container.innerHTML = currentSkills.map(skill => `
        <span class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full">
            ${skill}
        </span>
    `).join('');
    }
    // Modify the Skills Management Event Handlers
    document.addEventListener('DOMContentLoaded', function () {
        // Update the button click handler to properly prevent form submission
        const skillsEditorBtn = document.querySelector('button[onclick="showSkillsEditor()"]');
        if (skillsEditorBtn) {
            skillsEditorBtn.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();
                const modal = document.getElementById('skillsModal');
                const skillsList = document.getElementById('skillsList');
                if (!modal || !skillsList) return;

                skillsList.innerHTML = '';
                currentSkills.forEach(skill => addSkillInput(skill));
                modal.classList.add('modal-open');
            };
        }

        // Prevent form submission when clicking inside the modal
        const skillsModal = document.getElementById('skillsModal');
        if (skillsModal) {
            skillsModal.addEventListener('click', function (e) {
                e.stopPropagation();
            });

            // Prevent modal from closing when clicking inside
            skillsModal.querySelector('.modal-box').addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }

        // Update modal close handler
        const closeModalBtn = document.querySelector('button[onclick="closeSkillsModal()"]');
        if (closeModalBtn) {
            closeModalBtn.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();
                const modal = document.getElementById('skillsModal');
                if (modal) {
                    modal.classList.remove('modal-open');
                }
            };
        }
    });

    // Modify the saveSkills function to update the sidebar
    async function saveSkills(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const inputs = document.querySelectorAll('#skillsList input');
        const skills = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                // Update the global skills array
                window.currentSkills = skills;

                // Update the display
                updateSkillsDisplay();

                // Close the modal
                closeSkillsModal();

                // Update the sidebar if it's visible
                if (isRecommendationsSidebarVisible()) {
                    const profileData = collectProfileData();
                    updateRecommendationSidebar(profileData);
                }

                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
            console.error('Error:', error);
        }
    }

    function showSkillsEditor(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        const modal = document.getElementById('skillsModal');
        const skillsList = document.getElementById('skillsList');
        if (!modal || !skillsList) return;

        // Clear existing skills
        skillsList.innerHTML = '';

        // Add current skills
        currentSkills.forEach(skill => addSkillInput(skill));

        // Show modal
        modal.classList.add('modal-open');
    }

    function addSkillInput(value = '') {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';
        skillDiv.innerHTML = `
        <input type="text" class="input input-bordered flex-1" value="${value}" 
               placeholder="Enter skill (e.g., Python, C++)" maxlength="20">
        <button type="button" class="btn btn-ghost btn-sm text-red-500 hover:bg-red-50">Remove</button>
    `;

        // Add click handler for remove button
        const removeBtn = skillDiv.querySelector('button');
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            skillDiv.remove();
        });

        skillsList.appendChild(skillDiv);
    }

    async function saveSkills(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const inputs = document.querySelectorAll('#skillsList input');
        const skills = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                closeSkillsModal();
                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
            console.error('Error:', error);
        }
    }

    function closeSkillsModal(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        const modal = document.getElementById('skillsModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
    }


    // Update the addNewSkill button handler
    function addNewSkill(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';

        // Create input element
        const input = document.createElement('input');
        input.className = 'input input-bordered flex-1';
        input.type = 'text';
        input.placeholder = 'Enter skill (e.g., Python, C++)';
        input.maxLength = 20;

        // Create remove button
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-ghost btn-sm text-red-500 hover:bg-red-50';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            skillDiv.remove();
        });

        // Add elements to the div
        skillDiv.appendChild(input);
        skillDiv.appendChild(removeBtn);
        skillsList.appendChild(skillDiv);

        // Focus the new input
        input.focus();
    }
    // Update DOMContentLoaded event handler
    // Update the DOMContentLoaded event handler
    document.addEventListener('DOMContentLoaded', function () {
        // Prevent form submission/bubbling on modal clicks
        const skillsModal = document.getElementById('skillsModal');
        if (skillsModal) {
            skillsModal.addEventListener('click', (e) => e.stopPropagation());

            const modalBox = skillsModal.querySelector('.modal-box');
            if (modalBox) {
                modalBox.addEventListener('click', (e) => e.stopPropagation());
            }
        }

        // Clean up and set single event listener for Add Skill button
        const addSkillBtn = document.querySelector('button[onclick="addNewSkill(event)"]');
        if (addSkillBtn) {
            // Remove the inline onclick attribute
            addSkillBtn.removeAttribute('onclick');
            // Add single event listener
            addSkillBtn.addEventListener('click', addNewSkill);
        }
    });

    // Header Management
    let currentHeaderFile = null;


    function updatePosition(x, y) {
        const preview = document.getElementById('headerPreview');
        if (preview) {
            preview.style.objectPosition = `${x}% ${y}%`;
        }
    }


    // Функция для отображения уведомлений
    function showNotification(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 
                    ${type === 'error' ? 'bg-red-500' : 'bg-black'} text-white
                    opacity-0 transform translate-y-4 transition-all duration-300`;
        toast.textContent = message;

        // Добавляем в DOM
        document.body.appendChild(toast);

        // Запускаем анимацию появления
        setTimeout(() => {
            toast.classList.remove('opacity-0');
            toast.classList.remove('translate-y-4');
        }, 10);

        // Автоматически удаляем через 3 секунды
        setTimeout(() => {
            toast.classList.add('opacity-0');
            toast.classList.add('translate-y-4');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function closeHeaderEditor() {
        const modal = document.getElementById('headerEditorModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
        currentHeaderFile = null;
    }

    // Position slider handlers
    document.addEventListener('DOMContentLoaded', function () {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        if (xSlider && ySlider) {
            xSlider.addEventListener('input', function () {
                updatePosition(this.value, ySlider.value);
            });

            ySlider.addEventListener('input', function () {
                updatePosition(xSlider.value, this.value);
            });
        }
    });
</script>

<script>
    /**
 * Улучшенный скрипт для рекомендаций университетов с надежной
 * синхронизацией данных профиля и обработкой ошибок
 */

    // Функция для сбора текущих данных из форм профиля
    function collectProfileData() {
        // Сбор академических данных
        const academicData = {
            gpa: document.querySelector('input[name="gpa"]')?.value || '',
            satScore: document.querySelector('input[name="sat_score"]')?.value || '',
            toeflScore: document.querySelector('input[name="toefl_score"]')?.value || '',
            ieltsScore: document.querySelector('input[name="ielts_score"]')?.value || ''
        };
        // Make sure skills are properly included
        const skills = window.currentSkills || [];
        console.log("Current skills:", skills);

        // Сбор персональных данных
        const personalData = {
            specialty: document.querySelector('input[name="specialty"]')?.value || '',
            goals: document.querySelector('textarea[name="goals"]')?.value || '',
            education: document.querySelector('textarea[name="education"]')?.value || '',
            bio: document.querySelector('textarea[name="bio"]')?.value || '',
            age: document.querySelector('input[name="age"]')?.value || '',
            skills: window.currentSkills || []
        };

        // Сбор языков
        const languages = collectLanguages();

        // Сбор достижений
        const achievements = collectAchievements();

        // Доступ к сертификатам из глобального объекта (должны быть определены в шаблоне)
        const certificates = window.userCertificates || [];

        // Add a console log to check
        console.log("Collected profile data:", {
            personal: personalData,
            skills: window.currentSkills
        });

        return {
            academic: {
                gpa: document.querySelector('input[name="gpa"]')?.value || '',
                satScore: document.querySelector('input[name="sat_score"]')?.value || '',
                toeflScore: document.querySelector('input[name="toefl_score"]')?.value || '',
                ieltsScore: document.querySelector('input[name="ielts_score"]')?.value || ''
            },
            personal: {
                specialty: document.querySelector('input[name="specialty"]')?.value || '',
                goals: document.querySelector('textarea[name="goals"]')?.value || '',
                education: document.querySelector('textarea[name="education"]')?.value || '',
                bio: document.querySelector('textarea[name="bio"]')?.value || '',
                age: document.querySelector('input[name="age"]')?.value || '',
                skills: skills  // Make sure skills are included here
            },
            languages: collectLanguages(),
            achievements: collectAchievements(),
            certificates: window.userCertificates || []
        };
    }
    function collectProfileData() {
        // Get the current skills
        const skills = window.currentSkills || [];

        return {
            academic: {
                gpa: document.querySelector('input[name="gpa"]')?.value || '',
                satScore: document.querySelector('input[name="sat_score"]')?.value || '',
                toeflScore: document.querySelector('input[name="toefl_score"]')?.value || '',
                ieltsScore: document.querySelector('input[name="ielts_score"]')?.value || ''
            },
            personal: {
                specialty: document.querySelector('input[name="specialty"]')?.value || '',
                goals: document.querySelector('textarea[name="goals"]')?.value || '',
                education: document.querySelector('textarea[name="education"]')?.value || '',
                bio: document.querySelector('textarea[name="bio"]')?.value || '',
                age: document.querySelector('input[name="age"]')?.value || '',
                skills: skills  // Use the current skills array
            },
            languages: collectLanguages(),
            achievements: collectAchievements(),
            certificates: window.userCertificates || []
        };
    }
    // Сбор данных о языках из формы
    function collectLanguages() {
        const languages = [];
        const containers = document.querySelectorAll('#languagesContainer > div');

        containers.forEach(container => {
            const nameInput = container.querySelector('input[name="language_name"]');
            const levelSelect = container.querySelector('select[name="language_level"]');

            if (nameInput && nameInput.value.trim()) {
                languages.push({
                    name: nameInput.value.trim(),
                    level: levelSelect ? levelSelect.value : 'Conversational'
                });
            }
        });

        return languages;
    }

    // Сбор данных о достижениях из формы
    function collectAchievements() {
        const achievements = [];
        const containers = document.querySelectorAll('#achievementsContainer > div');

        containers.forEach(container => {
            const titleInput = container.querySelector('input[name="achievement_title"]');
            const descTextarea = container.querySelector('textarea[name="achievement_description"]');
            const dateInput = container.querySelector('input[name="achievement_date"]');

            if (titleInput && titleInput.value.trim()) {
                achievements.push({
                    title: titleInput.value.trim(),
                    description: descTextarea ? descTextarea.value : '',
                    date: dateInput ? dateInput.value : ''
                });
            }
        });

        return achievements;
    }

    // Обновление элементов информационной панели в сайдбаре рекомендаций
    function updateRecommendationSidebar(profileData) {
        try {
            const certificatesList = document.getElementById('certificatesList');
            if (certificatesList) {
                const certificates = profileData.certificates || [];
                if (certificates && certificates.length > 0) {
                    certificatesList.innerHTML = certificates.map(cert => `
                    <div class="flex items-center gap-2 text-sm">
                        <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="truncate">${cert.title || 'Unnamed Certificate'}</span>
                    </div>
                `).join('');
                } else {
                    certificatesList.innerHTML = '<span class="text-gray-500 text-sm">Uploaded!</span>';
                }
            }
            // Debug output to check data structure
            console.log("Updating sidebar with data:", profileData);

            // Add a fallback if skills aren't in the expected place
            const skills = profileData.personal?.skills ||
                profileData.skills ||
                window.currentSkills || [];

            // Update skills display
            const skillsBadges = document.getElementById('skillsBadges');
            if (skillsBadges) {
                if (skills && skills.length > 0) {
                    skillsBadges.innerHTML = skills.map(skill =>
                        `<span class="px-2 py-1 bg-purple-50 text-purple-700 text-xs rounded-full">${skill}</span>`
                    ).join('');
                } else {
                    skillsBadges.innerHTML = '<span class="text-gray-500 text-sm">No skills added</span>';
                }
            }



            // Debug output to check data structure
            console.log("Updating sidebar with data:", profileData);






            // Обновление академических показателей
            const profileGpa = document.getElementById('profileGpa');
            if (profileGpa) profileGpa.textContent = profileData.academic.gpa || 'Not provided';

            const profileToefl = document.getElementById('profileToefl');
            if (profileToefl) profileToefl.textContent = profileData.academic.toeflScore || 'Not provided';

            const profileIelts = document.getElementById('profileIelts');
            if (profileIelts) profileIelts.textContent = profileData.academic.ieltsScore || 'Not provided';

            const profileSat = document.getElementById('profileSat');
            if (profileSat) profileSat.textContent = profileData.academic.satScore || 'Not provided';

            // Обновление личной информации
            const profileSpecialty = document.getElementById('profileSpecialty');
            if (profileSpecialty) profileSpecialty.textContent = profileData.personal.specialty || 'Not specified';

            const profileAge = document.getElementById('profileAge');
            if (profileAge) profileAge.textContent = profileData.personal.age ? `${profileData.personal.age} years old` : 'Not specified';

            const profileEducation = document.getElementById('profileEducation');
            if (profileEducation) profileEducation.textContent = profileData.personal.education || 'No education details provided';

            const profileGoals = document.getElementById('profileGoals');
            if (profileGoals) profileGoals.textContent = profileData.personal.goals || 'No goals specified';

            const profileBio = document.getElementById('profileBio');
            if (profileBio) profileBio.textContent = profileData.personal.bio || 'No bio provided';





            console.log('Sidebar updated successfully');
        } catch (error) {
            console.error('Error updating sidebar:', error);
        }
    }

    // Функция для получения рекомендаций университетов
    function getUniversityRecommendations() {
        try {
            // Проверяем, что страна выбрана
            const countrySelect = document.getElementById('countrySelect');
            if (!countrySelect || !countrySelect.value) {
                showNotification('Please select a country', 'error');
                return;
            }

            // Собираем актуальные данные профиля
            const profileData = collectProfileData();

            // Обновляем сайдбар с текущими данными
            updateRecommendationSidebar(profileData);

            // Показываем состояние загрузки
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const recommendationsContainer = document.getElementById('recommendationsContainer');

            if (loadingState) loadingState.style.display = 'block';
            if (emptyState) emptyState.style.display = 'none';
            if (recommendationsContainer) recommendationsContainer.style.display = 'none';

            // Отправляем запрос на сервер
            fetch('/get-university-recommendations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    country: countrySelect.value,
                    profile: profileData.personal,
                    academic: profileData.academic,
                    languages: profileData.languages,
                    achievements: profileData.achievements,
                    certificates: profileData.certificates
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Recommendations received:', data);

                    // Скрываем загрузку, показываем результаты
                    if (loadingState) loadingState.style.display = 'none';
                    if (recommendationsContainer) recommendationsContainer.style.display = 'block';

                    // Отображаем результаты
                    const recommendationsList = document.getElementById('recommendationsList');
                    if (recommendationsList) {
                        // Очищаем список
                        recommendationsList.innerHTML = '';

                        // Получаем университеты из ответа
                        const universities = data.universities || [];

                        if (universities.length === 0) {
                            recommendationsList.innerHTML = `
            <div class="bg-white rounded-lg shadow-sm p-6 text-center">
              <h3 class="text-lg font-medium text-gray-700 mb-2">No Universities Found</h3>
              <p class="text-gray-500 mb-4">Try selecting a different country or updating your profile</p>
            </div>
          `;
                            return;
                        }

                        // Создаем карточки для каждого университета
                        universities.forEach((universityName, index) => {
                            try {
                                // Получаем детали университета
                                const details = extractUniversityDetails(data.recommendations, universityName);
                                const admissionChance = data.admission_chances?.[universityName] || 50;
                                const imageUrl = data.images?.[universityName];

                                // Создаем карточку
                                const card = createUniversityCard(universityName, details, imageUrl, admissionChance, index);
                                recommendationsList.appendChild(card);

                                // Анимируем индикатор шансов поступления
                                setTimeout(() => {
                                    const progressBar = card.querySelector('.progress-bar');
                                    if (progressBar) progressBar.style.width = `${admissionChance}%`;
                                }, (index * 100) + 300);
                            } catch (error) {
                                console.error(`Error rendering university ${universityName}:`, error);
                                // Запасной вариант - простая карточка
                                recommendationsList.appendChild(createSimpleUniversityCard(universityName, data.admission_chances?.[universityName] || '?'));
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching recommendations:', error);

                    if (loadingState) loadingState.style.display = 'none';
                    if (emptyState) {
                        emptyState.style.display = 'block';
                        emptyState.innerHTML = `
          <div class="p-8 text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="text-xl font-semibold mb-2">Error Getting Recommendations</h3>
            <p class="text-gray-600 mb-4">${error.message || 'Unknown error occurred'}</p>
            <button id="retryButton" class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800 transition-colors">
              Try Again
            </button>
          </div>
        `;

                        // Добавляем обработчик для кнопки повтора
                        document.getElementById('retryButton')?.addEventListener('click', getUniversityRecommendations);
                    }
                });
        } catch (error) {
            console.error('Error in getUniversityRecommendations:', error);
            showNotification('An error occurred while getting recommendations', 'error');
        }
    }

    // Создание карточки университета
    function createUniversityCard(universityName, details, imageUrl, admissionChance, index) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-md overflow-hidden mb-6 transition-all duration-300 opacity-0 translate-y-4';
        card.dataset.university = universityName;

        // Определение цветовой схемы на основе шансов поступления
        const colorScheme = getAdmissionChanceColorScheme(admissionChance);
        const matchLabel = getAdmissionMatchLabel(admissionChance);

        let cardHTML = `
    <div class="relative h-48 w-full overflow-hidden">
      <img src="${imageUrl || 'https://images.unsplash.com/photo-1541339907198-e08756dedf3f'}" 
           alt="${universityName}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-105">
      <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
      <div class="absolute bottom-0 left-0 right-0 p-4">
        <h2 class="text-xl font-bold text-white">${universityName}</h2>
        <p class="text-white/80 flex items-center gap-1 text-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          ${details.location || 'Location information unavailable'}
        </p>
      </div>
    </div>
    
    <div class="p-4">
      <div class="flex justify-between items-center mb-4">
        <div class="${colorScheme.badge} px-3 py-1 rounded-full text-sm font-medium inline-flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          ${matchLabel} (${admissionChance}%)
        </div>
        ${details.ranking ? `
          <div class="bg-gray-100 rounded-lg px-2 py-1 text-xs font-medium">
            ${details.ranking}
          </div>
        ` : ''}
      </div>
      
      <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-4">
        <div class="${colorScheme.progressBar} h-full transition-all duration-1000 progress-bar" style="width: 0%"></div>
      </div>
  `;

        // Раздел программ
        if (details.programs && details.programs.length > 0) {
            cardHTML += `
      <div class="mb-4">
        <h3 class="font-medium text-gray-900 mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path d="M12 14l9-5-9-5-9 5 9 5z" />
            <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998a12.078 12.078 0 01.665-6.479L12 14z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998a12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
          </svg>
          Relevant Programs
        </h3>
        <ul class="space-y-1 text-sm">
          ${details.programs.slice(0, 3).map(program => `
            <li class="flex items-start gap-2">
              <span class="text-blue-500 mt-0.5">•</span>
              <span>${program}</span>
            </li>
          `).join('')}
          ${details.programs.length > 3 ? `
            <li class="text-xs text-gray-500 pl-4">+${details.programs.length - 3} more programs</li>
          ` : ''}
        </ul>
      </div>
    `;
        }

        // Раздел требований
        if (details.requirements && details.requirements.length > 0) {
            cardHTML += `
      <div class="mb-4">
        <h3 class="font-medium text-gray-900 mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
          Admission Requirements
        </h3>
        <ul class="space-y-1 text-sm">
          ${details.requirements.slice(0, 3).map(req => `
            <li class="flex items-start gap-2">
              <span class="text-purple-500 mt-0.5">•</span>
              <span>${req}</span>
            </li>
          `).join('')}
          ${details.requirements.length > 3 ? `
            <li class="text-xs text-gray-500 pl-4">+${details.requirements.length - 3} more requirements</li>
          ` : ''}
        </ul>
      </div>
    `;
        }

        // Раздел сроков
        if (details.deadlines && details.deadlines.length > 0) {
            cardHTML += `
      <div class="mb-4">
        <h3 class="font-medium text-gray-900 mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Application Deadlines
        </h3>
        <ul class="space-y-1 text-sm">
          ${details.deadlines.slice(0, 2).map(deadline => `
            <li class="flex items-start gap-2">
              <span class="text-red-500 mt-0.5">•</span>
              <span>${deadline}</span>
            </li>
          `).join('')}
          ${details.deadlines.length > 2 ? `
            <li class="text-xs text-gray-500 pl-4">+${details.deadlines.length - 2} more deadlines</li>
          ` : ''}
        </ul>
      </div>
    `;
        }

        // Кнопки действий
        cardHTML += `
    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
      <a href="https://www.google.com/search?q=${encodeURIComponent(universityName + ' university')}" 
         target="_blank"
         class="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors">
        View University
      </a>
      
      <button class="save-university-btn p-2 text-gray-500 hover:text-blue-600 transition-colors" 
              data-university="${universityName}">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
             d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
        </svg>
      </button>
    </div>
  </div>
  `;

        card.innerHTML = cardHTML;

        // Добавляем обработчик для кнопки сохранения
        const saveBtn = card.querySelector('.save-university-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function () {
                saveUniversity(this.dataset.university);
            });
        }

        // Запускаем анимацию появления
        setTimeout(() => {
            card.classList.remove('opacity-0');
            card.classList.remove('translate-y-4');
        }, index * 100);

        return card;
    }

    // Создание простой карточки университета (запасной вариант)
    function createSimpleUniversityCard(universityName, admissionChance) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-sm p-6 mb-4';
        card.innerHTML = `
    <h3 class="text-lg font-bold">${universityName}</h3>
    <p class="text-sm text-gray-500 mb-2">Could not load detailed information</p>
    <p class="text-sm">Admission chance: ${admissionChance || 'Unknown'}%</p>
    <a href="https://www.google.com/search?q=${encodeURIComponent(universityName + ' university')}" 
       target="_blank" class="text-blue-600 hover:underline text-sm">
       Learn more about this university
    </a>
  `;
        return card;
    }

    // Извлечение деталей университета из текста рекомендаций
    function extractUniversityDetails(text, universityName) {
        if (!text) return {
            location: '',
            programs: [],
            requirements: [],
            strengths: [],
            costs: [],
            deadlines: [],
            ranking: ''
        };

        const details = {
            location: '',
            programs: [],
            requirements: [],
            strengths: [],
            costs: [],
            deadlines: [],
            ranking: ''
        };

        const lines = text.split('\n');
        let inUniversity = false;
        let currentSection = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // Проверяем, является ли это началом секции университета
            if (line.includes(`**University: ${universityName}**`) || line.includes(`**University:${universityName}**`)) {
                inUniversity = true;
                continue;
            }

            // Проверяем, перешли ли мы к следующему университету
            if (inUniversity && line.includes('**University:') && !line.includes(universityName)) {
                break;
            }

            // Обрабатываем строку, если мы находимся в нужной секции университета
            if (inUniversity) {
                // Проверяем заголовки секций
                if (line.startsWith('**Location:**')) {
                    currentSection = 'location';
                    details.location = line.replace('**Location:**', '').trim();
                } else if (line.startsWith('**Relevant Programs:**')) {
                    currentSection = 'programs';
                } else if (line.startsWith('**Admission Requirements:**')) {
                    currentSection = 'requirements';
                } else if (line.startsWith('**Application Deadlines:**')) {
                    currentSection = 'deadlines';
                } else if (line.startsWith('**Estimated Costs:**')) {
                    currentSection = 'costs';
                } else if (line.startsWith('**Notable Strengths:**')) {
                    currentSection = 'strengths';
                } else if (line.startsWith('**QS World Ranking:**')) {
                    currentSection = 'ranking';
                    details.ranking = line.replace('**QS World Ranking:**', '').trim();
                } else if (line.startsWith('*') && line.length > 2) {
                    // Это буллет-пункт в секции
                    const content = line.substring(1).trim();
                    if (currentSection && currentSection !== 'location' && currentSection !== 'ranking') {
                        details[currentSection].push(content);
                    }
                }
            }
        }

        return details;
    }

    // Получение цветовой схемы на основе шансов поступления
    function getAdmissionChanceColorScheme(chance) {
        if (chance >= 80) {
            return {
                badge: 'bg-green-100 text-green-800',
                progressBar: 'bg-green-500',
                text: 'text-green-700'
            };
        } else if (chance >= 60) {
            return {
                badge: 'bg-blue-100 text-blue-800',
                progressBar: 'bg-blue-500',
                text: 'text-blue-700'
            };
        } else if (chance >= 40) {
            return {
                badge: 'bg-yellow-100 text-yellow-800',
                progressBar: 'bg-yellow-500',
                text: 'text-yellow-700'
            };
        } else {
            return {
                badge: 'bg-red-100 text-red-800',
                progressBar: 'bg-red-500',
                text: 'text-red-700'
            };
        }
    }

    // Получение метки для шансов поступления
    function getAdmissionMatchLabel(chance) {
        if (chance >= 80) return 'Excellent Match';
        if (chance >= 60) return 'Good Match';
        if (chance >= 40) return 'Moderate Match';
        return 'Challenging Match';
    }
    function syncProfileData() {
        if (isRecommendationsSidebarVisible()) {
            const profileData = collectProfileData();
            updateRecommendationSidebar(profileData);
        }
    }

    // Сохранение университета в избранное
    function saveUniversity(universityName) {
        try {
            // Проверяем доступность localStorage
            if (!window.localStorage) {
                showNotification('Your browser does not support saving favorites', 'error');
                return;
            }

            // Получаем существующие сохраненные университеты
            let savedUniversities = JSON.parse(localStorage.getItem('savedUniversities') || '[]');

            // Проверяем, не сохранен ли университет уже
            if (savedUniversities.includes(universityName)) {
                showNotification(`${universityName} is already in your favorites`);
                return;
            }

            // Добавляем университет и сохраняем
            savedUniversities.push(universityName);
            localStorage.setItem('savedUniversities', JSON.stringify(savedUniversities));

            // Обновляем иконку кнопки сохранения
            const saveBtn = document.querySelector(`.save-university-btn[data-university="${universityName}"]`);
            if (saveBtn) {
                saveBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
            d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
        </svg>
      `;
            }

            showNotification(`Added ${universityName} to favorites`);
        } catch (error) {
            console.error('Error saving university:', error);
            showNotification('Could not save university', 'error');
        }
    }

    // Отображение уведомления
    function showNotification(message, type = 'success') {
        // Удаляем существующие уведомления
        const existingToasts = document.querySelectorAll('.notification-toast');
        existingToasts.forEach(toast => toast.remove());

        // Создаем элемент уведомления
        const toast = document.createElement('div');
        toast.className = `notification-toast fixed bottom-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg 
                     ${type === 'error' ? 'bg-red-500' : 'bg-black'} text-white
                     opacity-0 transform translate-y-4 transition-all duration-300`;
        toast.textContent = message;

        // Добавляем в DOM
        document.body.appendChild(toast);

        // Запускаем анимацию появления
        setTimeout(() => {
            toast.classList.remove('opacity-0');
            toast.classList.remove('translate-y-4');
        }, 10);

        // Автоматически удаляем через 3 секунды
        setTimeout(() => {
            toast.classList.add('opacity-0');
            toast.classList.add('translate-y-4');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Открытие сайдбара рекомендаций
    function showUniversityRecommendations() {
        // Собираем актуальные данные профиля и обновляем сайдбар
        const profileData = collectProfileData();
        updateRecommendationSidebar(profileData);

        // Открываем сайдбар
        const modal = document.getElementById('universityRecommendationsModal');
        if (modal) {
            modal.classList.remove('translate-x-full');
            document.body.classList.add('overflow-hidden');
        }
    }

    // Закрытие сайдбара рекомендаций
    function closeUniversityRecommendations() {
        const modal = document.getElementById('universityRecommendationsModal');
        if (modal) {
            modal.classList.add('translate-x-full');
            document.body.classList.remove('overflow-hidden');
        }
    }

    // Загрузка сохраненных университетов
    function loadSavedUniversities() {
        if (!window.localStorage) {
            return [];
        }

        try {
            return JSON.parse(localStorage.getItem('savedUniversities') || '[]');
        } catch (error) {
            console.error('Error loading saved universities:', error);
            return [];
        }
    }

    // Отображение сохраненных университетов
    function showSavedUniversities() {
        const recommendationsList = document.getElementById('recommendationsList');
        if (!recommendationsList) return;

        // Очищаем список
        recommendationsList.innerHTML = '';

        // Получаем сохраненные университеты
        const savedUniversities = loadSavedUniversities();

        if (savedUniversities.length === 0) {
            recommendationsList.innerHTML = `
      <div class="bg-white rounded-lg shadow-sm p-6 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-300 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
             d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
        </svg>
        <h3 class="text-lg font-medium text-gray-700 mb-2">No Saved Universities</h3>
        <p class="text-gray-500 mb-4">When you save universities, they will appear here</p>
      </div>
    `;
            return;
        }

        // Создаем карточку для каждого сохраненного университета
        savedUniversities.forEach((universityName, index) => {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-sm p-4 mb-4 flex justify-between items-center opacity-0 translate-y-4 transition-all duration-300';

            card.innerHTML = `
      <div>
        <h3 class="font-semibold text-lg">${universityName}</h3>
        <p class="text-sm text-gray-600">Saved University</p>
      </div>
      <div class="flex space-x-2">
        <a href="https://www.google.com/search?q=${encodeURIComponent(universityName + ' university')}" 
           target="_blank"
           class="p-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
               d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
        </a>
        <button class="p-2 text-red-500 border border-red-200 rounded-lg hover:bg-red-50 transition-colors remove-university-btn"
                data-university="${universityName}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
               d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </div>
    `;

            // Добавляем обработчик для кнопки удаления
            const removeBtn = card.querySelector('.remove-university-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function () {
                    removeFromFavorites(this.dataset.university);
                });
            }

            recommendationsList.appendChild(card);

            // Анимация появления
            setTimeout(() => {
                card.classList.remove('opacity-0');
                card.classList.remove('translate-y-4');
            }, index * 100);
        });

        // Показываем контейнер результатов
        const recommendationsContainer = document.getElementById('recommendationsContainer');
        if (recommendationsContainer) {
            recommendationsContainer.style.display = 'block';
        }

        // Скрываем другие состояния
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');

        if (loadingState) loadingState.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';
    }

    // Удаление университета из избранного
    function removeFromFavorites(universityName) {
        if (!window.localStorage) {
            return;
        }

        try {
            // Получаем существующие избранные
            const savedUniversities = JSON.parse(localStorage.getItem('savedUniversities') || '[]');

            // Удаляем университет
            const index = savedUniversities.indexOf(universityName);
            if (index !== -1) {
                savedUniversities.splice(index, 1);
                localStorage.setItem('savedUniversities', JSON.stringify(savedUniversities));

                showNotification(`Removed ${universityName} from favorites`);

                // Обновляем отображение
                showSavedUniversities();
            }
        } catch (error) {
            console.error('Error removing university:', error);
            showNotification('Could not remove university', 'error');
        }
    }

    // Настройка переключения вкладок в рекомендациях
    function setupRecommendationTabs() {
        const recommendationsTabBtn = document.getElementById('recommendationsTabBtn');
        const favoritesTabBtn = document.getElementById('favoritesTabBtn');

        if (recommendationsTabBtn && favoritesTabBtn) {
            // Показать рекомендации
            recommendationsTabBtn.addEventListener('click', function () {
                this.className = 'px-4 py-2 font-medium text-black border-b-2 border-black';
                favoritesTabBtn.className = 'px-4 py-2 font-medium text-gray-500 hover:text-black';

                // Повторно запросить рекомендации, если нужно
                getUniversityRecommendations();
            });

            // Показать избранное
            favoritesTabBtn.addEventListener('click', function () {
                this.className = 'px-4 py-2 font-medium text-black border-b-2 border-black';
                recommendationsTabBtn.className = 'px-4 py-2 font-medium text-gray-500 hover:text-black';

                showSavedUniversities();
            });
        }
    }

    // Инициализация всех обработчиков событий при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        // Привязка обработчиков к кнопкам рекомендаций
        const recommendButton = document.querySelector('button[onclick="getRecommendations()"]');
        if (recommendButton) {
            recommendButton.removeAttribute('onclick');
            recommendButton.addEventListener('click', getUniversityRecommendations);
        }

        // Привязка обработчиков для открытия/закрытия сайдбара
        const openButton = document.querySelector('button[onclick="showUniversityRecommendations()"]');
        if (openButton) {
            openButton.removeAttribute('onclick');
            openButton.addEventListener('click', showUniversityRecommendations);
        }

        const closeButton = document.querySelector('button[onclick="closeUniversityRecommendations()"]');
        if (closeButton) {
            closeButton.removeAttribute('onclick');
            closeButton.addEventListener('click', closeUniversityRecommendations);
        }

        // Обработчик изменения страны
        const countrySelect = document.getElementById('countrySelect');
        if (countrySelect) {
            countrySelect.addEventListener('change', function () {
                const findButton = document.querySelector('button[onclick="getRecommendations()"]') ||
                    document.querySelector('#find-universities-btn');

                if (findButton) {
                    findButton.disabled = !this.value;
                    findButton.classList.toggle('opacity-50', !this.value);
                }
            });
        }
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            profileForm.addEventListener('change', syncProfileData);
        }

        // Add event listener to skills update
        const saveSkillsBtn = document.querySelector('button[onclick="saveSkills(event)"]');
        if (saveSkillsBtn) {
            const originalSaveSkills = window.saveSkills;
            window.saveSkills = async function (e) {
                await originalSaveSkills(e);
                syncProfileData();
            };
        }
        // Настройка переключения вкладок
        setupRecommendationTabs();

        // Настройка обработчиков для форм
        setupFormListeners();

        console.log('University recommendation system initialized');
    });

    // Настройка слушателей для форм и полей ввода
    function setupFormListeners() {
        // Слушаем изменения в форме академического портфолио
        const academicForm = document.getElementById('academicPortfolioForm');
        if (academicForm) {
            // Обработчик для полей ввода
            const inputs = academicForm.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('change', function () {
                    // Обновляем сайдбар при изменении полей
                    const profileData = collectProfileData();
                    updateRecommendationSidebar(profileData);
                });
            });

            // Обработчик отправки формы
            academicForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Собираем данные формы
                const formData = new FormData(academicForm);
                const jsonData = {};

                // Преобразуем данные формы в JSON
                for (const [key, value] of formData.entries()) {
                    jsonData[key] = value;
                }

                // Добавляем языки и достижения
                jsonData.languages = collectLanguages();
                jsonData.achievements = collectAchievements();

                // Отправляем данные на сервер
                fetch('/update_academic_portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(jsonData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {


                            // Обновляем сайдбар рекомендаций
                            const profileData = collectProfileData();
                            updateRecommendationSidebar(profileData);
                        } else {
                            throw new Error(data.error || 'Error updating portfolio');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Something went wrong', 'error');
                    });
            });
        }

        // Слушаем изменения в основной форме профиля
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            // Обработчик для полей ввода
            const inputs = profileForm.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', function () {
                    // Обновляем сайдбар при изменении полей
                    const profileData = collectProfileData();
                    updateRecommendationSidebar(profileData);
                });
            });
        }

        // Обработчик для добавления языка
        const addLanguageBtn = document.getElementById('addLanguageBtn');
        if (addLanguageBtn) {
            addLanguageBtn.addEventListener('click', function () {
                const languagesContainer = document.getElementById('languagesContainer');
                if (!languagesContainer) return;

                // Создаем новую строку для языка
                const languageRow = document.createElement('div');
                languageRow.className = 'flex gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
                languageRow.innerHTML = `
        <input type="text" name="language_name" placeholder="Language"
            class="input input-bordered flex-1 bg-white focus:ring-2 focus:ring-black transition-all">
        <select name="language_level"
            class="select select-bordered bg-white focus:ring-2 focus:ring-black transition-all">
            <option value="A1">A1 - Beginner</option>
            <option value="A2">A2 - Elementary</option>
            <option value="B1">B1 - Intermediate</option>
            <option value="B2">B2 - Upper Intermediate</option>
            <option value="C1">C1 - Advanced</option>
            <option value="C2">C2 - Mastery</option>
        </select>
        <button type="button"
            class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        </button>
      `;

                // Добавляем обработчик для кнопки удаления
                const removeBtn = languageRow.querySelector('button');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function () {
                        languageRow.remove();
                    });
                }

                // Добавляем строку в контейнер
                languagesContainer.appendChild(languageRow);
            });
        }

        // Обработчик для добавления достижения
        const addAchievementBtn = document.getElementById('addAchievementBtn');
        if (addAchievementBtn) {
            addAchievementBtn.addEventListener('click', function () {
                const achievementsContainer = document.getElementById('achievementsContainer');
                if (!achievementsContainer) return;

                // Создаем новую строку для достижения
                const achievementRow = document.createElement('div');
                achievementRow.className = 'p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
                achievementRow.innerHTML = `
        <div class="space-y-4">
            <input type="text" name="achievement_title" placeholder="Achievement Title"
                class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
            <textarea name="achievement_description" placeholder="Description"
                class="textarea textarea-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all min-h-[100px]"></textarea>
            <div class="flex items-center justify-between">
                <input type="date" name="achievement_date"
                    class="input input-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                <button type="button"
                    class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </div>
      `;

                // Добавляем обработчик для кнопки удаления
                const removeBtn = achievementRow.querySelector('button');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function () {
                        achievementRow.remove();
                    });
                }

                // Добавляем строку в контейнер
                achievementsContainer.appendChild(achievementRow);
            });
        }
    }

    // Замена глобальных функций для использования обновленных версий
    window.getRecommendations = getUniversityRecommendations;
    window.showUniversityRecommendations = showUniversityRecommendations;
    window.closeUniversityRecommendations = closeUniversityRecommendations;
    // Извлечение университетов из текста рекомендаций
    function extractUniversities(text) {
        if (!text) return [];

        const universities = [];
        const lines = text.split('\n');

        for (const line of lines) {
            if (line.includes('**University:')) {
                const match = line.match(/\*\*University:?\s*(.*?)\*\*/);
                if (match && match[1]) {
                    universities.push(match[1].trim());
                }
            }
        }

        return universities;
    }

    // Переключение между рекомендациями и избранным
    function switchToRecommendationsTab() {
        const recommendationsTabBtn = document.getElementById('recommendationsTabBtn');
        const favoritesTabBtn = document.getElementById('favoritesTabBtn');

        if (recommendationsTabBtn && favoritesTabBtn) {
            recommendationsTabBtn.className = 'px-4 py-2 font-medium text-black border-b-2 border-black';
            favoritesTabBtn.className = 'px-4 py-2 font-medium text-gray-500 hover:text-black';

            // Если есть текущие рекомендации - отобразим их, иначе запросим новые
            if (document.querySelector('#recommendationsList .bg-white')) {
                showRecommendationsContainer();
            } else {
                getUniversityRecommendations();
            }
        }
    }

    function switchToFavoritesTab() {
        const recommendationsTabBtn = document.getElementById('recommendationsTabBtn');
        const favoritesTabBtn = document.getElementById('favoritesTabBtn');

        if (recommendationsTabBtn && favoritesTabBtn) {
            favoritesTabBtn.className = 'px-4 py-2 font-medium text-black border-b-2 border-black';
            recommendationsTabBtn.className = 'px-4 py-2 font-medium text-gray-500 hover:text-black';

            showSavedUniversities();
        }
    }

    // Переключение отображения различных контейнеров
    function showRecommendationsContainer() {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const recommendationsContainer = document.getElementById('recommendationsContainer');

        if (loadingState) loadingState.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';
        if (recommendationsContainer) recommendationsContainer.style.display = 'block';
    }

    function showLoadingState() {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const recommendationsContainer = document.getElementById('recommendationsContainer');

        if (loadingState) loadingState.style.display = 'block';
        if (emptyState) emptyState.style.display = 'none';
        if (recommendationsContainer) recommendationsContainer.style.display = 'none';
    }

    function showEmptyState() {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const recommendationsContainer = document.getElementById('recommendationsContainer');

        if (loadingState) loadingState.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
        if (recommendationsContainer) recommendationsContainer.style.display = 'none';
    }

    // Управление анимацией профиля в сайдбаре
    function toggleProfileSection() {
        const profileSection = document.getElementById('profileOverview');
        const profileToggle = document.getElementById('profileToggleIcon');

        if (profileSection && profileToggle) {
            const isVisible = profileSection.style.display !== 'none';
            profileSection.style.display = isVisible ? 'none' : 'block';
            profileToggle.classList.toggle('rotate-180', isVisible);
        }
    }

    // Добавляем обработчик для переключения раздела профиля
    document.addEventListener('DOMContentLoaded', function () {
        const profileHeader = document.getElementById('profileHeader');
        if (profileHeader) {
            profileHeader.addEventListener('click', toggleProfileSection);
        }

        // Инициализация вкладок рекомендаций, если они существуют
        const recommendationsTabBtn = document.getElementById('recommendationsTabBtn');
        const favoritesTabBtn = document.getElementById('favoritesTabBtn');

        if (recommendationsTabBtn) {
            recommendationsTabBtn.addEventListener('click', switchToRecommendationsTab);
        }

        if (favoritesTabBtn) {
            favoritesTabBtn.addEventListener('click', switchToFavoritesTab);
        }

        // Автоматическое обновление сайдбара при изменении данных формы
        const allForms = document.querySelectorAll('form');
        allForms.forEach(form => {
            form.addEventListener('input', function (e) {
                if (isRecommendationsSidebarVisible()) {
                    const profileData = collectProfileData();
                    updateRecommendationSidebar(profileData);
                }
            });
        });
    });

    // Проверка видимости сайдбара рекомендаций
    function isRecommendationsSidebarVisible() {
        const sidebar = document.getElementById('universityRecommendationsModal');
        return sidebar && !sidebar.classList.contains('translate-x-full');
    }

    // Обработка ошибок API
    function handleApiError(error, container, retryCallback) {
        console.error('API Error:', error);

        if (!container) return;

        container.innerHTML = `
    <div class="bg-white rounded-lg shadow-sm p-8 text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="text-xl font-semibold mb-2">Error</h3>
      <p class="text-gray-600 mb-4">${error.message || 'Something went wrong'}</p>
      <button id="errorRetryButton" class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800 transition-colors">
        Try Again
      </button>
    </div>
  `;

        const retryButton = container.querySelector('#errorRetryButton');
        if (retryButton && typeof retryCallback === 'function') {
            retryButton.addEventListener('click', retryCallback);
        }
    }

    // Обновление кнопки поиска университетов
    function updateFindButton() {
        const countrySelect = document.getElementById('countrySelect');
        const findButton = document.querySelector('button[onclick="getRecommendations()"]') ||
            document.querySelector('.ripple') ||
            document.querySelector('button:contains("Find Universities")');

        if (countrySelect && findButton) {
            // Enable the button if a country is selected
            const isDisabled = !countrySelect.value;
            findButton.disabled = isDisabled;

            // Update classes for visual feedback
            if (isDisabled) {
                findButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                findButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    }


    // Проверка наличия данных профиля и предложение заполнить недостающие данные
    function checkProfileCompleteness() {
        const profileData = collectProfileData();

        // Проверяем наличие необходимых академических данных
        const missingAcademic = [];

        if (!profileData.academic.gpa) missingAcademic.push('GPA');
        if (!profileData.academic.toeflScore && !profileData.academic.ieltsScore)
            missingAcademic.push('Language test score (TOEFL or IELTS)');

        // Проверяем наличие других важных данных
        const missingOther = [];

        if (!profileData.personal.specialty) missingOther.push('Specialty');
        if (!profileData.personal.goals) missingOther.push('Goals');
        if (!profileData.personal.skills || profileData.personal.skills.length === 0)
            missingOther.push('Skills');

        // Если данных недостаточно, показываем предупреждение
        if (missingAcademic.length > 0 || missingOther.length > 0) {
            let message = 'For better recommendations, please complete your profile:';

            if (missingAcademic.length > 0) {
                message += `\n• Academic info: ${missingAcademic.join(', ')}`;
            }

            if (missingOther.length > 0) {
                message += `\n• Other info: ${missingOther.join(', ')}`;
            }

            showRecommendationNotice(message);
            return false;
        }

        return true;
    }

    // Показать уведомление в контейнере рекомендаций
    function showRecommendationNotice(message) {
        const recommendationsList = document.getElementById('recommendationsList');
        if (!recommendationsList) return;

        const notice = document.createElement('div');
        notice.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4';
        notice.innerHTML = `
    <div class="flex">
      <div class="flex-shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm text-yellow-700 whitespace-pre-line">${message}</p>
      </div>
    </div>
  `;

        recommendationsList.insertBefore(notice, recommendationsList.firstChild);
    }

    // Генерация рандомных шансов поступления для тестовых целей
    function generateRandomAdmissionChances(universities) {
        const eliteUniversities = [
            'Harvard', 'Stanford', 'MIT', 'Oxford', 'Cambridge', 'Princeton',
            'Yale', 'Columbia', 'Caltech', 'Chicago', 'Imperial College'
        ];

        const prestigiousUniversities = [
            'UCLA', 'Berkeley', 'NYU', 'Michigan', 'Toronto', 'LSE',
            'Edinburgh', 'UCL', 'Sydney', 'Melbourne', 'ETH Zurich'
        ];

        const chances = {};

        universities.forEach(uni => {
            if (eliteUniversities.some(elite => uni.includes(elite))) {
                // Элитные университеты - низкие шансы
                chances[uni] = Math.floor(Math.random() * 15) + 25; // 25-40%
            } else if (prestigiousUniversities.some(prestige => uni.includes(prestige))) {
                // Престижные университеты - средние шансы
                chances[uni] = Math.floor(Math.random() * 20) + 40; // 40-60%
            } else {
                // Другие университеты - высокие шансы
                chances[uni] = Math.floor(Math.random() * 25) + 60; // 60-85%
            }
        });

        return chances;
    }

    // Add fallback mechanism if server doesn't return admission chances
    function ensureAdmissionChances(data) {
        if (!data.admission_chances || Object.keys(data.admission_chances).length === 0) {
            console.log('Server did not provide admission chances, generating fallbacks');
            data.admission_chances = generateRandomAdmissionChances(data.universities || []);
        }
        return data;
    }

    // This will run once the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function () {
        console.log('University recommendations module fully loaded');

        // Attach any remaining event listeners
        const profileToggle = document.getElementById('profileToggleIcon');
        if (profileToggle) {
            profileToggle.parentElement.addEventListener('click', toggleProfileSection);
        }

        // Initialize country select change event
        const countrySelect = document.getElementById('countrySelect');
        if (countrySelect) {
            countrySelect.addEventListener('change', updateFindButton);
            // Set initial state
            updateFindButton();
        }

        // Override global functions if they exist
        if (window.getRecommendations) {
            window.getRecommendations = getUniversityRecommendations;
        }

        if (window.showUniversityRecommendations) {
            window.showUniversityRecommendations = showUniversityRecommendations;
        }

        if (window.closeUniversityRecommendations) {
            window.closeUniversityRecommendations = closeUniversityRecommendations;
        }
    });
    const academicPortfolioHandler = {
        init: function () {
            this.setupFormListeners();
            this.setupLanguageManagement();
            this.setupAchievementManagement(); // This line is causing the error
        },
        // Make this part of the academicPortfolioHandler object
        setupAchievementManagement: function () {
            const addAchievementBtn = document.getElementById('addAchievementBtn');
            const achievementsContainer = document.getElementById('achievementsContainer');

            if (addAchievementBtn && achievementsContainer) {
                addAchievementBtn.addEventListener('click', () => {
                    const newAchievementRow = this.createAchievementRow();
                    achievementsContainer.appendChild(newAchievementRow);
                });

                achievementsContainer.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
            }
        },
        createAchievementRow: function () {
            const row = document.createElement('div');
            row.className = 'p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200';
            row.innerHTML = `
            <div class="space-y-4">
                <input type="text" name="achievement_title" placeholder="Achievement Title"
                    class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all">
                <textarea name="achievement_description" placeholder="Description"
                    class="textarea textarea-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all min-h-[100px]"></textarea>
                <div class="flex items-center justify-between">
                    <input type="date" name="achievement_date"
                        class="input input-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                    <button type="button"
                        class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        `;

            // Add click handler for remove button
            row.querySelector('button').addEventListener('click', () => row.remove());
            return row;
        },
    };
    // Add this right after the document is loaded
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize skills array from the DOM
        const skillsContainer = document.getElementById('skillsContainer');
        if (skillsContainer) {
            // Get skills from the UI
            window.currentSkills = Array.from(skillsContainer.querySelectorAll('span'))
                .map(span => span.textContent.trim());
        }

        console.log("Initialized skills:", window.currentSkills);

        // Call this immediately to update the sidebar if it's visible
        if (isRecommendationsSidebarVisible()) {
            const profileData = collectProfileData();
            updateRecommendationSidebar(profileData);
        }
    });
</script>



{% endblock %}